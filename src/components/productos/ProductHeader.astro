---
const { searchPlaceholder = "Buscar productos..." } = Astro.props;
---

<header
  class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-border-light dark:border-border-dark"
>
  <div class="container mx-auto px-4">
    <div class="flex h-20 items-center justify-between">
      <div class="flex items-center gap-8">
        <a
          class="flex items-center gap-2 text-text-light dark:text-text-dark"
          href="/"
        >
          <img
            alt="GMExpress Logo"
            class="h-10 w-auto brightness-0 invert dark:brightness-0 dark:invert"
            src="/images/Logo-horizontal.png"
          />
        </a>
        <nav class="hidden md:flex items-center gap-6">
          <a class="text-sm font-medium hover:text-primary" href="/#nosotros"
            >Nosotros</a
          >
          <a class="text-sm font-medium hover:text-primary" href="/servicios"
            >Servicios</a
          >
          <a class="text-sm font-medium hover:text-primary" href="/productos"
            >Productos</a
          >
          <a class="text-sm font-medium hover:text-primary" href="/">Inicio</a>
        </nav>
      </div>
      <div class="flex flex-1 justify-end gap-3 items-center">
        <div class="hidden sm:flex relative max-w-xs w-full">
          <span
            class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-light/60 dark:text-text-dark/60"
            >search</span
          >
          <input
            id="search-input"
            class="w-full rounded-full border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark h-10 pl-10 pr-4 placeholder:text-text-light/60 dark:placeholder:text-text-dark/60 focus:ring-2 focus:ring-primary focus:border-primary text-sm"
            placeholder={searchPlaceholder}
            type="search"
          />
        </div>
        <button
          data-cart-toggle
          class="flex h-10 w-10 shrink-0 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-card-light dark:bg-card-dark hover:bg-gray-200 dark:hover:bg-gray-700 border border-border-light dark:border-border-dark"
        >
          <span
            class="material-symbols-outlined text-text-light dark:text-text-dark"
            >shopping_cart</span
          >
        </button>
        <!-- User Dropdown -->
        <div class="relative">
          <button
            id="user-dropdown-toggle"
            class="flex h-10 w-10 shrink-0 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-card-light dark:bg-card-dark hover:bg-gray-200 dark:hover:bg-gray-700 border border-border-light dark:border-border-dark"
          >
            <span
              class="material-symbols-outlined text-text-light dark:text-text-dark"
              >person</span
            >
          </button>
          <!-- Dropdown Menu -->
          <div
            id="user-dropdown-menu"
            class="hidden absolute right-0 mt-2 w-72 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-border-light dark:border-border-dark z-50 overflow-hidden"
          >
            <!-- Usuario no autenticado -->
            <div id="user-guest" class="p-4">
              <div class="text-center py-4">
                <span class="material-symbols-outlined text-5xl text-gray-400"
                  >account_circle</span
                >
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                  No has iniciado sesión
                </p>
                <div class="mt-3 flex flex-col gap-2">
                  <button
                    id="open-login-modal"
                    class="w-full py-2 px-4 bg-primary text-white rounded-lg hover:bg-primary-dark transition text-sm font-medium text-center cursor-pointer"
                  >
                    Iniciar Sesión
                  </button>
                  <a
                    href="/registro"
                    class="w-full py-2 px-4 bg-transparent border border-primary text-primary rounded-lg hover:bg-primary/10 transition text-sm font-medium text-center"
                  >
                    Registrarse
                  </a>
                </div>
              </div>
            </div>
            <!-- Usuario autenticado -->
            <div id="user-authenticated" class="hidden">
              <div
                class="p-4 bg-gradient-to-r from-primary/10 to-primary/5 border-b border-border-light dark:border-border-dark"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white font-bold text-lg"
                    id="user-avatar"
                  >
                    ?
                  </div>
                  <div class="flex-1 min-w-0">
                    <p
                      class="font-semibold text-text-light dark:text-text-dark truncate"
                      id="user-name"
                    >
                      Usuario
                    </p>
                    <p
                      class="text-xs text-gray-500 dark:text-gray-400 truncate"
                      id="user-email"
                    >
                      email@ejemplo.com
                    </p>
                  </div>
                </div>
              </div>
              <div class="p-3 space-y-1">
                <div
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 dark:text-gray-400"
                >
                  <span class="material-symbols-outlined text-base">phone</span>
                  <span id="user-phone">-</span>
                </div>
                <div
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 dark:text-gray-400"
                >
                  <span class="material-symbols-outlined text-base"
                    >location_on</span
                  >
                  <span id="user-address" class="truncate">-</span>
                </div>
              </div>
              <div
                class="border-t border-border-light dark:border-border-dark p-3"
              >
                <button
                  id="logout-btn"
                  class="w-full flex items-center justify-center gap-2 py-2 px-4 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition text-sm font-medium"
                >
                  <span class="material-symbols-outlined text-base">logout</span
                  >
                  Cerrar Sesión
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Modal de Login -->
<div
  id="login-modal"
  class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/50 backdrop-blur-sm"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-text-light dark:text-text-dark">
          Iniciar Sesión
        </h2>
        <button
          id="close-login-modal"
          class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form id="header-login-form" class="space-y-4">
        <div>
          <label
            class="block text-sm font-medium text-text-light dark:text-text-dark mb-1"
          >
            Correo Electrónico
          </label>
          <input
            type="email"
            id="header-login-email"
            required
            class="w-full h-10 px-3 rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark"
            placeholder="correo@ejemplo.com"
          />
        </div>
        <div>
          <label
            class="block text-sm font-medium text-text-light dark:text-text-dark mb-1"
          >
            Contraseña
          </label>
          <input
            type="password"
            id="header-login-password"
            required
            class="w-full h-10 px-3 rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark"
            placeholder="••••••••"
          />
        </div>
        <div id="header-login-error" class="hidden text-red-500 text-sm"></div>
        <button
          type="submit"
          class="w-full h-10 bg-primary text-white rounded-lg font-bold hover:bg-primary/90 transition-colors"
        >
          Iniciar Sesión
        </button>
      </form>

      <div class="mt-4 text-center">
        <p class="text-sm text-text-light/60 dark:text-text-dark/60">
          ¿No tienes cuenta?
          <a href="/registro" class="text-primary hover:underline font-medium"
            >Regístrate aquí</a
          >
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  import { auth, db } from "../../firebase/client";
  import {
    onAuthStateChanged,
    signOut,
    signInWithEmailAndPassword,
  } from "firebase/auth";
  import { doc, getDoc } from "firebase/firestore";

  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("search-input");
    const userDropdownToggle = document.getElementById("user-dropdown-toggle");
    const userDropdownMenu = document.getElementById("user-dropdown-menu");
    const userGuest = document.getElementById("user-guest");
    const userAuthenticated = document.getElementById("user-authenticated");
    const userAvatar = document.getElementById("user-avatar");
    const userName = document.getElementById("user-name");
    const userEmail = document.getElementById("user-email");
    const userPhone = document.getElementById("user-phone");
    const userAddress = document.getElementById("user-address");
    const logoutBtn = document.getElementById("logout-btn");

    // Modal de login
    const loginModal = document.getElementById("login-modal");
    const openLoginModalBtn = document.getElementById("open-login-modal");
    const closeLoginModalBtn = document.getElementById("close-login-modal");
    const headerLoginForm = document.getElementById("header-login-form");

    // Abrir modal de login
    if (openLoginModalBtn && loginModal) {
      openLoginModalBtn.addEventListener("click", () => {
        if (userDropdownMenu) userDropdownMenu.classList.add("hidden");
        loginModal.classList.remove("hidden");
        loginModal.classList.add("flex");
      });
    }

    // Cerrar modal de login
    if (closeLoginModalBtn && loginModal) {
      closeLoginModalBtn.addEventListener("click", () => {
        loginModal.classList.add("hidden");
        loginModal.classList.remove("flex");
      });
    }

    // Cerrar modal al hacer clic fuera
    if (loginModal) {
      loginModal.addEventListener("click", (e) => {
        if (e.target === loginModal) {
          loginModal.classList.add("hidden");
          loginModal.classList.remove("flex");
        }
      });
    }

    // Manejar login desde el modal
    if (headerLoginForm) {
      headerLoginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = (
          document.getElementById("header-login-email") as HTMLInputElement
        )?.value;
        const password = (
          document.getElementById("header-login-password") as HTMLInputElement
        )?.value;
        const errorDiv = document.getElementById("header-login-error");

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // Cerrar modal al loguearse exitosamente
          if (loginModal) {
            loginModal.classList.add("hidden");
            loginModal.classList.remove("flex");
          }
        } catch {
          if (errorDiv) {
            errorDiv.textContent =
              "Credenciales incorrectas. Intenta de nuevo.";
            errorDiv.classList.remove("hidden");
          }
        }
      });
    }

    // Toggle dropdown
    if (userDropdownToggle && userDropdownMenu) {
      userDropdownToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdownMenu.classList.toggle("hidden");
      });

      // Cerrar al hacer clic fuera
      document.addEventListener("click", (e) => {
        if (
          !userDropdownMenu.contains(e.target as Node) &&
          e.target !== userDropdownToggle
        ) {
          userDropdownMenu.classList.add("hidden");
        }
      });
    }

    // Manejar autenticación
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Usuario autenticado
        if (userGuest) userGuest.classList.add("hidden");
        if (userAuthenticated) userAuthenticated.classList.remove("hidden");

        // Obtener datos de Firestore
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            const firstName = data.firstName || data.nombre || "";
            const lastName = data.lastNamePaterno || data.apellidoPaterno || "";
            const fullName =
              `${firstName} ${lastName}`.trim() ||
              user.email?.split("@")[0] ||
              "Usuario";

            if (userName) userName.textContent = fullName;
            if (userEmail) userEmail.textContent = user.email || "";
            if (userAvatar)
              userAvatar.textContent = firstName.charAt(0).toUpperCase() || "U";
            if (userPhone)
              userPhone.textContent = data.phone || data.telefono || "-";
            if (userAddress) {
              const address = [data.address, data.comuna, data.region]
                .filter(Boolean)
                .join(", ");
              userAddress.textContent = address || "-";
            }
          } else {
            // No hay doc en Firestore, usar datos de Auth
            if (userName)
              userName.textContent =
                user.displayName || user.email?.split("@")[0] || "Usuario";
            if (userEmail) userEmail.textContent = user.email || "";
            if (userAvatar)
              userAvatar.textContent = (user.displayName || user.email || "U")
                .charAt(0)
                .toUpperCase();
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
          if (userName)
            userName.textContent = user.email?.split("@")[0] || "Usuario";
          if (userEmail) userEmail.textContent = user.email || "";
        }
      } else {
        // Usuario no autenticado
        if (userGuest) userGuest.classList.remove("hidden");
        if (userAuthenticated) userAuthenticated.classList.add("hidden");
      }
    });

    // Logout
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          if (userDropdownMenu) userDropdownMenu.classList.add("hidden");
        } catch (error) {
          console.error("Error signing out:", error);
        }
      });
    }

    // Función para normalizar texto (quitar acentos)
    const normalizeText = (text: string): string => {
      return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    };

    if (searchInput) {
      searchInput.addEventListener("input", (e) => {
        const searchTerm = normalizeText((e.target as HTMLInputElement).value);

        // Buscar tanto productos como servicios
        const productCards = document.querySelectorAll("[data-product]");
        const serviceCards = document.querySelectorAll("[data-service]");
        const allCards = [...productCards, ...serviceCards];

        let visibleCount = 0;

        allCards.forEach((card) => {
          const nameElement = card.querySelector(
            "[data-product-name], [data-service-name]",
          );
          const name = normalizeText(nameElement?.textContent || "");

          if (searchTerm === "" || name.includes(searchTerm)) {
            (card as HTMLElement).style.display = "";
            visibleCount++;
          } else {
            (card as HTMLElement).style.display = "none";
          }
        });

        // Mostrar mensaje si no hay resultados
        let noResultsMsg = document.getElementById("no-results-message");
        const gridContainer = document.querySelector(".grid");

        if (visibleCount === 0 && searchTerm !== "") {
          if (!noResultsMsg && gridContainer) {
            noResultsMsg = document.createElement("div");
            noResultsMsg.id = "no-results-message";
            noResultsMsg.className = "col-span-full text-center py-12";
            noResultsMsg.innerHTML = `
              <span class="material-symbols-outlined text-6xl text-text-light/30 dark:text-text-dark/30">search_off</span>
              <p class="mt-4 text-text-light/60 dark:text-text-dark/60">No se encontraron resultados para "${(e.target as HTMLInputElement).value}"</p>
            `;
            gridContainer.appendChild(noResultsMsg);
          }
        } else if (noResultsMsg) {
          noResultsMsg.remove();
        }
      });
    }
  });
</script>
