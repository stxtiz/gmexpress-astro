<header
  class="fixed top-0 left-0 right-0 z-50 bg-white/80 dark:bg-secondary/80 backdrop-blur-sm w-full"
>
  <div
    class="flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 dark:border-slate-800 px-4 sm:px-10 py-3 max-w-7xl mx-auto"
  >
    <div class="flex items-center gap-2 text-text-light dark:text-text-dark">
      <img
        alt="GMExpress Logo"
        class="h-12 w-auto dark:brightness-0 dark:invert"
        src="/images/Logo-horizontal.png"
      />
    </div>
    <nav class="hidden md:flex items-center gap-6 flex-1 justify-center">
      <a
        class="text-sm font-medium text-secondary hover:text-primary dark:text-white dark:hover:text-primary transition-colors"
        href="#nosotros"
      >
        Nosotros
      </a>
      <a
        class="text-sm font-medium text-secondary hover:text-primary dark:text-white dark:hover:text-primary transition-colors"
        href="#contacto"
      >
        Contacto
      </a>
      <div class="relative group">
        <button
          class="text-sm font-medium text-secondary hover:text-primary dark:text-white dark:hover:text-primary transition-colors flex items-center gap-1"
        >
          Catálogo
          <span class="material-symbols-outlined text-xs opacity-60"
            >expand_more</span
          >
        </button>
        <div
          class="absolute top-full left-0 mt-2 w-48 bg-white dark:bg-secondary rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
        >
          <a
            href="/productos"
            class="block px-4 py-3 text-sm text-secondary dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 first:rounded-t-lg transition-colors"
          >
            Productos
          </a>
          <a
            href="/servicios"
            class="block px-4 py-3 text-sm text-secondary dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 last:rounded-b-lg transition-colors"
          >
            Servicios
          </a>
        </div>
      </div>
    </nav>
    <div class="hidden md:flex items-center gap-3">
      <!-- Guest Menu -->
      <div id="guest-menu" class="hidden items-center gap-3">
        <button
          id="loginBtn"
          class="flex min-w-[110px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 border border-primary text-primary text-sm font-bold tracking-wide hover:bg-primary/10 transition-colors"
        >
          Iniciar Sesión
        </button>
        <a
          class="flex min-w-[110px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-primary text-white text-sm font-bold tracking-wide hover:bg-primary/90 transition-colors"
          href="/registro"
        >
          Registrarse
        </a>
      </div>

      <!-- User Menu -->
      <div id="user-menu" class="hidden items-center gap-3">
        <span
          id="user-name"
          class="text-sm font-medium text-secondary dark:text-white"></span>
        <button
          id="logoutBtn"
          class="flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 border border-red-500 text-red-500 text-sm font-bold tracking-wide hover:bg-red-50 transition-colors"
        >
          Cerrar Sesión
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Modal de Login -->
<div
  id="loginModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-100 hidden items-center justify-center p-4"
>
  <div
    class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 max-w-md w-full p-8 relative animate-fade-in"
  >
    <button
      id="closeModal"
      class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors"
    >
      <span class="material-symbols-outlined">close</span>
    </button>

    <div class="flex flex-col gap-6">
      <div class="flex flex-col gap-2 text-center">
        <h2 class="text-3xl font-bold text-secondary dark:text-text-dark">
          Iniciar Sesión
        </h2>
        <p class="text-sm text-slate-600 dark:text-slate-400">
          Ingresa tus credenciales para acceder
        </p>
      </div>

      <form id="loginForm" class="flex flex-col gap-4">
        <!-- Email -->
        <div class="flex flex-col gap-2">
          <label
            for="loginEmail"
            class="text-sm font-medium text-secondary dark:text-text-dark"
          >
            Correo Electrónico
          </label>
          <input
            type="email"
            id="loginEmail"
            name="loginEmail"
            required
            placeholder="correo@ejemplo.com"
            class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          />
        </div>

        <!-- Contraseña -->
        <div class="flex flex-col gap-2">
          <label
            for="loginPassword"
            class="text-sm font-medium text-secondary dark:text-text-dark"
          >
            Contraseña
          </label>
          <input
            type="password"
            id="loginPassword"
            name="loginPassword"
            required
            placeholder="Tu contraseña"
            class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          />
        </div>

        <!-- Recordarme y Olvidé mi contraseña -->
        <div class="flex items-center justify-between">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              id="rememberMe"
              name="rememberMe"
              class="h-4 w-4 rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary focus:ring-2 cursor-pointer"
            />
            <span class="text-sm text-slate-600 dark:text-slate-400">
              Recordarme
            </span>
          </label>
          <a href="#" class="text-sm text-primary hover:underline font-medium">
            ¿Olvidaste tu contraseña?
          </a>
        </div>

        <!-- Botón de Login -->
        <button
          type="submit"
          class="flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-all hover:shadow-lg mt-2"
        >
          <span class="material-symbols-outlined mr-2">login</span>
          <span class="truncate">Iniciar Sesión</span>
        </button>

        <!-- Divider -->
        <div class="relative my-2">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-slate-200 dark:border-slate-800">
            </div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span
              class="px-2 bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400"
            >
              o
            </span>
          </div>
        </div>

        <!-- Registro -->
        <div class="text-center">
          <p class="text-sm text-slate-600 dark:text-slate-400">
            ¿No tienes una cuenta?
            <a
              href="/registro"
              class="text-primary hover:underline font-medium ml-1"
            >
              Regístrate aquí
            </a>
          </p>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>

<script>
  import { auth, db } from "../firebase/client";
  import {
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
  } from "firebase/auth";
  import { doc, getDoc } from "firebase/firestore";

  const loginBtn = document.getElementById("loginBtn");
  const loginModal = document.getElementById("loginModal");
  const closeModal = document.getElementById("closeModal");
  const loginForm = document.getElementById("loginForm");
  const guestMenu = document.getElementById("guest-menu");
  const userMenu = document.getElementById("user-menu");
  const userNameDisplay = document.getElementById("user-name");
  const logoutBtn = document.getElementById("logoutBtn");

  // Auth State Observer
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User is signed in
      guestMenu?.classList.add("hidden");
      guestMenu?.classList.remove("flex");
      userMenu?.classList.remove("hidden");
      userMenu?.classList.add("flex");
      if (userNameDisplay)
        userNameDisplay.textContent = `Hola, ${user.displayName || "Usuario"}`;
    } else {
      // User is signed out
      guestMenu?.classList.remove("hidden");
      guestMenu?.classList.add("flex");
      userMenu?.classList.add("hidden");
      userMenu?.classList.remove("flex");
    }
  });

  // Logout
  logoutBtn?.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "/";
    } catch (error) {
      console.error("Error signing out:", error);
    }
  });

  // Abrir modal
  loginBtn?.addEventListener("click", () => {
    loginModal?.classList.remove("hidden");
    loginModal?.classList.add("flex");
    document.body.style.overflow = "hidden";
  });

  // Cerrar modal
  const closeLoginModal = () => {
    loginModal?.classList.add("hidden");
    loginModal?.classList.remove("flex");
    document.body.style.overflow = "auto";
  };

  closeModal?.addEventListener("click", closeLoginModal);

  // Cerrar al hacer click fuera del modal
  loginModal?.addEventListener("click", (e) => {
    if (e.target === loginModal) {
      closeLoginModal();
    }
  });

  // Cerrar con la tecla ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !loginModal?.classList.contains("hidden")) {
      closeLoginModal();
    }
  });

  // Manejar el submit del formulario (Login)
  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = (document.getElementById("loginEmail") as HTMLInputElement)
      .value;
    const password = (
      document.getElementById("loginPassword") as HTMLInputElement
    ).value;

    try {
      const userCredential = await signInWithEmailAndPassword(
        auth,
        email,
        password,
      );
      const user = userCredential.user;

      // Check for admin role
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists() && userDoc.data().role === "admin") {
        window.location.href = "/admin";
      } else {
        closeLoginModal();
      }
    } catch (error) {
      console.error("Error logging in:", error);
      const err = error as Error & { code?: string };
      let errorMsg = "Error en Login: Credenciales incorrectas. Verifica tu email y contraseña.";
      if (err.code === "auth/user-not-found") {
        errorMsg = "Error en Login: No existe una cuenta con este correo electrónico.";
      } else if (err.code === "auth/wrong-password") {
        errorMsg = "Error en Login: Contraseña incorrecta.";
      } else if (err.code === "auth/too-many-requests") {
        errorMsg = "Error en Login: Demasiados intentos fallidos. Intenta más tarde.";
      } else if (err.code === "auth/invalid-email") {
        errorMsg = "Error en Login: El formato del correo electrónico no es válido.";
      }
      showLoginToast(errorMsg, "danger");
    }
  });

  // ============================================
  // FUNCIÓN: Mostrar toast para mensajes de login
  // Reemplaza alert() nativo por UI personalizada
  // ============================================
  function showLoginToast(
    message: string,
    type: "success" | "danger" | "warning" | "info" = "info"
  ): void {
    const config = {
      success: {
        icon: `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        bgColor: "bg-green-50",
        borderColor: "border-green-400",
        textColor: "text-green-800"
      },
      danger: {
        icon: `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        bgColor: "bg-red-50",
        borderColor: "border-red-400",
        textColor: "text-red-800"
      },
      warning: {
        icon: `<svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
        bgColor: "bg-amber-50",
        borderColor: "border-amber-400",
        textColor: "text-amber-800"
      },
      info: {
        icon: `<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        bgColor: "bg-blue-50",
        borderColor: "border-blue-400",
        textColor: "text-blue-800"
      }
    };

    const { icon, bgColor, borderColor, textColor } = config[type];

    // Crear contenedor si no existe
    let toastContainer = document.getElementById("login-toast-container");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = "login-toast-container";
      toastContainer.style.cssText = "position:fixed;top:1rem;right:1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem;";
      document.body.appendChild(toastContainer);
    }

    // Crear toast
    const toastId = `toast-${Date.now()}`;
    const toast = document.createElement("div");
    toast.id = toastId;
    toast.className = `${bgColor} ${borderColor} border-l-4 rounded-lg shadow-lg p-4 max-w-sm`;
    toast.style.cssText = "animation:slideInRight 0.3s ease-out;";
    toast.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0">${icon}</div>
        <div class="flex-1">
          <p class="${textColor} text-sm font-medium">${message}</p>
        </div>
        <button onclick="this.closest('div[id^=toast]').remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    `;

    toastContainer.appendChild(toast);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
      toast.style.animation = "slideOutRight 0.3s ease-in forwards";
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  // Agregar keyframes si no existen
  if (!document.getElementById("login-toast-styles")) {
    const style = document.createElement("style");
    style.id = "login-toast-styles";
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
</script>
