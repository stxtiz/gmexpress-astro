---
interface Props {
  title: string;
}

const { title } = Astro.props;
---

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
  <div class="container-fluid">
    <h4 class="mb-0 text-dark fw-bold">{title}</h4>

    <div class="d-flex align-items-center gap-3">
      <!-- Notifications Dropdown -->
      <div class="dropdown">
        <button
          class="btn btn-link text-dark position-relative"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          id="notificationBtn"
        >
          <i class="bi bi-bell fs-5"></i>
          <span
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none"
            id="notificationBadge"
          >
            0
          </span>
        </button>

        <ul
          class="dropdown-menu dropdown-menu-end p-0 shadow border-0"
          style="width: 320px; max-height: 400px; overflow-y: auto;"
          id="notificationList"
        >
          <li class="p-3 border-bottom bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0 fw-bold">Notificaciones</h6>
              <small
                class="text-muted cursor-pointer"
                onclick="markAllAsRead()"
              >
                Marcar leídas
              </small>
            </div>
          </li>

          <!-- Default message -->
          <li class="text-center p-4 text-muted">
            <small>No tienes notificaciones nuevas</small>
          </li>
        </ul>
      </div>

      <!-- Perfil -->
      <div class="dropdown">
        <button
          class="btn btn-link text-dark dropdown-toggle d-flex align-items-center gap-2"
          type="button"
          data-bs-toggle="dropdown"
        >
          <div
            class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
            style="width: 40px; height: 40px;"
            id="admin-avatar"
          >
            <i class="bi bi-person-fill"></i>
          </div>
          <span class="fw-semibold" id="admin-name">Admin</span>
        </button>

        <ul
          class="dropdown-menu dropdown-menu-end shadow"
          style="min-width: 280px;"
        >
          <!-- Info del usuario -->
          <li class="px-3 py-2 border-bottom">
            <div class="d-flex align-items-center gap-3">
              <div
                class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                style="width: 50px; height: 50px;"
              >
                <i class="bi bi-person-fill fs-4"></i>
              </div>
              <div>
                <p class="mb-0 fw-bold" id="dropdown-user-name">Cargando...</p>
                <p class="mb-0 text-muted small" id="dropdown-user-email">
                  ...
                </p>
                <span class="badge bg-success mt-1" id="dropdown-user-role"
                  >Admin</span
                >
              </div>
            </div>
          </li>
          <!-- Info adicional -->
          <li class="px-3 py-2 border-bottom bg-light">
            <div class="row g-2 text-center">
              <div class="col-6">
                <small class="text-muted d-block">Teléfono</small>
                <small class="fw-semibold" id="dropdown-user-phone">-</small>
              </div>
              <div class="col-6">
                <small class="text-muted d-block">Último acceso</small>
                <small class="fw-semibold" id="dropdown-last-login">Hoy</small>
              </div>
            </div>
          </li>
          <li>
            <a class="dropdown-item py-2" href="/admin"
              ><i class="bi bi-speedometer2 me-2"></i>Dashboard</a
            >
          </li>
          <li>
            <a class="dropdown-item py-2" href="/admin/pedidos"
              ><i class="bi bi-cart-check me-2"></i>Pedidos</a
            >
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <a class="dropdown-item py-2 text-danger" href="#" id="logout-btn">
              <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesión
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- Script del lado del cliente -->
<script>
  // Firebase imports - deben estar dentro del script del cliente
  import { auth, db } from "../../firebase/client";
  import { signOut, onAuthStateChanged } from "firebase/auth";
  import {
    doc,
    getDoc,
    getDocs,
    collection,
    query,
    orderBy,
    limit,
    onSnapshot,
    updateDoc,
    where,
    writeBatch,
  } from "firebase/firestore";

  const adminNameElement = document.getElementById("admin-name");
  const logoutBtn = document.getElementById("logout-btn");
  const notificationBadge = document.getElementById("notificationBadge");
  const notificationList = document.getElementById("notificationList");

  // Elementos del dropdown de perfil
  const dropdownUserName = document.getElementById("dropdown-user-name");
  const dropdownUserEmail = document.getElementById("dropdown-user-email");
  const dropdownUserPhone = document.getElementById("dropdown-user-phone");
  const dropdownUserRole = document.getElementById("dropdown-user-role");
  const dropdownLastLogin = document.getElementById("dropdown-last-login");

  // LOGOUT
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        sessionStorage.removeItem("gmexpress_admin_verified");
        window.location.href = "/";
      } catch (error) {
        console.error("Error signing out:", error);
      }
    });
  }

  // USER NAME with improved error handling
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log("Auth user detected:", user.uid);
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        console.log("User document exists:", userDoc.exists());

        if (userDoc.exists()) {
          const data = userDoc.data();
          console.log("User data:", data);

          // Try multiple field name combinations
          const firstName = data.firstName || data.nombre || data.name || "";
          const lastName =
            data.lastNamePaterno ||
            data.apellidoPaterno ||
            data.lastName ||
            data.apellido ||
            "";

          const fullName = `${firstName} ${lastName}`.trim();
          console.log("Calculated full name:", fullName);

          // Actualizar nombre en header
          if (fullName && adminNameElement) {
            adminNameElement.textContent = fullName;
          } else if (user.email && adminNameElement) {
            const emailName = user.email.split("@")[0];
            adminNameElement.textContent = emailName;
          }

          // Actualizar dropdown del perfil
          if (dropdownUserName) {
            dropdownUserName.textContent =
              fullName || user.email?.split("@")[0] || "Admin";
          }
          if (dropdownUserEmail) {
            dropdownUserEmail.textContent = user.email || "";
          }
          if (dropdownUserPhone) {
            dropdownUserPhone.textContent = data.phone || data.telefono || "-";
          }
          if (dropdownUserRole) {
            const role = data.role || "user";
            dropdownUserRole.textContent =
              role === "admin" ? "Administrador" : "Usuario";
            dropdownUserRole.className = `badge mt-1 ${role === "admin" ? "bg-success" : "bg-secondary"}`;
          }
          if (dropdownLastLogin) {
            // Mostrar último login (metadata de Firebase Auth)
            const lastLogin = user.metadata.lastSignInTime;
            if (lastLogin) {
              const date = new Date(lastLogin);
              const now = new Date();
              const diffDays = Math.floor(
                (now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24),
              );

              if (diffDays === 0) {
                dropdownLastLogin.textContent = "Hoy";
              } else if (diffDays === 1) {
                dropdownLastLogin.textContent = "Ayer";
              } else {
                dropdownLastLogin.textContent =
                  date.toLocaleDateString("es-CL");
              }
            }
          }
        } else {
          console.warn("User document does not exist for UID:", user.uid);
          if (adminNameElement)
            adminNameElement.textContent = user.email?.split("@")[0] || "Admin";
          if (dropdownUserName)
            dropdownUserName.textContent = user.email?.split("@")[0] || "Admin";
          if (dropdownUserEmail)
            dropdownUserEmail.textContent = user.email || "";
        }
      } catch (error: unknown) {
        console.error("Error fetching user data:", error);
        if (error instanceof Error) {
          console.error("Error details:", error.message);
        }
        if (adminNameElement)
          adminNameElement.textContent = user.email?.split("@")[0] || "Admin";
        if (dropdownUserName)
          dropdownUserName.textContent = user.email?.split("@")[0] || "Admin";
        if (dropdownUserEmail) dropdownUserEmail.textContent = user.email || "";
      }

      subscribeToNotifications();
    }
  });

  // Notifications Listener with error handling and fallback
  function subscribeToNotifications() {
    // Try query with orderBy first
    const qWithOrder = query(
      collection(db, "notifications"),
      orderBy("createdAt", "desc"),
      limit(10),
    );

    // Attempt to subscribe with orderBy
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const unsubscribe = onSnapshot(
      qWithOrder,
      (snapshot) => {
        handleNotificationsSnapshot(snapshot);
      },
      (error) => {
        console.warn("OrderBy query failed, using fallback:", error.message);

        // Fallback: simple query without orderBy
        const qSimple = query(
          collection(db, "notifications"),
          limit(50), // Get more to sort client-side
        );

        onSnapshot(
          qSimple,
          (snapshot) => {
            handleNotificationsSnapshot(snapshot, true); // true = sort on client
          },
          (fallbackError) => {
            console.error("Notification query failed:", fallbackError);
            // Show error in UI
            const header = notificationList.firstElementChild.cloneNode(true);
            notificationList.innerHTML = "";
            notificationList.appendChild(header);
            notificationList.innerHTML += `
            <li class="text-center p-4 text-danger">
              <small>Error al cargar notificaciones</small>
            </li>
          `;
          },
        );
      },
    );
  }

  // Handle notifications snapshot with optional client-side sorting
  function handleNotificationsSnapshot(snapshot, sortOnClient = false) {
    let notifications = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));

    // Sort on client if needed
    if (sortOnClient) {
      notifications.sort((a, b) => {
        const dateA = a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });
      // Limit to 10 after sorting
      notifications = notifications.slice(0, 10);
    }

    const unread = notifications.filter((n) => !n.read).length;

    // Badge
    if (unread > 0) {
      notificationBadge.textContent = unread;
      notificationBadge.classList.remove("d-none");
    } else {
      notificationBadge.classList.add("d-none");
    }

    // Reset UL (preservar header)
    const header = notificationList.firstElementChild.cloneNode(true);
    notificationList.innerHTML = "";
    notificationList.appendChild(header);

    if (notifications.length === 0) {
      notificationList.innerHTML += `
        <li class="text-center p-4 text-muted">
          <small>No tienes notificaciones nuevas</small>
        </li>
      `;
    } else {
      notifications.forEach((notif) => {
        const li = document.createElement("li");
        li.className = "border-bottom";

        li.innerHTML = `
          <div class="dropdown-item p-3 ${notif.read ? "" : "bg-light"}" style="cursor:pointer;">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-${
                notif.type === "warning"
                  ? "exclamation-circle text-warning"
                  : "info-circle text-info"
              } mt-1"></i>

              <div class="flex-grow-1" data-notif-click="${notif.id}">
                <p class="mb-0 fw-semibold small">${notif.title}</p>
                <p class="mb-0 text-muted small">${notif.message}</p>
                <small class="text-muted" style="font-size:0.7rem;">
                  ${formatTimeAgo(notif.createdAt?.toDate())}
                </small>
              </div>

              ${
                !notif.read
                  ? `
                <button class="btn btn-sm btn-link text-muted p-0 ms-2" data-notif-mark="${notif.id}">
                  <i class="bi bi-check2"></i>
                </button>
              `
                  : ""
              }
            </div>
          </div>
        `;

        // Click en contenido
        li.querySelector(`[data-notif-click="${notif.id}"]`).onclick = () => {
          markAsRead(notif.id);
          if (notif.title.includes("Solicitud")) {
            window.location.href = "/admin/pedidos";
          }
        };

        // Marcar leído botón
        const btn = li.querySelector(`[data-notif-mark="${notif.id}"]`);
        if (btn) {
          btn.onclick = (e) => {
            e.stopPropagation();
            markAsRead(notif.id);
          };
        }

        notificationList.appendChild(li);
      });
    }
  }

  async function markAsRead(id) {
    try {
      await updateDoc(doc(db, "notifications", id), { read: true });
    } catch (error) {
      console.error("Error marking read:", error);
    }
  }

  // Marcar todas
  window.markAllAsRead = async function () {
    try {
      const q = query(
        collection(db, "notifications"),
        where("read", "==", false),
      );
      const snapshot = await getDocs(q);
      const batch = writeBatch(db);

      snapshot.docs.forEach((docx) => {
        batch.update(docx.ref, { read: true });
      });

      await batch.commit();
    } catch (error) {
      console.error("Error marking all:", error);
    }
  };

  function formatTimeAgo(date) {
    if (!date) return "";
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);

    if (diff < 60) return "Hace un momento";
    if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;

    return date.toLocaleDateString();
  }
</script>
