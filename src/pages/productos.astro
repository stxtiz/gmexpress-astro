---
import Layout from "../layouts/Layout.astro";
import ProductHeader from "../components/productos/ProductHeader.astro";
import ProductFooter from "../components/productos/ProductFooter.astro";
import CategoryFilter from "../components/productos/CategoryFilter.astro";
import ProductGrid from "../components/productos/ProductGrid.astro";
import Pagination from "../components/productos/Pagination.astro";
import "../styles/global.css";
---

<Layout title="GMExpress - Descubre Nuestros Productos">
  <div class="productos-page">
    <ProductHeader searchPlaceholder="Buscar productos..." />

    <main class="container mx-auto px-4 py-8 md:py-12">
      <!-- Título y Descripción -->
      <div class="mb-8 text-center">
        <p
          class="text-4xl md:text-5xl font-black tracking-tighter text-text-light dark:text-white"
        >
          Descubre Nuestros Productos
        </p>
        <p
          class="mt-2 text-text-light/80 dark:text-text-dark/80 max-w-2xl mx-auto"
        >
          Explora una deliciosa variedad de platos preparados con los
          ingredientes más frescos.
        </p>
      </div>

      <!-- Filtros de Categoría -->
      <CategoryFilter />

      <!-- Grid de Productos -->
      <ProductGrid />

      <!-- Paginación -->
      <Pagination />
    </main>

    <!-- Mockup Carrito lateral -->
    <div
      id="cart-panel"
      class="fixed inset-y-0 right-0 z-50 w-full max-w-md translate-x-full bg-background-light dark:bg-background-dark shadow-2xl border-l border-border-light dark:border-border-dark transition-transform duration-300 flex flex-col"
    >
      <div
        class="flex items-center justify-between px-4 py-3 border-b border-border-light dark:border-border-dark"
      >
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-primary"
            >shopping_cart</span
          >
          <h2 class="text-lg font-bold text-text-light dark:text-text-dark">
            Carrito
          </h2>
        </div>
        <button
          id="cart-close"
          class="flex h-8 w-8 items-center justify-center rounded-full hover:bg-card-light dark:hover:bg-card-dark"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div
        id="cart-items"
        class="flex-1 overflow-y-auto px-4 py-3 space-y-3 text-sm"
      >
        <!-- Items agregados por JS para mockup -->
      </div>

      <div
        class="border-t border-border-light dark:border-border-dark px-4 py-4 space-y-2"
      >
        <div class="flex items-center justify-between text-xs">
          <span class="text-text-light/60 dark:text-text-dark/60">Subtotal</span
          >
          <span
            id="cart-subtotal"
            class="font-medium text-text-light/80 dark:text-text-dark/80"
            >$0</span
          >
        </div>
        <div class="flex items-center justify-between text-xs">
          <span class="text-text-light/60 dark:text-text-dark/60"
            >IVA (19%)</span
          >
          <span
            id="cart-iva"
            class="font-medium text-text-light/80 dark:text-text-dark/80"
            >$0</span
          >
        </div>
        <div
          class="flex items-center justify-between text-sm pt-2 border-t border-border-light/50 dark:border-border-dark/50"
        >
          <span class="text-text-light dark:text-text-dark font-semibold"
            >Total</span
          >
          <span id="cart-total" class="font-bold text-primary text-lg">$0</span>
        </div>
        <button
          class="mt-2 flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-secondary text-white text-sm font-bold tracking-wide hover:bg-secondary/90 transition-colors"
        >
          Ir al pago
        </button>
      </div>
    </div>

    <!-- Modal de Detalle del Producto -->
    <div
      id="product-detail-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
    >
      <div
        class="relative w-full max-w-2xl mx-4 bg-background-light dark:bg-background-dark rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <button
          id="close-modal"
          class="absolute top-4 right-4 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-card-light dark:bg-card-dark hover:bg-primary/10 transition-colors"
        >
          <span
            class="material-symbols-outlined text-text-light dark:text-text-dark"
            >close</span
          >
        </button>

        <div id="modal-content">
          <!-- Contenido inyectado dinámicamente -->
        </div>
      </div>
    </div>

    <script>
      const cartPanel = document.getElementById("cart-panel");
      const cartClose = document.getElementById("cart-close");
      const cartItems = document.getElementById("cart-items");
      const cartSubtotal = document.getElementById("cart-subtotal");
      const cartIva = document.getElementById("cart-iva");
      const cartTotal = document.getElementById("cart-total");

      // Cargar carrito desde localStorage
      let mockCart = JSON.parse(localStorage.getItem("gmexpress-cart") || "[]");

      const saveCart = () => {
        localStorage.setItem("gmexpress-cart", JSON.stringify(mockCart));
      };

      const formatPrice = (value) => value.trim();

      const openCart = () => {
        cartPanel?.classList.add("translate-x-0");
        cartPanel?.classList.remove("translate-x-full");
      };

      const closeCart = () => {
        cartPanel?.classList.add("translate-x-full");
        cartPanel?.classList.remove("translate-x-0");
      };

      const updateCartDisplay = () => {
        if (!cartItems || !cartTotal || !cartSubtotal || !cartIva) return;

        // Limpiar carrito
        cartItems.innerHTML = "";

        if (mockCart.length === 0) {
          cartItems.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-center">
              <span class="material-symbols-outlined text-6xl text-text-light/30 dark:text-text-dark/30">shopping_cart</span>
              <p class="mt-3 text-sm text-text-light/60 dark:text-text-dark/60">Tu carrito está vacío</p>
            </div>
          `;
          cartSubtotal.textContent = "$0";
          cartIva.textContent = "$0";
          cartTotal.textContent = "$0";
          return;
        }

        // Renderizar items
        mockCart.forEach((item, index) => {
          const itemEl = document.createElement("div");
          itemEl.className =
            "flex items-start justify-between gap-2 rounded-lg bg-card-light dark:bg-card-dark px-3 py-2";
          itemEl.innerHTML = `
            <div class="flex-1">
              <p class="font-medium text-text-light dark:text-text-dark">${item.name}</p>
              <p class="text-xs text-text-light/70 dark:text-text-dark/70">Cantidad: ${item.quantity}</p>
              ${item.type ? `<p class="text-xs text-primary mt-0.5">${item.type}</p>` : ""}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-primary">${formatPrice(item.price)}</span>
              <button 
                data-remove-item="${index}"
                class="text-text-light/50 dark:text-text-dark/50 hover:text-red-500 transition-colors"
              >
                <span class="material-symbols-outlined text-sm">close</span>
              </button>
            </div>
          `;
          cartItems.appendChild(itemEl);
        });

        // Calcular subtotal
        const subtotal = mockCart.reduce((sum, item) => {
          const priceNum = parseFloat(item.price.replace(/[^0-9]/g, ""));
          return sum + priceNum * item.quantity;
        }, 0);

        // Calcular IVA (19%) y total
        const iva = subtotal * 0.19;
        const total = subtotal + iva;

        cartSubtotal.textContent = `$${subtotal.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        cartIva.textContent = `$${iva.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        cartTotal.textContent = `$${total.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      // Evento para cerrar carrito
      cartClose?.addEventListener("click", closeCart);

      // Función para mostrar detalle del producto
      function showProductDetail(name, price, image, alt, description) {
        const modal = document.getElementById("product-detail-modal");
        const modalContent = document.getElementById("modal-content");

        if (!modal || !modalContent) return;

        modalContent.innerHTML = `
          <div class="relative">
            <img
              src="${image}"
              alt="${alt}"
              class="w-full h-64 md:h-96 object-cover rounded-t-2xl"
            />
          </div>
          <div class="p-6 md:p-8">
            <h2 class="text-3xl font-bold text-text-light dark:text-text-dark mb-4">
              ${name}
            </h2>
            <p class="text-4xl font-bold text-primary mb-6">${price}</p>
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-2">
                Descripción
              </h3>
              <p class="text-text-light/80 dark:text-text-dark/80 leading-relaxed">
                ${description}
              </p>
            </div>
            <button
              onclick="addToCartFromModal('${name.replace(/'/g, "\\'")}', '${price}')"
              class="w-full flex items-center justify-center gap-2 rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-colors"
            >
              <span class="material-symbols-outlined">shopping_cart</span>
              <span>Añadir al Carrito</span>
            </button>
          </div>
        `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // Función para cerrar modal
      function closeProductModal() {
        const modal = document.getElementById("product-detail-modal");
        modal?.classList.add("hidden");
        modal?.classList.remove("flex");
      }

      // Agregar al carrito desde el modal
      window.addToCartFromModal = function (name, price) {
        const existingIndex = mockCart.findIndex(
          (item) => item.name === name && item.type === "producto",
        );

        if (existingIndex >= 0) {
          mockCart[existingIndex].quantity += 1;
        } else {
          mockCart.push({
            name,
            price,
            quantity: 1,
            type: "producto",
          });
        }

        saveCart();
        updateCartDisplay();
        closeProductModal();
        openCart();
      };

      // Evento para cerrar modal
      document
        .getElementById("close-modal")
        ?.addEventListener("click", closeProductModal);
      document
        .getElementById("product-detail-modal")
        ?.addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            closeProductModal();
          }
        });

      // Evento para cerrar carrito
      cartClose?.addEventListener("click", closeCart);

      // Evento global para todos los clicks
      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        // Abrir carrito desde el botón del header
        if (target.closest("[data-cart-toggle]")) {
          openCart();
          return;
        }

        // Remover item del carrito
        const removeBtn = target.closest("[data-remove-item]");
        if (removeBtn) {
          const index = parseInt(
            removeBtn.getAttribute("data-remove-item") || "0",
          );
          mockCart.splice(index, 1);
          saveCart();
          updateCartDisplay();
          return;
        }

        // Ver detalle del producto (botón "Ver más")
        if (target.closest("[data-view-detail]")) {
          const card = target.closest("[data-product]");
          if (!card) return;

          const nameEl = card.querySelector("[data-product-name]");
          const priceEl = card.querySelector("[data-product-price]");
          const imgEl = card.querySelector("img");
          const descEl = card.querySelector("p.text-sm");

          const name = nameEl?.textContent ?? "Producto";
          const price = priceEl?.textContent ?? "$0";
          const image = imgEl?.src ?? "";
          const alt = imgEl?.alt ?? "";
          const description = descEl?.textContent ?? "";

          showProductDetail(name, price, image, alt, description);
          return;
        }

        // Agregar al carrito
        if (
          target.closest("[data-add-to-cart]") &&
          target.closest("[data-product]")
        ) {
          const card = target.closest("[data-product]");
          const nameEl = card.querySelector("[data-product-name]");
          const priceEl = card.querySelector("[data-product-price]");

          const name = nameEl?.textContent ?? "Producto";
          const price = priceEl?.textContent ?? "$0";

          // Buscar si el producto ya existe
          const existingIndex = mockCart.findIndex(
            (item) => item.name === name && item.type === "producto",
          );

          if (existingIndex >= 0) {
            // Incrementar cantidad
            mockCart[existingIndex].quantity += 1;
          } else {
            // Agregar nuevo producto
            mockCart.push({
              name,
              price,
              quantity: 1,
              type: "producto",
            });
          }

          saveCart();
          updateCartDisplay();
          openCart();
        }
      });

      // Inicializar carrito (si está vacío, agregar productos de ejemplo)
      if (mockCart.length === 0) {
        mockCart = [
          {
            name: "Hamburguesa Clásica",
            price: "$8.990",
            quantity: 2,
            type: "producto",
          },
          {
            name: "Pizza Margarita",
            price: "$12.500",
            quantity: 1,
            type: "producto",
          },
          {
            name: "Ensalada César",
            price: "$6.990",
            quantity: 1,
            type: "producto",
          },
        ];
        saveCart();
      }
      updateCartDisplay();
    </script>

    <ProductFooter />
  </div>
</Layout>

<style>
  :global(.productos-page) {
    --primary-color: #8bc34a;
    --secondary-color: #0a2342;
    --background-light: #ffffff;
    --background-dark: #0a2342;
    --text-light: #0a2342;
    --text-dark: #ffffff;
    --card-light: #f7fafc;
    --card-dark: #123456;
    --border-light: #e2e8f0;
    --border-dark: #2a4a6d;
  }
</style>
