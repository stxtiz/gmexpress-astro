---
import Layout from "../../../layouts/Layout.astro";
import "../../../styles/global.css";
---

<Layout title="GMExpress - Admin Dashboard - Servicios">
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />

  <div class="admin-dashboard min-vh-100">
    <!-- Sidebar -->
    <div class="sidebar bg-dark text-white vh-100 position-fixed">
      <div class="p-4">
        <div class="d-flex align-items-center mb-4">
          <img
            src="/images/Logo-horizontal.png"
            alt="GMExpress Logo"
            class="img-fluid"
            style="max-height: 50px; filter: brightness(0) invert(1);"
          />
        </div>
        <hr class="text-white-50" />
        <nav class="nav flex-column gap-2">
          <a
            href="/admin"
            class="nav-link text-white-50 d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>
          <a
            href="/admin/productos"
            class="nav-link text-white-50 d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-box-seam"></i>
            <span>Productos</span>
          </a>
          <a
            href="/admin/servicios"
            class="nav-link text-white active-link d-flex align-items-center gap-2 rounded"
          >
            <i class="bi bi-gear"></i>
            <span>Servicios</span>
          </a>
          <a
            href="/admin/usuarios"
            class="nav-link text-white-50 d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-people"></i>
            <span>Usuarios</span>
          </a>
          <a
            href="/admin/pedidos"
            class="nav-link text-white-50 d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-cart-check"></i>
            <span>Pedidos</span>
          </a>
          <hr class="text-white-50" />
          <a
            href="/"
            class="nav-link text-white-50 d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-house"></i>
            <span>Volver al sitio</span>
          </a>
          <a
            href="#"
            class="nav-link text-danger d-flex align-items-center gap-2 rounded hover-item"
          >
            <i class="bi bi-box-arrow-right"></i>
            <span>Cerrar sesión</span>
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
          <h4 class="mb-0 text-dark fw-bold">Gestión de Servicios</h4>
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-link text-dark position-relative">
              <i class="bi bi-bell fs-5"></i>
              <span
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              >
                3
              </span>
            </button>
            <div class="dropdown">
              <button
                class="btn btn-link text-dark dropdown-toggle d-flex align-items-center gap-2"
                type="button"
                data-bs-toggle="dropdown"
              >
                <div
                  class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                  style="width: 40px; height: 40px;"
                >
                  <i class="bi bi-person-fill"></i>
                </div>
                <span class="fw-semibold">Admin</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Perfil</a></li>
                <li><a class="dropdown-item" href="#">Configuración</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item text-danger" href="#"
                    >Cerrar sesión</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <!-- Content Area -->
      <div class="p-4">
        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-gear text-primary fs-4"></i>
                  </div>
                  <span class="badge bg-success">+12%</span>
                </div>
                <h3 class="fw-bold mb-0" id="total-servicios">6</h3>
                <p class="text-muted mb-0 small">Total Servicios</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-check-circle text-success fs-4"></i>
                  </div>
                  <span class="badge bg-primary">100%</span>
                </div>
                <h3 class="fw-bold mb-0" id="servicios-activos">6</h3>
                <p class="text-muted mb-0 small">Activos</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-currency-dollar text-warning fs-4"></i>
                  </div>
                  <span class="badge bg-info">2</span>
                </div>
                <h3 class="fw-bold mb-0" id="con-precio">2</h3>
                <p class="text-muted mb-0 small">Con Precio</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-chat-dots text-info fs-4"></i>
                  </div>
                  <span class="badge bg-warning">4</span>
                </div>
                <h3 class="fw-bold mb-0" id="sin-precio">4</h3>
                <p class="text-muted mb-0 small">Consultar Precio</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Bar -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3 align-items-center">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0 ps-0"
                    placeholder="Buscar servicios..."
                    id="searchInput"
                  />
                </div>
              </div>
              <div class="col-md-6 text-end">
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#servicioModal"
                  onclick="openCreateModal()"
                >
                  <i class="bi bi-plus-circle me-2"></i>Nuevo Servicio
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                  <tr>
                    <th class="px-4 py-3 border-0">
                      <input type="checkbox" class="form-check-input" />
                    </th>
                    <th class="px-4 py-3 border-0">Imagen</th>
                    <th class="px-4 py-3 border-0">Nombre</th>
                    <th class="px-4 py-3 border-0">Descripción</th>
                    <th class="px-4 py-3 border-0">Precio</th>
                    <th class="px-4 py-3 border-0">Estado</th>
                    <th class="px-4 py-3 border-0 text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody id="serviciosTableBody">
                  <!-- Se llenará dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer bg-white border-top-0">
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted small"
                >Mostrando <span id="showing-count">6</span> de <span
                  id="total-count">6</span
                > servicios</span
              >
              <nav>
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item disabled">
                    <a class="page-link" href="#">Anterior</a>
                  </li>
                  <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                  </li>
                  <li class="page-item"><a class="page-link" href="#">2</a></li>
                  <li class="page-item"><a class="page-link" href="#">3</a></li>
                  <li class="page-item">
                    <a class="page-link" href="#">Siguiente</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Crear/Editar Servicio -->
  <div
    class="modal fade"
    id="servicioModal"
    tabindex="-1"
    aria-labelledby="servicioModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="servicioModalLabel">
            Nuevo Servicio
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="servicioForm">
            <input type="hidden" id="servicioId" />
            <div class="row g-3">
              <div class="col-12">
                <label for="nombre" class="form-label fw-semibold"
                  >Nombre del Servicio <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  placeholder="Ej: Catering para Eventos"
                  required
                />
              </div>
              <div class="col-12">
                <label for="descripcion" class="form-label fw-semibold"
                  >Descripción <span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="descripcion"
                  rows="3"
                  placeholder="Describe el servicio..."
                  required></textarea>
              </div>
              <div class="col-md-6">
                <label for="imagen" class="form-label fw-semibold"
                  >URL de Imagen <span class="text-danger">*</span></label
                >
                <input
                  type="url"
                  class="form-control"
                  id="imagen"
                  placeholder="https://ejemplo.com/imagen.jpg"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="alt" class="form-label fw-semibold"
                  >Texto Alternativo <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="alt"
                  placeholder="Descripción de la imagen"
                  required
                />
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="hasPrice"
                    onchange="togglePriceFields()"
                  />
                  <label class="form-check-label fw-semibold" for="hasPrice">
                    El servicio tiene precio definido
                  </label>
                </div>
              </div>
              <div class="col-md-6" id="priceField" style="display: none;">
                <label for="precio" class="form-label fw-semibold">Precio</label
                >
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="text"
                    class="form-control"
                    id="precio"
                    placeholder="12.500"
                  />
                </div>
              </div>
              <div class="col-md-6" id="priceLabelField" style="display: none;">
                <label for="priceLabel" class="form-label fw-semibold"
                  >Etiqueta de Precio</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="priceLabel"
                  placeholder="/ por almuerzo"
                />
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="activo"
                    checked
                  />
                  <label class="form-check-label fw-semibold" for="activo">
                    Servicio activo
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cancelar</button
          >
          <button
            type="button"
            class="btn btn-primary"
            onclick="saveServicio()"
          >
            <i class="bi bi-save me-2"></i>Guardar Servicio
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Eliminación -->
  <div
    class="modal fade"
    id="deleteModal"
    tabindex="-1"
    aria-labelledby="deleteModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-danger" id="deleteModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            ¿Estás seguro de que deseas eliminar el servicio <strong
              id="deleteServiceName"></strong>?
          </p>
          <p class="text-muted small mb-0 mt-2">
            Esta acción no se puede deshacer.
          </p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cancelar</button
          >
          <button
            type="button"
            class="btn btn-danger"
            onclick="confirmDelete()"
          >
            <i class="bi bi-trash me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-dashboard {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .sidebar {
      width: 260px;
      left: 0;
      top: 0;
      z-index: 1000;
      background: linear-gradient(180deg, #1a2e3d 0%, #0a1929 100%);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .hover-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .active-link {
      background-color: #79c043 !important;
      color: white !important;
    }

    .active-link:hover {
      background-color: #6ab03a !important;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: rgba(121, 192, 67, 0.05);
      transform: translateX(2px);
    }

    .service-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    .btn-action {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .badge {
      font-weight: 600;
      padding: 0.35em 0.65em;
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    import { db } from "../../../firebase/client";
    import {
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      orderBy
    } from "firebase/firestore";

    const servicesCollection = collection(db, "services");
    const q = query(servicesCollection, orderBy("name"));

    // Definir tipos
    // Definir tipos
    interface Service {
      id: string;
      name: string;
      price: number;
      description: string;
      image: string;
      alt: string;
      category: string;
      active: boolean;
      hasPrice: boolean;
      priceLabel?: string;
      activo: boolean;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      createdAt?: any;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      updatedAt?: any;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      [key: string]: any;
    }

    declare global {
      interface Window {
        togglePriceFields: () => void;
        openCreateModal: () => void;
        viewServicio: (id: string) => void;
        editServicio: (id: string) => void;
        deleteServicio: (id: string) => void;
        confirmDelete: () => Promise<void>;
        saveServicio: () => Promise<void>;
      }
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      var bootstrap: any;
    }

    let servicios: Service[] = [];
    let editingId: string | null = null;
    let deleteId: string | null = null;
    let filteredServices: Service[] = [];

    onSnapshot(q, (snapshot) => {
      servicios = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Service[];
      filteredServices = [...servicios];
      renderTable();
      updateStats();
    });

    // Renderizar tabla
    // Renderizar tabla
    function renderTable(serviceList: Service[] = filteredServices) {
      const tbody = document.getElementById("serviciosTableBody") as HTMLTableSectionElement;
      if (!tbody) return;
      tbody.innerHTML = "";

      serviceList.forEach((servicio) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4">
            <input type="checkbox" class="form-check-input" />
          </td>
          <td class="px-4">
            <img src="${servicio.image}" alt="${servicio.alt}" class="service-img" />
          </td>
          <td class="px-4">
            <div class="fw-semibold text-dark">${servicio.name}</div>
          </td>
          <td class="px-4">
            <div class="text-muted small" style="max-width: 300px;">${servicio.description ? servicio.description.substring(0, 80) : ''}...</div>
          </td>
          <td class="px-4">
            ${
              servicio.hasPrice
                ? `<span class="badge bg-success">${servicio.price}</span>`
                : '<span class="badge bg-info">Consultar</span>'
            }
          </td>
          <td class="px-4">
            <span class="badge ${servicio.activo ? "bg-success" : "bg-secondary"}">
              ${servicio.activo ? "Activo" : "Inactivo"}
            </span>
          </td>
          <td class="px-4 text-end">
            <button class="btn btn-sm btn-action btn-outline-primary me-1" onclick="window.viewServicio('${servicio.id}')" title="Ver">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-warning me-1" onclick="window.editServicio('${servicio.id}')" title="Editar">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-danger" onclick="window.deleteServicio('${servicio.id}')" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      const showingCount = document.getElementById("showing-count");
      const totalCount = document.getElementById("total-count");
      if(showingCount) showingCount.textContent = serviceList.length.toString();
      if(totalCount) totalCount.textContent = servicios.length.toString();
    }

    // Actualizar estadísticas
    function updateStats() {
      const totalServicios = document.getElementById("total-servicios");
      const serviciosActivos = document.getElementById("servicios-activos");
      const conPrecio = document.getElementById("con-precio");
      const sinPrecio = document.getElementById("sin-precio");

      if(totalServicios) totalServicios.textContent = servicios.length.toString();
      if(serviciosActivos) serviciosActivos.textContent = servicios.filter((s) => s.activo).length.toString();
      if(conPrecio) conPrecio.textContent = servicios.filter((s) => s.hasPrice).length.toString();
      if(sinPrecio) sinPrecio.textContent = servicios.filter((s) => !s.hasPrice).length.toString();
    }

    // Toggle price fields
    // Toggle price fields
    window.togglePriceFields = function() {
      const hasPrice = (document.getElementById("hasPrice") as HTMLInputElement).checked;
      const priceField = document.getElementById("priceField");
      const priceLabelField = document.getElementById("priceLabelField");
      
      if(priceField) priceField.style.display = hasPrice ? "block" : "none";
      if(priceLabelField) priceLabelField.style.display = hasPrice ? "block" : "none";
      
      const precioInput = document.getElementById("precio") as HTMLInputElement;
      if(precioInput) precioInput.required = hasPrice;
    }

    // Abrir modal para crear
    window.openCreateModal = function () {
      editingId = null;
      const label = document.getElementById("servicioModalLabel");
      const form = document.getElementById("servicioForm") as HTMLFormElement;
      const activo = document.getElementById("activo") as HTMLInputElement;
      const hasPrice = document.getElementById("hasPrice") as HTMLInputElement;
      
      if(label) label.textContent = "Nuevo Servicio";
      if(form) form.reset();
      if(activo) activo.checked = true;
      if(hasPrice) {
          hasPrice.checked = false;
          window.togglePriceFields();
      }
    };

    // Ver servicio
    window.viewServicio = function (id) {
      const servicio = servicios.find((s) => s.id === id);
      if (servicio) {
        alert(
          `Servicio: ${servicio.name}\n\nDescripción: ${servicio.description}\n\nPrecio: ${servicio.hasPrice ? servicio.price : "Consultar"}\n\nEstado: ${servicio.activo ? "Activo" : "Inactivo"}`
        );
      }
    };

    // Editar servicio
    window.editServicio = function (id: string) {
      const servicio = servicios.find((s) => s.id === id);
      if (servicio) {
        editingId = id;
        document.getElementById("servicioModalLabel")!.textContent = "Editar Servicio";
        (document.getElementById("nombre") as HTMLInputElement).value = servicio.name;
        (document.getElementById("descripcion") as HTMLTextAreaElement).value = servicio.description;
        (document.getElementById("imagen") as HTMLInputElement).value = servicio.image;
        (document.getElementById("alt") as HTMLInputElement).value = servicio.alt;
        (document.getElementById("hasPrice") as HTMLInputElement).checked = servicio.hasPrice;
        (document.getElementById("activo") as HTMLInputElement).checked = servicio.activo;

        if (servicio.hasPrice) {
          (document.getElementById("precio") as HTMLInputElement).value = servicio.price.toString().replace('$', '').replace(/\./g, '');
          (document.getElementById("priceLabel") as HTMLInputElement).value = servicio.priceLabel || "";
        }

        window.togglePriceFields();

        const modal = new bootstrap.Modal(document.getElementById("servicioModal"));
        modal.show();
      }
    };

    // Eliminar servicio
    // Eliminar servicio
    window.deleteServicio = function (id: string) {
      const servicio = servicios.find((s) => s.id === id);
      if (servicio) {
        deleteId = id;
        document.getElementById("deleteServiceName").textContent = servicio.name;
        const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
        modal.show();
      }
    };

    // Confirmar eliminación
    window.confirmDelete = async function () {
      if(deleteId) {
          try {
            await deleteDoc(doc(db, "services", deleteId));
            const modal = bootstrap.Modal.getInstance(document.getElementById("deleteModal"));
            modal.hide();
            showToast("Servicio eliminado exitosamente", "success");
          } catch(e) {
            console.error("Error deleting service:", e);
            alert("Error al eliminar el servicio");
          }
      }
    };

    // Guardar servicio
    // Guardar servicio
    window.saveServicio = async function () {
      const nombre = (document.getElementById("nombre") as HTMLInputElement).value;
      const descripcion = (document.getElementById("descripcion") as HTMLTextAreaElement).value;
      const imagen = (document.getElementById("imagen") as HTMLInputElement).value;
      const alt = (document.getElementById("alt") as HTMLInputElement).value;
      const hasPrice = (document.getElementById("hasPrice") as HTMLInputElement).checked;
      const activo = (document.getElementById("activo") as HTMLInputElement).checked;
      
      let precio = "";
      let priceLabel = "";
      
      if(hasPrice) {
          const precioRaw = (document.getElementById("precio") as HTMLInputElement).value;
          precio = "$" + parseInt(precioRaw).toLocaleString('es-CL');
          priceLabel = (document.getElementById("priceLabel") as HTMLInputElement).value;
      }

      if (!nombre || !descripcion || !imagen || !alt) {
        alert("Por favor, completa todos los campos obligatorios");
        return;
      }
      
      if (hasPrice && !(document.getElementById("precio") as HTMLInputElement).value) {
          alert("Por favor, ingresa el precio");
          return;
      }

      const servicioData = {
        name: nombre,
        description: descripcion,
        image: imagen,
        alt: alt,
        hasPrice,
        price: precio,
        priceLabel,
        activo,
        updatedAt: new Date()
      };

      try {
          if (editingId) {
            await updateDoc(doc(db, "services", editingId), servicioData);
            showToast("Servicio actualizado exitosamente", "success");
          } else {
            servicioData.createdAt = new Date();
            await addDoc(servicesCollection, servicioData);
            showToast("Servicio creado exitosamente", "success");
          }
          
          const modal = bootstrap.Modal.getInstance(document.getElementById("servicioModal"));
          modal.hide();
      } catch(e) {
          console.error("Error saving service:", e);
          alert("Error al guardar el servicio");
      }
    };
    
    // Search filter
    document.getElementById("searchInput")?.addEventListener("input", (e) => {
        const term = (e.target as HTMLInputElement).value.toLowerCase();
        filteredServices = servicios.filter(s => 
            s.name.toLowerCase().includes(term) || 
            s.description.toLowerCase().includes(term)
        );
        renderTable(filteredServices);
    });

    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
      toast.style.zIndex = "9999";
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle me-2"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</Layout>
