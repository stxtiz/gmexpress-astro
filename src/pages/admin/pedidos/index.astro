---
import Layout from "../../../layouts/Layout.astro";
import "../../../styles/global.css";
import AdminGuard from "../../../components/admin/AdminGuard.astro";
import AdminHeader from "../../../components/admin/AdminHeader.astro";
import AdminSidebar from "../../../components/admin/AdminSidebar.astro";
---

<Layout title="GMExpress - Admin Dashboard - Pedidos">
  <AdminGuard />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />

  <div class="admin-dashboard min-vh-100">
    <!-- Sidebar -->
    <AdminSidebar activePath="/admin/pedidos" />

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <AdminHeader title="Gestión de Pedidos" />

      <!-- Content Area -->
      <div class="p-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="pedidosTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="pedidos-tab"
              data-bs-toggle="tab"
              data-bs-target="#pedidos"
              type="button"
              role="tab"
            >
              <i class="bi bi-cart-check me-2"></i>Pedidos
              <span class="badge bg-primary ms-2" id="pedidos-nuevos-badge"
                >...</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="solicitudes-tab"
              data-bs-toggle="tab"
              data-bs-target="#solicitudes"
              type="button"
              role="tab"
            >
              <i class="bi bi-envelope-paper me-2"></i>Solicitudes de Cotización
              <span
                class="badge bg-warning text-dark ms-2"
                id="solicitudes-pendientes-badge">...</span
              >
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="pedidosTabContent">
          <!-- Pedidos Tab -->
          <div
            class="tab-pane fade"
            id="pedidos"
            role="tabpanel"
            aria-labelledby="pedidos-tab"
          >
            <!-- Stats Cards Pedidos -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-clock-history text-info fs-4"></i>
                      </div>
                      <span class="badge bg-info">Nuevos</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="pedidos-proceso">5</h3>
                    <p class="text-muted mb-0 small">En Proceso</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-truck text-warning fs-4"></i>
                      </div>
                      <span class="badge bg-warning text-dark">En ruta</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="pedidos-transito">4</h3>
                    <p class="text-muted mb-0 small">En Tránsito</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-check-circle text-success fs-4"></i>
                      </div>
                      <span class="badge bg-success">Entregados</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="pedidos-recibidos">3</h3>
                    <p class="text-muted mb-0 small">Recibidos</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-cart-check text-primary fs-4"></i>
                      </div>
                      <span class="badge bg-primary">Total</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="pedidos-total">12</h3>
                    <p class="text-muted mb-0 small">Total Pedidos</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters Pedidos -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-4">
                    <div class="input-group">
                      <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search"></i>
                      </span>
                      <input
                        type="text"
                        class="form-control border-start-0 ps-0"
                        placeholder="Buscar por pedido o cliente..."
                        id="searchPedidos"
                      />
                    </div>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" id="estadoPedidoFilter">
                      <option value="">Todos los estados</option>
                      <option value="En Proceso">En Proceso</option>
                      <option value="En Tránsito">En Tránsito</option>
                      <option value="Recibido">Recibido</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" id="fechaPedidoFilter">
                      <option value="">Todas las fechas</option>
                      <option value="hoy">Hoy</option>
                      <option value="semana">Esta semana</option>
                      <option value="mes">Este mes</option>
                    </select>
                  </div>
                  <div class="col-md-2 text-end">
                    <button class="btn btn-outline-primary">
                      <i class="bi bi-funnel me-2"></i>Filtrar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabla de Pedidos -->
            <div class="card border-0 shadow-sm">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0 align-middle">
                    <thead class="bg-light">
                      <tr>
                        <th class="px-4 py-3 border-0">
                          <input
                            type="checkbox"
                            class="form-check-input"
                            id="selectAllPedidos"
                          />
                        </th>
                        <th class="px-4 py-3 border-0">Pedido</th>
                        <th class="px-4 py-3 border-0">Cliente</th>
                        <th class="px-4 py-3 border-0">Productos</th>
                        <th class="px-4 py-3 border-0">Fecha</th>
                        <th class="px-4 py-3 border-0">Total</th>
                        <th class="px-4 py-3 border-0">Estado</th>
                        <th class="px-4 py-3 border-0 text-end">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="pedidosTableBody">
                      <!-- Se llenará dinámicamente -->
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer bg-white border-top-0">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted small"
                    >Mostrando <span id="showing-pedidos-count">0</span> de <span
                      id="total-pedidos-count">0</span
                    > pedidos</span
                  >
                  <nav>
                    <ul
                      class="pagination pagination-sm mb-0"
                      id="pedidos-pagination-container"
                    >
                      <!-- Paginación dinámica -->
                    </ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>

          <!-- Solicitudes Tab -->
          <div
            class="tab-pane fade show active"
            id="solicitudes"
            role="tabpanel"
            aria-labelledby="solicitudes-tab"
          >
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-clock-history text-warning fs-4"></i>
                      </div>
                      <span class="badge bg-warning text-dark">Nuevas</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="solicitudes-pendientes">3</h3>
                    <p class="text-muted mb-0 small">Pendientes</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-file-earmark-text text-info fs-4"></i>
                      </div>
                      <span class="badge bg-info">En proceso</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="solicitudes-proceso">2</h3>
                    <p class="text-muted mb-0 small">En Proceso</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-check-circle text-success fs-4"></i>
                      </div>
                      <span class="badge bg-success">Completadas</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="solicitudes-completadas">
                      15
                    </h3>
                    <p class="text-muted mb-0 small">Completadas</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-body">
                    <div
                      class="d-flex align-items-center justify-content-between mb-2"
                    >
                      <div
                        class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                      >
                        <i class="bi bi-envelope-paper text-primary fs-4"></i>
                      </div>
                      <span class="badge bg-primary">Total</span>
                    </div>
                    <h3 class="fw-bold mb-0" id="solicitudes-total">20</h3>
                    <p class="text-muted mb-0 small">Total Solicitudes</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body">
                <div class="row g-3 align-items-center">
                  <div class="col-md-3">
                    <div class="input-group">
                      <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search"></i>
                      </span>
                      <input
                        type="text"
                        class="form-control border-start-0 ps-0"
                        placeholder="Buscar..."
                        id="searchSolicitudes"
                      />
                    </div>
                  </div>
                  <div class="col-md-2">
                    <select class="form-select" id="estadoFilter">
                      <option value="">Estado</option>
                      <option value="Pendiente">Pendiente</option>
                      <option value="En Proceso">En Proceso</option>
                      <option value="Completada">Completada</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" id="servicioFilter">
                      <option value="">Servicio</option>
                      <!-- Se llenará dinámicamente -->
                    </select>
                  </div>
                  <div class="col-md-2">
                    <select class="form-select" id="fechaFilter">
                      <option value="">Fecha</option>
                      <option value="hoy">Hoy</option>
                      <option value="semana">Esta semana</option>
                      <option value="mes">Este mes</option>
                    </select>
                  </div>
                  <div class="col-md-2 text-end">
                    <button
                      class="btn btn-outline-primary w-100"
                      onclick="applySolicitudesFilters()"
                    >
                      <i class="bi bi-funnel me-2"></i>Filtrar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Solicitudes List -->
            <div class="row">
              <!-- Lista de Solicitudes -->
              <div class="col-lg-5">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">Lista de Solicitudes</h6>
                  </div>
                  <div class="card-body p-0">
                    <div
                      class="list-group list-group-flush"
                      id="solicitudesList"
                    >
                      <!-- Se llenará dinámicamente -->
                    </div>
                  </div>
                  <div class="card-footer bg-white border-0 py-2">
                    <nav aria-label="Paginación de solicitudes">
                      <ul
                        class="pagination pagination-sm mb-0 justify-content-center"
                        id="solicitudes-pagination-container"
                      >
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>

              <!-- Detalle de Solicitud -->
              <div class="col-lg-7">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">
                      <i class="bi bi-file-earmark-text me-2"></i>Detalle de
                      Solicitud
                    </h6>
                  </div>
                  <div class="card-body" id="solicitudDetalle">
                    <!-- Placeholder inicial -->
                    <div class="text-center py-5">
                      <i
                        class="bi bi-envelope-open text-muted"
                        style="font-size: 4rem;"></i>
                      <p class="text-muted mt-3">
                        Selecciona una solicitud para ver los detalles
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Detalle de Pedido -->
  <div
    class="modal fade"
    id="detallePedidoModal"
    tabindex="-1"
    aria-labelledby="detallePedidoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="detallePedidoModalLabel">
            <i class="bi bi-receipt me-2"></i>Detalle del Pedido
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body" id="detallePedidoBody">
          <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cerrar</button
          >
          <button
            type="button"
            class="btn btn-primary"
            onclick="imprimirPedido()"
          >
            <i class="bi bi-printer me-2"></i>Imprimir
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-dashboard {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .hover-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .active-link {
      background-color: #79c043 !important;
      color: white !important;
    }

    .active-link:hover {
      background-color: #6ab03a !important;
    }

    .card {
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .list-group-item {
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .list-group-item:hover {
      background-color: #f8f9fa;
      border-left-color: #79c043;
      transform: translateX(3px);
    }

    .list-group-item.active {
      background-color: #e8f5e9;
      border-left-color: #79c043;
      color: inherit;
    }

    .solicitud-card {
      border-left: 4px solid transparent;
    }

    .solicitud-card.pendiente {
      border-left-color: #ffc107;
    }

    .solicitud-card.proceso {
      border-left-color: #17a2b8;
    }

    .solicitud-card.completada {
      border-left-color: #28a745;
    }

    .badge {
      font-weight: 600;
      padding: 0.35em 0.65em;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    import { db, auth } from "../../../firebase/client";
    import {
      doc,
      updateDoc,
      addDoc,
      collection,
      serverTimestamp,
      query,
      onSnapshot,
      orderBy,
    } from "firebase/firestore";

    // ============================================
    // GESTIÓN DE PEDIDOS - DATOS REALES DE FIREBASE
    // ============================================

    // Array de pedidos que se llenará con datos de Firestore
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let pedidos: any[] = [];
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let filteredPedidos: any[] = [];

    // Paginación de pedidos
    const PEDIDOS_PER_PAGE = 10;
    let currentPedidosPage = 1;

    // Formatear precio - maneja números y strings
    function formatPrecio(precio: number | string | undefined): string {
      if (precio === undefined || precio === null) return "$0";

      // Si ya es un string formateado (ej: "$16.990"), devolverlo tal cual
      if (typeof precio === "string") {
        if (precio.startsWith("$")) return precio;
        // Si es string numérico, parsearlo
        const num = parseInt(precio.replace(/[^0-9]/g, ""), 10);
        if (!isNaN(num)) return "$" + num.toLocaleString("es-CL");
        return "$0";
      }

      // Si es número
      if (typeof precio === "number" && !isNaN(precio)) {
        return "$" + precio.toLocaleString("es-CL");
      }

      return "$0";
    }

    // Extraer número de precio formateado
    function precioToNumber(precio: string | number | undefined): number {
      if (precio === undefined || precio === null) return 0;
      if (typeof precio === "number") return precio;
      const num = parseInt(precio.replace(/[^0-9]/g, ""), 10);
      return isNaN(num) ? 0 : num;
    }

    // Fetch Pedidos en tiempo real desde Firestore
    function fetchPedidos() {
      const q = query(collection(db, "pedidos"), orderBy("createdAt", "desc"));

      onSnapshot(
        q,
        (snapshot) => {
          pedidos = snapshot.docs.map((docSnap) => {
            const data = docSnap.data();
            return {
              docId: docSnap.id,
              id: data.id || docSnap.id.slice(-6).toUpperCase(),
              cliente: data.cliente || "Cliente",
              email: data.email || "",
              telefono: data.telefono || "",
              fecha:
                data.fecha ||
                (data.createdAt
                  ? new Date(data.createdAt.seconds * 1000)
                      .toISOString()
                      .split("T")[0]
                  : new Date().toISOString().split("T")[0]),
              estado: data.estado || "En Proceso",
              subtotal: formatPrecio(data.subtotal),
              iva: formatPrecio(data.iva),
              total: formatPrecio(data.total),
              // eslint-disable-next-line @typescript-eslint/no-explicit-any
              productos: (data.productos || []).map((p: any) => {
                const cantidad = p.quantity || p.cantidad || 1;
                const precioNum = precioToNumber(p.price || p.precio);
                return {
                  nombre: p.name || p.nombre || "Producto",
                  cantidad: cantidad,
                  precio: formatPrecio(p.price || p.precio),
                  subtotal: formatPrecio(precioNum * cantidad),
                };
              }),
              direccion: data.direccion || "",
              metodoPago: data.metodoPago || "No especificado",
              notas: data.notas || "",
              userId: data.userId || "",
            };
          });

          filteredPedidos = [...pedidos];
          renderPedidosTable(filteredPedidos);
          updatePedidosBadge();
        },
        (error) => {
          console.error("Error fetching pedidos:", error);
          const tbody = document.getElementById("pedidosTableBody");
          if (tbody) {
            tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-circle me-2"></i>
                Error al cargar pedidos: ${error.message}
              </td>
            </tr>
          `;
          }
        },
      );
    }

    // Actualizar badge del tab de pedidos (solo pedidos NO completados/recibidos)
    function updatePedidosBadge() {
      const badge = document.getElementById("pedidos-nuevos-badge");
      if (badge) {
        // Contar solo pedidos que NO están "Recibido" (pendientes de atención)
        const pendientes = pedidos.filter(
          (p) => p.estado !== "Recibido",
        ).length;
        badge.textContent = pendientes.toString();

        // Cambiar color según cantidad
        badge.className =
          "badge ms-2 " + (pendientes > 0 ? "bg-danger" : "bg-secondary");
      }
    }

    // Renderizar tabla de pedidos
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    function renderPedidosTable(pedidosList: any[] = pedidos) {
      const tbody = document.getElementById("pedidosTableBody");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (pedidosList.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-5 text-muted">
              <i class="bi bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-3">No hay pedidos registrados</p>
              <small>Los pedidos realizados desde la tienda aparecerán aquí</small>
            </td>
          </tr>
        `;
        updatePedidosStats();
        renderPedidosPagination(0);
        return;
      }

      // Calcular paginación
      const totalPages = Math.ceil(pedidosList.length / PEDIDOS_PER_PAGE);
      const startIndex = (currentPedidosPage - 1) * PEDIDOS_PER_PAGE;
      const endIndex = startIndex + PEDIDOS_PER_PAGE;
      const paginatedPedidos = pedidosList.slice(startIndex, endIndex);

      paginatedPedidos.forEach((pedido) => {
        const badgeClass =
          pedido.estado === "En Proceso"
            ? "bg-info"
            : pedido.estado === "En Tránsito"
              ? "bg-warning text-dark"
              : pedido.estado === "Recibido"
                ? "bg-success"
                : pedido.estado === "Cancelado"
                  ? "bg-danger"
                  : "bg-secondary";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4">
            <input type="checkbox" class="form-check-input pedido-checkbox" value="${pedido.docId}" />
          </td>
          <td class="px-4">
            <div class="fw-semibold text-dark">#${pedido.id}</div>
            <small class="text-muted">${formatFechaPedido(pedido.fecha)}</small>
          </td>
          <td class="px-4">
            <div class="fw-semibold">${pedido.cliente}</div>
            <small class="text-muted">${pedido.email}</small>
          </td>
          <td class="px-4">
            <span class="badge bg-light text-dark border">${pedido.productos.length} items</span>
          </td>
          <td class="px-4">
            <small>${formatFechaPedido(pedido.fecha)}</small>
          </td>
          <td class="px-4">
            <span class="fw-bold text-success">${pedido.total}</span>
          </td>
          <td class="px-4">
            <span class="badge ${badgeClass}">
              ${pedido.estado}
            </span>
          </td>
          <td class="px-4 text-end">
            <button class="btn btn-sm btn-action btn-outline-primary me-1" onclick="verDetallePedido('${pedido.docId}')" title="Ver Detalle">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-warning me-1" onclick="cambiarEstadoPedido('${pedido.docId}')" title="Cambiar Estado">
              <i class="bi bi-arrow-repeat"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-success" onclick="imprimirPedido('${pedido.docId}')" title="Imprimir">
              <i class="bi bi-printer"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      updatePedidosStats(paginatedPedidos.length, pedidosList.length);
      renderPedidosPagination(totalPages);
    }

    // Renderizar paginación de pedidos
    function renderPedidosPagination(totalPages: number) {
      const container = document.getElementById("pedidos-pagination-container");
      if (!container) return;

      container.innerHTML = "";

      if (totalPages <= 1) return;

      // Botón Anterior
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentPedidosPage === 1 ? "disabled" : ""}`;
      prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPedidosPage - 1}">Anterior</a>`;
      container.appendChild(prevLi);

      // Números de página
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${currentPedidosPage === i ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        container.appendChild(li);
      }

      // Botón Siguiente
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${currentPedidosPage === totalPages ? "disabled" : ""}`;
      nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPedidosPage + 1}">Siguiente</a>`;
      container.appendChild(nextLi);

      // Event listeners
      container.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const page = parseInt((e.target as HTMLElement).dataset.page || "1");
          if (page >= 1 && page <= totalPages && page !== currentPedidosPage) {
            currentPedidosPage = page;
            renderPedidosTable(filteredPedidos);
          }
        });
      });
    }

    // Formatear fecha
    function formatFechaPedido(fecha: string | Date | null): string {
      if (!fecha) return "-";
      const date = new Date(fecha);
      return date.toLocaleDateString("es-CL", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
    }

    // Update pedidos statistics
    function updatePedidosStats(showingCount?: number, totalFiltered?: number) {
      const proceso = pedidos.filter((p) => p.estado === "En Proceso").length;
      const transito = pedidos.filter((p) => p.estado === "En Tránsito").length;
      const recibidos = pedidos.filter((p) => p.estado === "Recibido").length;

      const procesoEl = document.getElementById("pedidos-proceso");
      const transitoEl = document.getElementById("pedidos-transito");
      const recibidosEl = document.getElementById("pedidos-recibidos");
      const totalEl = document.getElementById("pedidos-total");

      if (procesoEl) procesoEl.textContent = proceso.toString();
      if (transitoEl) transitoEl.textContent = transito.toString();
      if (recibidosEl) recibidosEl.textContent = recibidos.toString();
      if (totalEl) totalEl.textContent = pedidos.length.toString();

      const showingEl = document.getElementById("showing-pedidos-count");
      const totalCountEl = document.getElementById("total-pedidos-count");
      if (showingEl)
        showingEl.textContent = (
          showingCount ?? filteredPedidos.length
        ).toString();
      if (totalCountEl)
        totalCountEl.textContent = (totalFiltered ?? pedidos.length).toString();
    }

    // Ver detalle del pedido
    // @ts-ignore - window functions for inline onclick
    window.verDetallePedido = function (docId: string) {
      const pedido = pedidos.find((p) => p.docId === docId);
      if (!pedido) return;

      const badgeClass =
        pedido.estado === "En Proceso"
          ? "bg-info"
          : pedido.estado === "En Tránsito"
            ? "bg-warning text-dark"
            : pedido.estado === "Recibido"
              ? "bg-success"
              : pedido.estado === "Cancelado"
                ? "bg-danger"
                : "bg-secondary";

      const detalle = document.getElementById("detallePedidoBody");
      if (!detalle) return;
      detalle.innerHTML = `
        <div class="mb-4 pb-3 border-bottom">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h4 class="fw-bold mb-2">Pedido #${pedido.id}</h4>
              <span class="badge ${badgeClass}">${pedido.estado}</span>
            </div>
            <div class="text-end">
              <p class="text-muted mb-0 small">Fecha</p>
              <p class="fw-semibold mb-0">${formatFechaPedido(pedido.fecha)}</p>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-person-circle me-2 text-primary"></i>Información del Cliente
          </h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Cliente</p>
                <p class="fw-semibold mb-0">${pedido.cliente}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Email</p>
                <p class="mb-0">${pedido.email}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Teléfono</p>
                <p class="mb-0">${pedido.telefono || "No especificado"}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Dirección de Entrega</p>
                <p class="mb-0">${pedido.direccion || "No especificada"}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-cart me-2 text-primary"></i>Productos
          </h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="bg-light">
                <tr>
                  <th>Producto</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Precio Unit.</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${pedido.productos
                  .map(
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    (p: any) => `
                  <tr>
                    <td>${p.nombre}</td>
                    <td class="text-center">${p.cantidad}</td>
                    <td class="text-end">${p.precio}</td>
                    <td class="text-end fw-semibold">${p.subtotal}</td>
                  </tr>
                `,
                  )
                  .join("")}
              </tbody>
              <tfoot class="border-top">
                <tr>
                  <td colspan="3" class="text-end">Subtotal:</td>
                  <td class="text-end fw-semibold">${pedido.subtotal}</td>
                </tr>
                <tr>
                  <td colspan="3" class="text-end">IVA (19%):</td>
                  <td class="text-end fw-semibold">${pedido.iva}</td>
                </tr>
                <tr class="border-top">
                  <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                  <td class="text-end fw-bold text-success h5 mb-0">${pedido.total}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="mb-3">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-credit-card me-2 text-primary"></i>Información de Pago
          </h6>
          <div class="bg-light rounded p-3">
            <p class="text-muted mb-1 small">Método de Pago</p>
            <p class="fw-semibold mb-0">${pedido.metodoPago}</p>
          </div>
        </div>

        ${
          pedido.notas
            ? `
        <div>
          <h6 class="fw-bold mb-3">
            <i class="bi bi-sticky me-2 text-primary"></i>Notas del Pedido
          </h6>
          <div class="bg-light rounded p-3">
            <p class="mb-0">${pedido.notas}</p>
          </div>
        </div>
        `
            : ""
        }
      `;

      const modal = new bootstrap.Modal(
        document.getElementById("detallePedidoModal"),
      );
      modal.show();
    };

    // Cambiar estado del pedido
    // @ts-ignore - window functions for inline onclick
    window.cambiarEstadoPedido = async function (docId: string) {
      const pedido = pedidos.find((p) => p.docId === docId);
      if (!pedido) return;

      const estados = ["En Proceso", "En Tránsito", "Recibido"];
      const currentIndex = estados.indexOf(pedido.estado);
      const nextIndex = (currentIndex + 1) % estados.length;
      const nuevoEstado = estados[nextIndex];

      try {
        // Actualizar en Firestore con audit log
        const pedidoRef = doc(db, "pedidos", docId);
        await updateDoc(pedidoRef, {
          estado: nuevoEstado,
          updatedBy: auth.currentUser?.uid,
          updatedAt: serverTimestamp(),
        });

        // El onSnapshot actualizará automáticamente la UI
        showToast(`Estado actualizado a: ${nuevoEstado}`, "success");

        // Crear notificación
        await createNotification(
          "Pedido Actualizado",
          `El pedido #${pedido.id} cambió a estado: ${nuevoEstado}`,
          "info",
        );
      } catch (error) {
        console.error("Error actualizando estado del pedido:", error);
        showToast(
          "Error al actualizar estado: " +
            (error instanceof Error ? error.message : "Error desconocido"),
          "danger",
        );
      }
    };

    // Imprimir pedido
    // @ts-ignore - window functions for inline onclick
    window.imprimirPedido = function (docId: string) {
      const pedido = pedidos.find((p) => p.docId === docId);
      if (pedido) {
        showToast(
          `Generando PDF del pedido #${pedido.id}... (Función en desarrollo)`,
          "info",
        );
      }
    };

    // Aplicar filtros de pedidos
    function applyPedidosFilters() {
      const searchTerm =
        (
          document.getElementById("searchPedidos") as HTMLInputElement
        )?.value.toLowerCase() || "";
      const estadoFilter =
        (document.getElementById("estadoPedidoFilter") as HTMLSelectElement)
          ?.value || "";

      filteredPedidos = pedidos.filter((pedido) => {
        const matchSearch =
          pedido.cliente.toLowerCase().includes(searchTerm) ||
          pedido.id.toString().toLowerCase().includes(searchTerm) ||
          pedido.email.toLowerCase().includes(searchTerm);
        const matchEstado = !estadoFilter || pedido.estado === estadoFilter;

        return matchSearch && matchEstado;
      });

      currentPedidosPage = 1; // Reset a página 1 al filtrar
      renderPedidosTable(filteredPedidos);
    }

    // Event listeners para pedidos
    document
      .getElementById("searchPedidos")
      ?.addEventListener("input", applyPedidosFilters);
    document
      .getElementById("estadoPedidoFilter")
      ?.addEventListener("change", applyPedidosFilters);

    // Select all pedidos
    document
      .getElementById("selectAllPedidos")
      ?.addEventListener("change", (e) => {
        const target = e.target as HTMLInputElement;
        const checkboxes =
          document.querySelectorAll<HTMLInputElement>(".pedido-checkbox");
        checkboxes.forEach((cb) => (cb.checked = target.checked));
      });

    // Inicializar solicitudes
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let solicitudes: any[] = [];
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let filteredSolicitudes: any[] = [];
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let selectedSolicitud: any = null;

    // Paginación de solicitudes
    const SOLICITUDES_PER_PAGE = 10;
    let currentSolicitudesPage = 1;

    // Fetch Solicitudes (Real-time)
    function fetchSolicitudes() {
      // Remove orderBy to avoid index issues for now
      const q = query(collection(db, "solicitudes"));

      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const unsubscribe = onSnapshot(
        q,
        (snapshot) => {
          solicitudes = snapshot.docs.map((doc) => {
            const data = doc.data();
            return {
              docId: doc.id, // Firestore document ID for updates
              id: data.id || doc.id, // Custom ID or fallback to doc ID
              cliente: data.nombre || "Cliente Sin Nombre",
              email: data.email || "",
              telefono: data.telefono || "",
              empresa: data.empresa || "",
              ciudad: data.ciudad || "",
              servicio: data.servicio || "",
              fecha: data.fecha || new Date().toISOString().split("T")[0],
              estado: data.estado || "Pendiente",
              prioridad: data.prioridad || "Media",
              numeroPersonas: data.numeroPersonas || 0,
              fechaEstimada: data.fechaEstimada || "",
              descripcion: data.descripcion || "",
              cotizacionEnviada: data.cotizacionEnviada || "",
              fechaRespuesta: data.fechaRespuesta || "",
              createdAt: data.createdAt, // Keep for sorting
            };
          });

          // Sort client-side
          solicitudes.sort((a, b) => {
            const dateA = a.createdAt
              ? a.createdAt.seconds
              : new Date(a.fecha).getTime() / 1000;
            const dateB = b.createdAt
              ? b.createdAt.seconds
              : new Date(b.fecha).getTime() / 1000;
            return dateB - dateA;
          });

          // Apply current filters to new data
          applySolicitudesFilters();
        },
        (error) => {
          console.error("Error fetching solicitudes:", error);
          const list = document.getElementById("solicitudesList");
          if (list) {
            list.innerHTML = `
                    <div class="text-center p-4 text-danger">
                        <small>Error al cargar solicitudes: ${error.message}</small>
                    </div>
                `;
          }
        },
      );
    }

    /* MOCK DATA ORIGINAL (COMENTADO POR SOLICITUD DEL USUARIO)
    const solicitudesMock = [
      {
        id: 123,
        cliente: "Empresa ABC S.A.",
        email: "contacto@empresaabc.com",
        telefono: "+56 9 1234 5678",
        empresa: "Empresa ABC S.A.",
        ciudad: "Santiago",
        servicio: "Catering para Eventos",
        fecha: "2025-11-15",
        estado: "Pendiente",
        prioridad: "Alta",
        numeroPersonas: 150,
        fechaEstimada: "2025-12-10",
        descripcion: "Necesitamos servicio de catering para evento corporativo de 150 personas. Incluye desayuno, almuerzo y coffee break.",
      },
      // ... otros datos mock
    ];
    */

    // Renderizar lista de solicitudes con paginación
    function renderSolicitudesList() {
      const list = document.getElementById("solicitudesList");
      if (!list) return;
      list.innerHTML = "";

      // Ordenar: Pendientes primero
      const sortedSolicitudes = [...filteredSolicitudes].sort((a, b) => {
        if (a.estado === "Pendiente" && b.estado !== "Pendiente") return -1;
        if (a.estado !== "Pendiente" && b.estado === "Pendiente") return 1;
        return new Date(b.fecha).getTime() - new Date(a.fecha).getTime();
      });

      if (sortedSolicitudes.length === 0) {
        list.innerHTML = `
          <div class="text-center p-4 text-muted">
            <small>No se encontraron solicitudes</small>
          </div>
        `;
        renderSolicitudesPagination(0);
        return;
      }

      // Calcular paginación
      const totalPages = Math.ceil(
        sortedSolicitudes.length / SOLICITUDES_PER_PAGE,
      );
      const startIndex = (currentSolicitudesPage - 1) * SOLICITUDES_PER_PAGE;
      const endIndex = startIndex + SOLICITUDES_PER_PAGE;
      const paginatedSolicitudes = sortedSolicitudes.slice(
        startIndex,
        endIndex,
      );

      paginatedSolicitudes.forEach((sol) => {
        const badgeClass =
          sol.estado === "Pendiente"
            ? "bg-warning text-dark"
            : sol.estado === "En Proceso"
              ? "bg-info"
              : "bg-success";

        const prioridadIcon =
          sol.prioridad === "Alta"
            ? '<i class="bi bi-exclamation-circle-fill text-danger"></i>'
            : sol.prioridad === "Media"
              ? '<i class="bi bi-dash-circle-fill text-warning"></i>'
              : '<i class="bi bi-info-circle-fill text-info"></i>';

        const item = document.createElement("div");
        item.className = `list-group-item solicitud-card ${sol.estado.toLowerCase().replace(" ", "")} ${selectedSolicitud?.id === sol.id ? "active" : ""}`;
        item.onclick = () => selectSolicitud(sol.id);
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1 fw-bold">
                ${prioridadIcon}
                Solicitud #${sol.id.toString().slice(-6)}
              </h6>
              <p class="mb-1 small text-muted">
                <i class="bi bi-building me-1"></i>${sol.cliente}
              </p>
            </div>
            <span class="badge ${badgeClass}">${sol.estado}</span>
          </div>
          <p class="mb-2 small">
            <i class="bi bi-gear me-1"></i>${sol.servicio}
          </p>
          <p class="mb-0 text-muted" style="font-size: 0.75rem;">
            <i class="bi bi-calendar me-1"></i>${formatFecha(sol.fecha)}
          </p>
        `;
        list.appendChild(item);
      });

      updateStats();
      renderSolicitudesPagination(totalPages);
    }

    // Renderizar paginación de solicitudes
    function renderSolicitudesPagination(totalPages: number) {
      const container = document.getElementById(
        "solicitudes-pagination-container",
      );
      if (!container) return;

      container.innerHTML = "";

      if (totalPages <= 1) return;

      // Botón Anterior
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentSolicitudesPage === 1 ? "disabled" : ""}`;
      prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentSolicitudesPage - 1}">«</a>`;
      container.appendChild(prevLi);

      // Números de página (mostrar máximo 5)
      let startPage = Math.max(1, currentSolicitudesPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${currentSolicitudesPage === i ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        container.appendChild(li);
      }

      // Botón Siguiente
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${currentSolicitudesPage === totalPages ? "disabled" : ""}`;
      nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentSolicitudesPage + 1}">»</a>`;
      container.appendChild(nextLi);

      // Event listeners
      container.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const page = parseInt((e.target as HTMLElement).dataset.page || "1");
          if (
            page >= 1 &&
            page <= totalPages &&
            page !== currentSolicitudesPage
          ) {
            currentSolicitudesPage = page;
            renderSolicitudesList();
          }
        });
      });
    }

    // Aplicar filtros de solicitudes
    function applySolicitudesFilters() {
      const searchTerm =
        (
          document.getElementById("searchSolicitudes") as HTMLInputElement
        )?.value.toLowerCase() || "";
      const estadoFilter =
        (document.getElementById("estadoFilter") as HTMLSelectElement)?.value ||
        "";
      const fechaFilter =
        (document.getElementById("fechaFilter") as HTMLSelectElement)?.value ||
        "";
      const servicioFilter =
        (document.getElementById("servicioFilter") as HTMLSelectElement)
          ?.value || "";

      filteredSolicitudes = solicitudes.filter((sol) => {
        const matchSearch =
          sol.cliente.toLowerCase().includes(searchTerm) ||
          sol.id.toString().includes(searchTerm) ||
          sol.email.toLowerCase().includes(searchTerm) ||
          sol.empresa.toLowerCase().includes(searchTerm);

        const matchEstado = !estadoFilter || sol.estado === estadoFilter;
        const matchServicio =
          !servicioFilter || sol.servicio === servicioFilter;

        let matchFecha = true;
        if (fechaFilter) {
          const solDate = new Date(sol.fecha);
          const today = new Date();
          if (fechaFilter === "hoy") {
            matchFecha = solDate.toDateString() === today.toDateString();
          } else if (fechaFilter === "semana") {
            const weekAgo = new Date(today.setDate(today.getDate() - 7));
            matchFecha = solDate >= weekAgo;
          } else if (fechaFilter === "mes") {
            matchFecha =
              solDate.getMonth() === new Date().getMonth() &&
              solDate.getFullYear() === new Date().getFullYear();
          }
        }

        return matchSearch && matchEstado && matchFecha && matchServicio;
      });

      // Reset a primera página al filtrar
      currentSolicitudesPage = 1;
      renderSolicitudesList();
    }

    // Select solicitud to view details
    function selectSolicitud(id: string | number) {
      selectedSolicitud = solicitudes.find((s) => s.id === id);
      renderDetalle();
      renderSolicitudesList(); // Re-render to update active state
    }

    function renderDetalle() {
      const detalle = document.getElementById("solicitudDetalle");
      if (!detalle) return;

      if (!selectedSolicitud) {
        detalle.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-envelope-open text-muted" style="font-size: 4rem;"></i>
            <p class="text-muted mt-3">Selecciona una solicitud para ver los detalles</p>
          </div>
        `;
        return;
      }

      const sol = selectedSolicitud;
      const badgeClass =
        sol.estado === "Pendiente"
          ? "bg-warning text-dark"
          : sol.estado === "En Proceso"
            ? "bg-info"
            : "bg-success";

      detalle.innerHTML = `
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-start mb-4 pb-3 border-bottom">
          <div>
            <h4 class="fw-bold mb-2">Solicitud #${sol.id}</h4>
            <span class="badge ${badgeClass} me-2">${sol.estado}</span>
            <span class="badge bg-secondary">${sol.prioridad} Prioridad</span>
          </div>
          <div class="text-end">
            <p class="text-muted mb-0 small">Recibida</p>
            <p class="fw-semibold mb-0">${formatFecha(sol.fecha)}</p>
          </div>
        </div>

        <!-- Información del Cliente -->
        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-person-circle me-2 text-primary"></i>Información del Cliente
          </h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Cliente</p>
                <p class="fw-semibold mb-0">${sol.cliente}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Empresa</p>
                <p class="fw-semibold mb-0">${sol.empresa}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Email</p>
                <p class="mb-0">
                  <a href="mailto:${sol.email}" class="text-decoration-none">${sol.email}</a>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Teléfono</p>
                <p class="mb-0">
                  <a href="tel:${sol.telefono}" class="text-decoration-none">${sol.telefono}</a>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Ciudad</p>
                <p class="fw-semibold mb-0">${sol.ciudad}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Servicio Solicitado</p>
                <p class="fw-semibold mb-0 text-primary">${sol.servicio}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Descripción -->
        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-file-text me-2 text-primary"></i>Descripción de la Solicitud
          </h6>
          <div class="bg-light rounded p-3">
            <p class="mb-0">${sol.descripcion}</p>
          </div>
        </div>

        <!-- Detalles del Servicio -->
        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-list-check me-2 text-primary"></i>Detalles del Servicio
          </h6>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Número de Personas</p>
                <p class="mb-0 fw-semibold">${sol.numeroPersonas}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="bg-light rounded p-3">
                <p class="text-muted mb-1 small">Fecha Estimada de Inicio</p>
                <p class="mb-0 fw-semibold">${formatFecha(sol.fechaEstimada)}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Cambiar Estado -->
        <div class="mb-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-arrow-repeat me-2 text-primary"></i>Gestión de Estado
          </h6>
          <div class="bg-light rounded p-3">
            <p class="text-muted mb-2 small">Estado Actual: <strong>${sol.estado}</strong></p>
            <div class="d-flex gap-2 flex-wrap">
              <button 
                class="btn btn-sm ${sol.estado === "Pendiente" ? "btn-warning" : "btn-outline-warning"}"
                onclick="cambiarEstado('Pendiente')"
                ${sol.estado === "Pendiente" ? "disabled" : ""}
              >
                <i class="bi bi-clock-history me-1"></i>Pendiente
              </button>
              <button 
                class="btn btn-sm ${sol.estado === "En Proceso" ? "btn-info" : "btn-outline-info"}"
                onclick="cambiarEstado('En Proceso')"
                ${sol.estado === "En Proceso" ? "disabled" : ""}
              >
                <i class="bi bi-hourglass-split me-1"></i>En Proceso
              </button>
              <button 
                class="btn btn-sm ${sol.estado === "Completada" ? "btn-success" : "btn-outline-success"}"
                onclick="cambiarEstado('Completada')"
                ${sol.estado === "Completada" ? "disabled" : ""}
              >
                <i class="bi bi-check-circle me-1"></i>Completada
              </button>
            </div>
          </div>
        </div>

        <!-- Acciones -->
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary flex-grow-1" onclick="contactarCliente()">
            <i class="bi bi-envelope me-2"></i>Contactar Cliente
          </button>
          <button class="btn btn-outline-secondary" onclick="exportarPDF()">
            <i class="bi bi-file-pdf me-2"></i>Exportar PDF
          </button>
        </div>
      `;
    }

    // Formatear fecha
    function formatFecha(fecha: string | Date): string {
      if (!fecha) return "-";
      const date = new Date(fecha);
      return date.toLocaleDateString("es-CL", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    // Contactar cliente
    // @ts-ignore - window functions for inline onclick
    window.contactarCliente = function () {
      if (selectedSolicitud) {
        window.location.href = `mailto:${selectedSolicitud.email}?subject=Solicitud #${selectedSolicitud.id} - ${selectedSolicitud.servicio}`;
      }
    };

    // Actualizar estadísticas de solicitudes
    function updateStats() {
      const pendientes = solicitudes.filter(
        (s) => s.estado === "Pendiente",
      ).length;
      const proceso = solicitudes.filter(
        (s) => s.estado === "En Proceso",
      ).length;
      const completadas = solicitudes.filter(
        (s) => s.estado === "Completada",
      ).length;

      const pendientesEl = document.getElementById("solicitudes-pendientes");
      const procesoEl = document.getElementById("solicitudes-proceso");
      const completadasEl = document.getElementById("solicitudes-completadas");
      const totalEl = document.getElementById("solicitudes-total");
      const badgeEl = document.getElementById("solicitudes-pendientes-badge");

      if (pendientesEl) pendientesEl.textContent = pendientes.toString();
      if (procesoEl) procesoEl.textContent = proceso.toString();
      if (completadasEl) completadasEl.textContent = completadas.toString();
      if (totalEl) totalEl.textContent = solicitudes.length.toString();

      // Actualizar badge del tab (solo pendientes, que requieren atención)
      if (badgeEl) {
        badgeEl.textContent = pendientes.toString();
        badgeEl.className =
          "badge text-dark ms-2 " +
          (pendientes > 0 ? "bg-warning" : "bg-secondary");
      }
    }

    // Cambiar estado
    // @ts-ignore - window functions for inline onclick
    window.cambiarEstado = async function (nuevoEstado: string) {
      if (selectedSolicitud && selectedSolicitud.estado !== nuevoEstado) {
        const oldEstado = selectedSolicitud.estado;

        try {
          // Actualizar en Firestore using the actual Firestore document ID
          const solicitudRef = doc(db, "solicitudes", selectedSolicitud.docId);
          await updateDoc(solicitudRef, {
            estado: nuevoEstado,
          });

          // Actualizar localmente
          selectedSolicitud.estado = nuevoEstado;
          renderSolicitudesList();
          renderDetalle();
          showToast(`Estado actualizado a: ${nuevoEstado}`, "success");

          // Crear notificación
          await createNotification(
            "Estado Actualizado",
            `La solicitud #${selectedSolicitud.id} cambió de ${oldEstado} a ${nuevoEstado}`,
            "info",
          );
        } catch (error) {
          console.error("Error actualizando estado:", error);
          showToast("Error al actualizar estado", "error");
        }
      }
    };

    // Crear notificación en Firestore
    async function createNotification(
      title: string,
      message: string,
      type = "info",
    ) {
      try {
        await addDoc(collection(db, "notifications"), {
          title,
          message,
          type,
          read: false,
          createdAt: serverTimestamp(),
        });
      } catch (error) {
        console.error("Error creating notification:", error);
      }
    }

    // Exportar PDF
    // @ts-ignore - window functions for inline onclick
    window.exportarPDF = function () {
      showToast("Exportando a PDF... (Función en desarrollo)", "info");
    };

    // Toast notification
    function showToast(message: string, type = "info") {
      const toast = document.createElement("div");
      toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
      toast.style.zIndex = "9999";
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle me-2"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Búsqueda - ahora usa applySolicitudesFilters para mantener paginación
    document
      .getElementById("searchSolicitudes")
      ?.addEventListener("input", () => {
        applySolicitudesFilters();
      });

    // Filtros - ahora usa applySolicitudesFilters para mantener paginación
    document.getElementById("estadoFilter")?.addEventListener("change", () => {
      applySolicitudesFilters();
    });

    // Inicializar
    fetchPedidos(); // Fetch pedidos desde Firestore (tiempo real)
    fetchSolicitudes(); // Fetch solicitudes desde Firestore (tiempo real)
    if (solicitudes.length > 0) {
      selectSolicitud(solicitudes[0].id);
    }
  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</Layout>
