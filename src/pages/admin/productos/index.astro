---
import Layout from "../../../layouts/Layout.astro";
import "../../../styles/global.css";
import AdminGuard from "../../../components/admin/AdminGuard.astro";
import AdminHeader from "../../../components/admin/AdminHeader.astro";
import AdminSidebar from "../../../components/admin/AdminSidebar.astro";
---

<Layout title="GMExpress - Admin Dashboard - Productos">
  <AdminGuard />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />

  <div class="admin-dashboard min-vh-100">
    <!-- Sidebar -->
    <AdminSidebar activePath="/admin/productos" />

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <AdminHeader title="Gestión de Productos" />

      <!-- Content Area -->
      <div class="p-4">
        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-box-seam text-primary fs-4"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-0" id="total-productos">...</h3>
                <p class="text-muted mb-0 small">Total Productos</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-check-circle text-success fs-4"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-0" id="productos-activos">...</h3>
                <p class="text-muted mb-0 small">Activos</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-tags text-warning fs-4"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-0" id="categorias">...</h3>
                <p class="text-muted mb-0 small">Categorías</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-2"
                >
                  <div
                    class="rounded-circle bg-danger bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                  </div>
                </div>
                <h3 class="fw-bold mb-0" id="productos-sin-stock">...</h3>
                <p class="text-muted mb-0 small">Sin Stock</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions Bar -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3 align-items-center">
              <div class="col-md-4">
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0 ps-0"
                    placeholder="Buscar productos..."
                    id="searchInput"
                  />
                </div>
              </div>
              <div class="col-md-3">
                <!-- Las opciones se cargan dinámicamente desde Firebase -->
                <select class="form-select" id="categoryFilter">
                  <option value="">Todas las categorías</option>
                </select>
              </div>
              <div class="col-md-2">
                <select class="form-select" id="statusFilter">
                  <option value="">Todos los estados</option>
                  <option value="activo">Activo</option>
                  <option value="inactivo">Inactivo</option>
                </select>
              </div>
              <div class="col-md-3 text-end">
                <button
                  class="btn btn-outline-primary me-2"
                  data-bs-toggle="modal"
                  data-bs-target="#categoriaModal"
                  onclick="openCategoriaModal()"
                >
                  <i class="bi bi-tags me-2"></i>Nueva Categoría
                </button>
                <button
                  class="btn btn-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#productoModal"
                  onclick="openCreateModal()"
                >
                  <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                  <tr>
                    <th class="px-4 py-3 border-0">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="selectAll"
                      />
                    </th>
                    <th class="px-4 py-3 border-0">Imagen</th>
                    <th class="px-4 py-3 border-0">Nombre</th>
                    <th class="px-4 py-3 border-0">Categoría</th>
                    <th class="px-4 py-3 border-0">Precio</th>
                    <th class="px-4 py-3 border-0">Stock</th>
                    <th class="px-4 py-3 border-0">Estado</th>
                    <th class="px-4 py-3 border-0 text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody id="productosTableBody">
                  <!-- Se llenará dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer bg-white border-top-0">
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted small"
                >Mostrando <span id="showing-count">0</span> de <span
                  id="total-count">0</span
                > productos</span
              >
              <nav>
                <ul
                  class="pagination pagination-sm mb-0"
                  id="pagination-container"
                >
                  <!-- Paginación dinámica -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Crear/Editar Producto -->
  <div
    class="modal fade"
    id="productoModal"
    tabindex="-1"
    aria-labelledby="productoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="productoModalLabel">
            Nuevo Producto
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productoForm">
            <input type="hidden" id="productoId" />
            <div class="row g-3">
              <div class="col-md-8">
                <label for="nombre" class="form-label fw-semibold"
                  >Nombre del Producto <span class="text-danger">*</span></label
                >
                <!-- Validación: mínimo 3, máximo 100 caracteres. Pattern previene caracteres peligrosos -->
                <input
                  type="text"
                  class="form-control"
                  id="nombre"
                  placeholder="Ej: Pizza Suprema de la Casa"
                  required
                  minlength="3"
                  maxlength="100"
                  pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s.,\-()¡!¿?&%$#@*+=:;']+$"
                  title="Solo letras, números y caracteres básicos permitidos"
                />
                <div class="form-text text-muted">
                  Mínimo 3, máximo 100 caracteres
                </div>
              </div>
              <div class="col-md-4">
                <label for="categoria" class="form-label fw-semibold"
                  >Categoría <span class="text-danger">*</span></label
                >
                <!-- Las opciones se cargan dinámicamente desde Firebase -->
                <select class="form-select" id="categoria" required>
                  <option value="">Seleccionar...</option>
                </select>
              </div>
              <div class="col-12">
                <label for="descripcion" class="form-label fw-semibold"
                  >Descripción <span class="text-danger">*</span></label
                >
                <!-- Validación: mínimo 10, máximo 1000 caracteres -->
                <textarea
                  class="form-control"
                  id="descripcion"
                  rows="3"
                  placeholder="Describe el producto..."
                  required
                  minlength="10"
                  maxlength="1000"></textarea>
                <div class="form-text text-muted">
                  Mínimo 10, máximo 1000 caracteres
                </div>
              </div>
              <div class="col-md-6">
                <label for="precio" class="form-label fw-semibold"
                  >Precio <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <!-- Validación: solo números positivos, mínimo 1, máximo 99.999.999 -->
                  <input
                    type="number"
                    class="form-control"
                    id="precio"
                    placeholder="16990"
                    required
                    min="1"
                    max="99999999"
                    step="1"
                    title="Ingrese un precio válido (solo números positivos)"
                  />
                </div>
                <div class="form-text text-muted">
                  Solo números enteros positivos
                </div>
              </div>
              <div class="col-md-6">
                <label for="stock" class="form-label fw-semibold"
                  >Stock <span class="text-danger">*</span></label
                >
                <!-- Validación: número entero no negativo, máximo 999.999 -->
                <input
                  type="number"
                  class="form-control"
                  id="stock"
                  placeholder="100"
                  min="0"
                  max="999999"
                  step="1"
                  required
                  title="El stock no puede ser negativo"
                />
                <div class="form-text text-muted">Número entero, mínimo 0</div>
              </div>
              <div class="col-md-6">
                <label for="imagen" class="form-label fw-semibold"
                  >URL de Imagen <span class="text-danger">*</span></label
                >
                <!-- Validación: URL válida con http/https -->
                <input
                  type="url"
                  class="form-control"
                  id="imagen"
                  placeholder="https://ejemplo.com/imagen.jpg"
                  required
                  maxlength="2048"
                  pattern="^https?:\/\/.+"
                  title="Ingrese una URL válida que comience con http:// o https://"
                />
                <div class="form-text text-muted">
                  URL válida (http:// o https://)
                </div>
              </div>
              <div class="col-md-6">
                <label for="alt" class="form-label fw-semibold"
                  >Texto Alternativo <span class="text-danger">*</span></label
                >
                <!-- Validación: mínimo 5, máximo 200 caracteres -->
                <input
                  type="text"
                  class="form-control"
                  id="alt"
                  placeholder="Descripción de la imagen"
                  required
                  minlength="5"
                  maxlength="200"
                  title="Descripción alternativa para accesibilidad"
                />
                <div class="form-text text-muted">
                  Mínimo 5, máximo 200 caracteres
                </div>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="activo"
                    checked
                  />
                  <label class="form-check-label fw-semibold" for="activo">
                    Producto activo
                  </label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="destacado"
                  />
                  <label class="form-check-label fw-semibold" for="destacado">
                    Producto destacado
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cancelar</button
          >
          <button
            type="button"
            class="btn btn-primary"
            onclick="saveProducto()"
          >
            <i class="bi bi-save me-2"></i>Guardar Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Eliminación -->
  <div
    class="modal fade"
    id="deleteModal"
    tabindex="-1"
    aria-labelledby="deleteModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-danger" id="deleteModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            ¿Estás seguro de que deseas eliminar el producto <strong
              id="deleteProductName"></strong>?
          </p>
          <p class="text-muted small mb-0 mt-2">
            Esta acción no se puede deshacer.
          </p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cancelar</button
          >
          <button
            type="button"
            class="btn btn-danger"
            onclick="confirmDelete()"
          >
            <i class="bi bi-trash me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Vista Detallada -->
  <div
    class="modal fade"
    id="viewModal"
    tabindex="-1"
    aria-labelledby="viewModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="viewModalLabel">
            Detalle del Producto
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalBody">
          <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cerrar</button
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Gestionar Categorías -->
  <div
    class="modal fade"
    id="categoriaModal"
    tabindex="-1"
    aria-labelledby="categoriaModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold" id="categoriaModalLabel">
            <i class="bi bi-tags me-2 text-primary"></i>Gestionar Categorías
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Formulario para nueva categoría -->
          <form id="categoriaForm" class="mb-4">
            <label for="categoriaNombre" class="form-label fw-semibold"
              >Nueva Categoría <span class="text-danger">*</span></label
            >
            <div class="input-group">
              <!-- Validación: mínimo 2, máximo 50 caracteres -->
              <input
                type="text"
                class="form-control"
                id="categoriaNombre"
                placeholder="Ej: Postres, Bebidas, etc."
                required
                minlength="2"
                maxlength="50"
                pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s.,\-()]+$"
                title="Solo letras, números y caracteres básicos permitidos"
              />
              <button
                type="button"
                class="btn btn-primary"
                onclick="saveCategoria()"
              >
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div class="form-text text-muted">
              <i class="bi bi-info-circle me-1"></i>Mínimo 2, máximo 50 caracteres.
            </div>
          </form>

          <!-- Lista de categorías existentes -->
          <div class="border-top pt-3">
            <h6 class="fw-semibold mb-3">
              <i class="bi bi-list-ul me-2"></i>Categorías Existentes
              <span class="badge bg-secondary ms-2" id="categoriasCountBadge">0</span>
            </h6>
            <div id="categoriasListContainer" style="max-height: 250px; overflow-y: auto;">
              <!-- Se llena dinámicamente -->
              <div class="text-center text-muted py-3">
                <small>Cargando categorías...</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cerrar</button
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Eliminación de Categoría -->
  <div
    class="modal fade"
    id="deleteCategoriaModal"
    tabindex="-1"
    aria-labelledby="deleteCategoriaModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold text-danger" id="deleteCategoriaModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Eliminar Categoría
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            ¿Estás seguro de que deseas eliminar la categoría <strong id="deleteCategoriaName"></strong>?
          </p>
          <div class="alert alert-warning py-2 small mb-0">
            <i class="bi bi-exclamation-circle me-1"></i>
            Los productos con esta categoría mantendrán la categoría asignada pero ya no aparecerá en los selectores.
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal"
            >Cancelar</button
          >
          <button
            type="button"
            class="btn btn-danger"
            onclick="confirmDeleteCategoria()"
          >
            <i class="bi bi-trash me-2"></i>Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-dashboard {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .hover-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .active-link {
      background-color: #79c043 !important;
      color: white !important;
    }

    .active-link:hover {
      background-color: #6ab03a !important;
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    .table tbody tr:hover {
      background-color: rgba(121, 192, 67, 0.05);
      transform: translateX(2px);
    }

    .product-img {
      width: 60px !important;
      height: 60px !important;
      min-width: 60px !important;
      min-height: 60px !important;
      max-width: 60px !important;
      max-height: 60px !important;
      object-fit: cover !important;
      border-radius: 8px;
      flex-shrink: 0;
      display: block;
    }

    .btn-action {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card {
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .badge {
      font-weight: 600;
      padding: 0.35em 0.65em;
    }

    .stock-badge {
      min-width: 60px;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
    }

    /* ============================================
       ESTILOS PARA VALIDACIONES Y TOASTS
       Animaciones y estilos personalizados
       ============================================ */

    /* Animación de entrada desde la derecha */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Animación de salida hacia la derecha */
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Animación de shake para errores */
    @keyframes shake {
      0%,
      100% {
        transform: translateX(0);
      }
      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-5px);
      }
      20%,
      40%,
      60%,
      80% {
        transform: translateX(5px);
      }
    }

    /* Estilos para campos con error */
    .is-invalid {
      border-color: #dc3545 !important;
      animation: shake 0.5s ease-in-out;
    }

    .is-invalid:focus {
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    /* Lista de errores de validación */
    .validation-error-list {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Toasts personalizados */
    #toast-container .toast {
      min-width: 300px;
      border-radius: 8px;
    }

    #toast-container .toast-header {
      border-radius: 8px 8px 0 0;
    }

    /* Modal de errores de validación */
    #validationErrorModal .modal-content {
      border-radius: 12px;
    }

    #validationErrorModal .modal-header {
      border-radius: 12px 12px 0 0;
    }
  </style>

  <script>
    import { db, auth } from "../../../firebase/client";
    import {
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp,
    } from "firebase/firestore";

    const productsCollection = collection(db, "products");
    const q = query(productsCollection, orderBy("name"));

    // ============================================
    // INTERFAZ: Definición de tipos para Producto
    // ============================================
    interface Product {
      id: string;
      name: string;
      categoria: string;
      description: string;
      price: string;
      stock: number;
      image: string;
      alt: string;
      activo: boolean;
      destacado: boolean;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      createdAt?: any;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      updatedAt?: any;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      [key: string]: any;
    }

    // ============================================
    // INTERFAZ: Resultado de validación
    // ============================================
    interface ValidationResult {
      isValid: boolean;
      errors: string[];
    }

    // ============================================
    // INTERFAZ: Definición de tipos para Categoría
    // ============================================
    interface Category {
      id: string;
      name: string;
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      createdAt?: any;
      createdBy?: string;
    }

    // ============================================
    // CONSTANTES DE VALIDACIÓN
    // Configuración centralizada para límites y patrones
    // ============================================
    const VALIDATION_CONFIG = {
      // Límites de longitud de texto
      NAME_MAX_LENGTH: 100, // Máximo caracteres para nombre
      NAME_MIN_LENGTH: 3, // Mínimo caracteres para nombre
      DESCRIPTION_MAX_LENGTH: 1000, // Máximo caracteres para descripción
      DESCRIPTION_MIN_LENGTH: 10, // Mínimo caracteres para descripción
      ALT_MAX_LENGTH: 200, // Máximo caracteres para texto alternativo
      ALT_MIN_LENGTH: 5, // Mínimo caracteres para texto alternativo

      // Límites numéricos
      PRICE_MAX: 99999999, // Precio máximo ($99.999.999)
      PRICE_MIN: 1, // Precio mínimo ($1)
      STOCK_MAX: 999999, // Stock máximo
      STOCK_MIN: 0, // Stock mínimo (no negativos)

      // Límites para categorías
      CATEGORY_NAME_MAX_LENGTH: 50, // Máximo caracteres para nombre de categoría
      CATEGORY_NAME_MIN_LENGTH: 2,  // Mínimo caracteres para nombre de categoría

      // Patrones regex para validación
      PATTERNS: {
        // URL válida (http/https)
        URL: /^https?:\/\/[^\s<>"{}|\\^`[\]]+$/i,
        // Solo caracteres seguros para nombres (letras, números, espacios, acentos, ñ)
        SAFE_TEXT: /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s.,\-()¡!¿?&%$#@*+=:;'"]+$/,
        // Patrón para detectar posibles scripts maliciosos
        SCRIPT_INJECTION:
          /<script[\s\S]*?>[\s\S]*?<\/script>|javascript:|on\w+\s*=/gi,
        // Patrón para detectar HTML peligroso
        HTML_INJECTION:
          /<[^>]*(iframe|object|embed|form|input|button|meta|link|style)[^>]*>/gi,
        // Solo números para precio
        NUMBERS_ONLY: /^\d+$/,
      },
    } as const;

    declare global {
      interface Window {
        openCreateModal: () => void;
        viewProducto: (id: string) => void;
        editProducto: (id: string) => void;
        deleteProducto: (id: string) => void;
        confirmDelete: () => Promise<void>;
        saveProducto: () => Promise<void>;
        openCategoriaModal: () => void;
        saveCategoria: () => Promise<void>;
        deleteCategoria: (id: string) => void;
        confirmDeleteCategoria: () => Promise<void>;
      }
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      var bootstrap: any;
    }

    let productos: Product[] = [];
    let categorias: Category[] = []; // Categorías cargadas desde Firebase
    let editingId: string | null = null;
    let deleteId: string | null = null;
    let deleteCategoriaId: string | null = null; // ID de categoría a eliminar
    let filteredProducts: Product[] = [];

    // ============================================
    // FUNCIÓN: Sanitizar texto
    // Elimina caracteres peligrosos y previene XSS
    // ============================================
    function sanitizeText(input: string): string {
      if (!input || typeof input !== "string") return "";

      return (
        input
          // Eliminar tags HTML
          .replace(/<[^>]*>/g, "")
          // Escapar caracteres especiales HTML
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#x27;")
          // Eliminar caracteres de control
          .replace(/[\x00-\x1F\x7F]/g, "")
          // Trim espacios
          .trim()
      );
    }

    // ============================================
    // FUNCIÓN: Validar URL
    // Verifica que sea una URL válida y segura
    // ============================================
    function validateUrl(url: string): { isValid: boolean; error?: string } {
      if (!url || typeof url !== "string") {
        return { isValid: false, error: "URL es requerida" };
      }

      const trimmedUrl = url.trim();

      // Verificar longitud máxima
      if (trimmedUrl.length > 2048) {
        return {
          isValid: false,
          error: "URL demasiado larga (máximo 2048 caracteres)",
        };
      }

      // Verificar que sea http o https
      if (!VALIDATION_CONFIG.PATTERNS.URL.test(trimmedUrl)) {
        return {
          isValid: false,
          error: "URL debe comenzar con http:// o https://",
        };
      }

      // Verificar que no contenga javascript:
      if (trimmedUrl.toLowerCase().includes("javascript:")) {
        return { isValid: false, error: "URL contiene contenido no permitido" };
      }

      // Verificar que no contenga data:
      if (trimmedUrl.toLowerCase().includes("data:")) {
        return {
          isValid: false,
          error: "URLs de tipo data: no están permitidas",
        };
      }

      return { isValid: true };
    }

    // ============================================
    // FUNCIÓN: Validar precio
    // Asegura que sea un número positivo dentro del rango permitido
    // IMPORTANTE: Detecta números negativos ANTES de limpiar el string
    // ============================================
    function validatePrice(priceRaw: string): {
      isValid: boolean;
      value: number;
      error?: string;
    } {
      if (!priceRaw || typeof priceRaw !== "string") {
        return { isValid: false, value: 0, error: "Precio es requerido" };
      }

      const trimmedPrice = priceRaw.trim();

      // ============================================
      // VALIDACIÓN CRÍTICA: Detectar números negativos
      // Verificar si el usuario ingresó un signo negativo
      // ============================================
      if (trimmedPrice.includes("-")) {
        console.warn(
          "[SEGURIDAD] Intento de ingresar precio negativo detectado:",
          trimmedPrice,
        );
        return {
          isValid: false,
          value: 0,
          error: "El precio no puede ser negativo. Ingrese un valor positivo.",
        };
      }

      // Limpiar el valor (remover todo excepto números)
      const cleanedPrice = trimmedPrice.replace(/[^0-9]/g, "");

      // Verificar que haya números después de limpiar
      if (cleanedPrice === "") {
        return {
          isValid: false,
          value: 0,
          error: "Precio debe contener números válidos",
        };
      }

      // Verificar que solo contenga números
      if (!VALIDATION_CONFIG.PATTERNS.NUMBERS_ONLY.test(cleanedPrice)) {
        return {
          isValid: false,
          value: 0,
          error: "Precio debe contener solo números positivos",
        };
      }

      const price = parseInt(cleanedPrice, 10);

      // Verificar que sea un número válido
      if (isNaN(price)) {
        return {
          isValid: false,
          value: 0,
          error: "Precio no es un número válido",
        };
      }

      // Verificar que sea positivo (doble verificación)
      if (price < VALIDATION_CONFIG.PRICE_MIN) {
        return {
          isValid: false,
          value: 0,
          error: `Precio debe ser al menos $${VALIDATION_CONFIG.PRICE_MIN}`,
        };
      }

      // Verificar que no exceda el máximo
      if (price > VALIDATION_CONFIG.PRICE_MAX) {
        return {
          isValid: false,
          value: 0,
          error: `Precio no puede exceder $${VALIDATION_CONFIG.PRICE_MAX.toLocaleString("es-CL")}`,
        };
      }

      return { isValid: true, value: price };
    }

    // ============================================
    // FUNCIÓN: Validar stock
    // Asegura que sea un número entero no negativo
    // ============================================
    function validateStock(stockRaw: string): {
      isValid: boolean;
      value: number;
      error?: string;
    } {
      if (stockRaw === "" || stockRaw === null || stockRaw === undefined) {
        return { isValid: false, value: 0, error: "Stock es requerido" };
      }

      const stock = parseInt(stockRaw, 10);

      // Verificar que sea un número válido
      if (isNaN(stock)) {
        return {
          isValid: false,
          value: 0,
          error: "Stock debe ser un número válido",
        };
      }

      // Verificar que no sea negativo
      if (stock < VALIDATION_CONFIG.STOCK_MIN) {
        return {
          isValid: false,
          value: 0,
          error: "Stock no puede ser negativo",
        };
      }

      // Verificar que no exceda el máximo
      if (stock > VALIDATION_CONFIG.STOCK_MAX) {
        return {
          isValid: false,
          value: 0,
          error: `Stock no puede exceder ${VALIDATION_CONFIG.STOCK_MAX.toLocaleString("es-CL")}`,
        };
      }

      // Verificar que sea un número entero
      if (!Number.isInteger(stock)) {
        return {
          isValid: false,
          value: 0,
          error: "Stock debe ser un número entero",
        };
      }

      return { isValid: true, value: stock };
    }

    // ============================================
    // FUNCIÓN: Validar texto general
    // Verifica longitud y caracteres seguros
    // ============================================
    function validateText(
      text: string,
      fieldName: string,
      minLength: number,
      maxLength: number,
      allowSpecialChars: boolean = false,
    ): { isValid: boolean; value: string; error?: string } {
      if (!text || typeof text !== "string") {
        return {
          isValid: false,
          value: "",
          error: `${fieldName} es requerido`,
        };
      }

      const trimmedText = text.trim();

      // Verificar longitud mínima
      if (trimmedText.length < minLength) {
        return {
          isValid: false,
          value: "",
          error: `${fieldName} debe tener al menos ${minLength} caracteres`,
        };
      }

      // Verificar longitud máxima
      if (trimmedText.length > maxLength) {
        return {
          isValid: false,
          value: "",
          error: `${fieldName} no puede exceder ${maxLength} caracteres`,
        };
      }

      // Detectar posibles inyecciones de script
      if (VALIDATION_CONFIG.PATTERNS.SCRIPT_INJECTION.test(trimmedText)) {
        console.warn(
          `[SEGURIDAD] Intento de inyección de script detectado en ${fieldName}`,
        );
        return {
          isValid: false,
          value: "",
          error: `${fieldName} contiene contenido no permitido`,
        };
      }

      // Detectar HTML peligroso
      if (VALIDATION_CONFIG.PATTERNS.HTML_INJECTION.test(trimmedText)) {
        console.warn(
          `[SEGURIDAD] Intento de inyección HTML detectado en ${fieldName}`,
        );
        return {
          isValid: false,
          value: "",
          error: `${fieldName} contiene HTML no permitido`,
        };
      }

      // Si no permite caracteres especiales, validar contra patrón seguro
      if (
        !allowSpecialChars &&
        !VALIDATION_CONFIG.PATTERNS.SAFE_TEXT.test(trimmedText)
      ) {
        return {
          isValid: false,
          value: "",
          error: `${fieldName} contiene caracteres no permitidos`,
        };
      }

      return { isValid: true, value: sanitizeText(trimmedText) };
    }

    // ============================================
    // FUNCIÓN: Validar categoría
    // Verifica que sea una categoría válida de la colección categories
    // ============================================
    function validateCategory(category: string): {
      isValid: boolean;
      error?: string;
    } {
      if (!category || typeof category !== "string") {
        return { isValid: false, error: "Categoría es requerida" };
      }

      // Validar contra las categorías cargadas desde Firebase
      const categoryNames = categorias.map(c => c.name);
      if (!categoryNames.includes(category)) {
        console.warn(`[SEGURIDAD] Categoría no válida intentada: ${category}`);
        return {
          isValid: false,
          error: "Categoría no válida. Seleccione una categoría de la lista",
        };
      }

      return { isValid: true };
    }

    // ============================================
    // FUNCIÓN: Validar nombre de categoría
    // Verifica longitud y caracteres seguros para nueva categoría
    // ============================================
    function validateCategoryName(name: string): {
      isValid: boolean;
      value: string;
      error?: string;
    } {
      if (!name || typeof name !== "string") {
        return { isValid: false, value: "", error: "Nombre de categoría es requerido" };
      }

      const trimmedName = name.trim();

      // Verificar longitud mínima
      if (trimmedName.length < VALIDATION_CONFIG.CATEGORY_NAME_MIN_LENGTH) {
        return {
          isValid: false,
          value: "",
          error: `Nombre debe tener al menos ${VALIDATION_CONFIG.CATEGORY_NAME_MIN_LENGTH} caracteres`,
        };
      }

      // Verificar longitud máxima
      if (trimmedName.length > VALIDATION_CONFIG.CATEGORY_NAME_MAX_LENGTH) {
        return {
          isValid: false,
          value: "",
          error: `Nombre no puede exceder ${VALIDATION_CONFIG.CATEGORY_NAME_MAX_LENGTH} caracteres`,
        };
      }

      // Detectar posibles inyecciones de script (XSS)
      if (VALIDATION_CONFIG.PATTERNS.SCRIPT_INJECTION.test(trimmedName)) {
        console.warn("[SEGURIDAD] Intento de inyección de script detectado en nombre de categoría");
        return {
          isValid: false,
          value: "",
          error: "El nombre contiene contenido no permitido",
        };
      }

      // Detectar HTML peligroso
      if (VALIDATION_CONFIG.PATTERNS.HTML_INJECTION.test(trimmedName)) {
        console.warn("[SEGURIDAD] Intento de inyección HTML detectado en nombre de categoría");
        return {
          isValid: false,
          value: "",
          error: "El nombre contiene HTML no permitido",
        };
      }

      // Validar caracteres seguros
      const safePattern = /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s.,\-()]+$/;
      if (!safePattern.test(trimmedName)) {
        return {
          isValid: false,
          value: "",
          error: "El nombre contiene caracteres no permitidos",
        };
      }

      // Verificar si la categoría ya existe
      const categoryNames = categorias.map(c => c.name.toLowerCase());
      if (categoryNames.includes(trimmedName.toLowerCase())) {
        return {
          isValid: false,
          value: "",
          error: "Ya existe una categoría con este nombre",
        };
      }

      return { isValid: true, value: sanitizeText(trimmedName) };
    }

    // ============================================
    // FUNCIÓN: Validar producto completo
    // Ejecuta todas las validaciones y retorna errores
    // ============================================
    function validateProducto(data: {
      nombre: string;
      categoria: string;
      descripcion: string;
      precioRaw: string;
      stockRaw: string;
      imagen: string;
      alt: string;
    }): ValidationResult {
      const errors: string[] = [];

      // Validar nombre
      const nombreValidation = validateText(
        data.nombre,
        "Nombre",
        VALIDATION_CONFIG.NAME_MIN_LENGTH,
        VALIDATION_CONFIG.NAME_MAX_LENGTH,
      );
      if (!nombreValidation.isValid) errors.push(nombreValidation.error!);

      // Validar categoría (whitelist)
      const categoriaValidation = validateCategory(data.categoria);
      if (!categoriaValidation.isValid) errors.push(categoriaValidation.error!);

      // Validar descripción (permitir más caracteres especiales)
      const descripcionValidation = validateText(
        data.descripcion,
        "Descripción",
        VALIDATION_CONFIG.DESCRIPTION_MIN_LENGTH,
        VALIDATION_CONFIG.DESCRIPTION_MAX_LENGTH,
        true, // Permitir caracteres especiales en descripción
      );
      if (!descripcionValidation.isValid)
        errors.push(descripcionValidation.error!);

      // Validar precio
      const precioValidation = validatePrice(data.precioRaw);
      if (!precioValidation.isValid) errors.push(precioValidation.error!);

      // Validar stock
      const stockValidation = validateStock(data.stockRaw);
      if (!stockValidation.isValid) errors.push(stockValidation.error!);

      // Validar URL de imagen
      const imagenValidation = validateUrl(data.imagen);
      if (!imagenValidation.isValid)
        errors.push(`Imagen: ${imagenValidation.error}`);

      // Validar texto alternativo
      const altValidation = validateText(
        data.alt,
        "Texto alternativo",
        VALIDATION_CONFIG.ALT_MIN_LENGTH,
        VALIDATION_CONFIG.ALT_MAX_LENGTH,
      );
      if (!altValidation.isValid) errors.push(altValidation.error!);

      return {
        isValid: errors.length === 0,
        errors,
      };
    }

    // ============================================
    // FUNCIÓN: Mostrar errores de validación
    // Muestra los errores en un modal estilizado acorde a la UI
    // ============================================
    function showValidationErrors(errors: string[]): void {
      // Crear el contenedor del modal si no existe
      let modalContainer = document.getElementById("validationErrorModal");
      if (!modalContainer) {
        modalContainer = document.createElement("div");
        modalContainer.id = "validationErrorModal";
        modalContainer.className = "modal fade";
        modalContainer.setAttribute("tabindex", "-1");
        modalContainer.setAttribute("aria-hidden", "true");
        modalContainer.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
              <div class="modal-header border-0 bg-danger bg-opacity-10">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-danger bg-opacity-25 p-2 me-3">
                    <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
                  </div>
                  <h5 class="modal-title fw-bold text-danger mb-0">
                    Error de Validación
                  </h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body py-4">
                <p class="text-muted mb-3">Por favor corrige los siguientes errores:</p>
                <div id="validationErrorList" class="validation-error-list"></div>
              </div>
              <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-danger px-4" data-bs-dismiss="modal">
                  <i class="bi bi-check-lg me-2"></i>Entendido
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modalContainer);
      }

      // Generar lista de errores con iconos
      const errorListHtml = errors
        .map(
          (error) => `
        <div class="d-flex align-items-start mb-2 p-2 bg-light rounded">
          <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
          <span class="text-dark">${error}</span>
        </div>
      `,
        )
        .join("");

      const errorListEl = document.getElementById("validationErrorList");
      if (errorListEl) {
        errorListEl.innerHTML = errorListHtml;
      }

      // Mostrar el modal
      const modal = new bootstrap.Modal(modalContainer);
      modal.show();

      // Log para debugging
      console.warn("[VALIDACIÓN] Errores mostrados:", errors);
    }

    // ============================================
    // FUNCIÓN: Mostrar toast de éxito/info/warning
    // Toast estilizado con animaciones y diferentes tipos
    // ============================================
    function showToast(
      message: string,
      type: "success" | "info" | "warning" | "danger" = "info",
    ) {
      // Configuración de iconos y colores según tipo
      const config = {
        success: {
          icon: "bi-check-circle-fill",
          bg: "bg-success",
          title: "Éxito",
        },
        info: {
          icon: "bi-info-circle-fill",
          bg: "bg-info",
          title: "Información",
        },
        warning: {
          icon: "bi-exclamation-triangle-fill",
          bg: "bg-warning",
          title: "Advertencia",
        },
        danger: { icon: "bi-x-circle-fill", bg: "bg-danger", title: "Error" },
      };

      const { icon, bg, title } = config[type];

      // Crear contenedor de toasts si no existe
      let toastContainer = document.getElementById("toast-container");
      if (!toastContainer) {
        toastContainer = document.createElement("div");
        toastContainer.id = "toast-container";
        toastContainer.className = "position-fixed top-0 end-0 p-3";
        toastContainer.style.zIndex = "9999";
        document.body.appendChild(toastContainer);
      }

      // Crear el toast
      const toastId = `toast-${Date.now()}`;
      const toastEl = document.createElement("div");
      toastEl.id = toastId;
      toastEl.className = "toast show border-0 shadow-lg";
      toastEl.setAttribute("role", "alert");
      toastEl.style.animation = "slideInRight 0.3s ease-out";
      toastEl.innerHTML = `
        <div class="toast-header ${bg} bg-opacity-10 border-0">
          <i class="bi ${icon} ${bg.replace("bg-", "text-")} me-2"></i>
          <strong class="me-auto ${bg.replace("bg-", "text-")}">${title}</strong>
          <small class="text-muted">Ahora</small>
          <button type="button" class="btn-close" onclick="this.closest('.toast').remove()"></button>
        </div>
        <div class="toast-body">
          ${message}
        </div>
      `;

      toastContainer.appendChild(toastEl);

      // Auto-remover después de 4 segundos con animación de salida
      setTimeout(() => {
        toastEl.style.animation = "slideOutRight 0.3s ease-in";
        setTimeout(() => toastEl.remove(), 300);
      }, 4000);
    }

    // ============================================
    // FUNCIÓN: Mostrar alerta inline en el formulario
    // Para feedback inmediato en campos específicos
    // ============================================
    function showFieldError(fieldId: string, message: string): void {
      const field = document.getElementById(fieldId);
      if (!field) return;

      // Agregar clase de error al campo
      field.classList.add("is-invalid");

      // Crear mensaje de error si no existe
      let errorDiv = field.parentElement?.querySelector(".invalid-feedback");
      if (!errorDiv) {
        errorDiv = document.createElement("div");
        errorDiv.className = "invalid-feedback";
        field.parentElement?.appendChild(errorDiv);
      }
      errorDiv.textContent = message;
    }

    // ============================================
    // FUNCIÓN: Limpiar errores de campos
    // ============================================
    function clearFieldErrors(): void {
      document.querySelectorAll(".is-invalid").forEach((el) => {
        el.classList.remove("is-invalid");
      });
    }

    // ============================================
    // COLECCIÓN DE CATEGORÍAS
    // ============================================
    const categoriesCollection = collection(db, "categories");
    const categoriesQuery = query(categoriesCollection, orderBy("name"));

    // ============================================
    // FUNCIÓN: Renderizar opciones de categorías en selectores
    // Actualiza todos los selectores de categorías con las categorías cargadas
    // ============================================
    function renderCategoryOptions(): void {
      // Actualizar selector del formulario
      const categoriaSelect = document.getElementById("categoria") as HTMLSelectElement;
      if (categoriaSelect) {
        // Mantener la opción vacía inicial
        categoriaSelect.innerHTML = '<option value="">Seleccionar...</option>';
        categorias.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          categoriaSelect.appendChild(option);
        });
      }

      // Actualizar filtro de categorías
      const categoryFilter = document.getElementById("categoryFilter") as HTMLSelectElement;
      if (categoryFilter) {
        categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
        categorias.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          categoryFilter.appendChild(option);
        });
      }

      // Actualizar contador de categorías en estadísticas
      const categoriasCount = document.getElementById("categorias");
      if (categoriasCount) {
        categoriasCount.textContent = categorias.length.toString();
      }
      
      // Actualizar lista de categorías en el modal de gestión
      renderCategoriasList();
    }

    // ============================================
    // CATEGORÍAS POR DEFECTO
    // Se crean si la colección está vacía
    // ============================================
    const DEFAULT_CATEGORIES = ["Pizza", "Ensalada", "Bebidas", "Desayuno", "Carnes"];

    // ============================================
    // FUNCIÓN: Crear categorías por defecto
    // Se ejecuta solo si no hay categorías en Firebase
    // ============================================
    async function createDefaultCategories(): Promise<void> {
      const currentUser = auth.currentUser;
      if (!currentUser) {
        console.warn("[CATEGORÍAS] No hay usuario autenticado para crear categorías por defecto");
        return;
      }

      console.log("[CATEGORÍAS] Creando categorías por defecto...");
      
      for (const categoryName of DEFAULT_CATEGORIES) {
        try {
          await addDoc(categoriesCollection, {
            name: categoryName,
            createdAt: serverTimestamp(),
            createdBy: currentUser.uid,
          });
          console.log(`[CATEGORÍAS] Categoría "${categoryName}" creada`);
        } catch (error) {
          console.error(`[CATEGORÍAS] Error al crear categoría "${categoryName}":`, error);
        }
      }
      
      showToast("Categorías por defecto creadas exitosamente", "success");
    }

    // ============================================
    // LISTENER: Cargar categorías en tiempo real
    // ============================================
    onSnapshot(categoriesQuery, (snapshot) => {
      categorias = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as Category[];
      
      // Renderizar opciones en selectores
      renderCategoryOptions();
      
      // Si no hay categorías, crear las por defecto
      if (categorias.length === 0) {
        console.log("[CATEGORÍAS] No hay categorías, creando por defecto...");
        createDefaultCategories();
      }
      
      console.log(`[CATEGORÍAS] Cargadas ${categorias.length} categorías desde Firebase`);
    });

    // ============================================
    // FUNCIÓN: Abrir modal de nueva categoría
    // ============================================
    function openCategoriaModal(): void {
      // Limpiar el formulario
      const form = document.getElementById("categoriaForm") as HTMLFormElement;
      if (form) {
        form.reset();
      }
      
      // Limpiar errores previos
      clearFieldErrors();
      
      console.log("[CATEGORÍAS] Modal de nueva categoría abierto");
    }

    // ============================================
    // FUNCIÓN: Guardar categoría en Firebase
    // Incluye validación XSS y seguridad
    // ============================================
    async function saveCategoria(): Promise<void> {
      try {
        // Obtener el valor del input
        const nombreInput = document.getElementById("categoriaNombre") as HTMLInputElement;
        if (!nombreInput) {
          showToast("Error: No se encontró el campo de nombre", "danger");
          return;
        }

        const nombreRaw = nombreInput.value;

        // Validar el nombre de la categoría (incluye sanitización XSS)
        const validation = validateCategoryName(nombreRaw);
        if (!validation.isValid) {
          showValidationErrors([validation.error!]);
          nombreInput.classList.add("is-invalid");
          return;
        }

        // Verificar que el usuario esté autenticado
        const currentUser = auth.currentUser;
        if (!currentUser) {
          showToast("Error: Debes iniciar sesión para crear categorías", "danger");
          return;
        }

        // Crear el documento de categoría
        const categoriaData = {
          name: validation.value,
          createdAt: serverTimestamp(),
          createdBy: currentUser.uid,
        };

        console.log("[CATEGORÍAS] Guardando categoría:", categoriaData);

        // Guardar en Firebase
        await addDoc(categoriesCollection, categoriaData);

        // Cerrar el modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("categoriaModal"));
        if (modal) {
          modal.hide();
        }

        // Mostrar toast de éxito
        showToast(`Categoría "${validation.value}" creada exitosamente`, "success");

        // Limpiar el formulario
        nombreInput.value = "";
        nombreInput.classList.remove("is-invalid");

      } catch (error) {
        console.error("[CATEGORÍAS] Error al guardar categoría:", error);
        showToast("Error al guardar la categoría. Verifica tus permisos.", "danger");
      }
    }

    // ============================================
    // FUNCIÓN: Renderizar lista de categorías en el modal
    // ============================================
    function renderCategoriasList(): void {
      const container = document.getElementById("categoriasListContainer");
      const countBadge = document.getElementById("categoriasCountBadge");
      
      if (!container) return;
      
      // Actualizar badge de conteo
      if (countBadge) {
        countBadge.textContent = categorias.length.toString();
      }
      
      if (categorias.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            <small>No hay categorías creadas</small>
          </div>
        `;
        return;
      }
      
      container.innerHTML = categorias
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(cat => `
          <div class="d-flex justify-content-between align-items-center py-2 px-3 border-bottom hover-bg-light">
            <div class="d-flex align-items-center">
              <i class="bi bi-tag me-2 text-primary"></i>
              <span>${cat.name}</span>
            </div>
            <button 
              class="btn btn-sm btn-outline-danger" 
              onclick="deleteCategoria('${cat.id}')"
              title="Eliminar categoría"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `).join("");
    }

    // ============================================
    // FUNCIÓN: Iniciar eliminación de categoría
    // Muestra modal de confirmación
    // ============================================
    function deleteCategoria(id: string): void {
      const categoria = categorias.find(c => c.id === id);
      if (!categoria) return;
      
      deleteCategoriaId = id;
      
      const nameEl = document.getElementById("deleteCategoriaName");
      if (nameEl) {
        nameEl.textContent = categoria.name;
      }
      
      const modal = new bootstrap.Modal(document.getElementById("deleteCategoriaModal"));
      modal.show();
    }

    // ============================================
    // FUNCIÓN: Confirmar eliminación de categoría
    // Elimina la categoría de Firebase
    // ============================================
    async function confirmDeleteCategoria(): Promise<void> {
      if (!deleteCategoriaId) return;
      
      try {
        const categoria = categorias.find(c => c.id === deleteCategoriaId);
        const categoriaName = categoria?.name || "Categoría";
        
        // Eliminar de Firebase
        await deleteDoc(doc(db, "categories", deleteCategoriaId));
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("deleteCategoriaModal"));
        if (modal) {
          modal.hide();
        }
        
        showToast(`Categoría "${categoriaName}" eliminada exitosamente`, "success");
        console.log(`[CATEGORÍAS] Categoría "${categoriaName}" eliminada`);
        
        deleteCategoriaId = null;
        
      } catch (error) {
        console.error("[CATEGORÍAS] Error al eliminar categoría:", error);
        showToast("Error al eliminar la categoría. Verifica tus permisos.", "danger");
      }
    }

    // Exponer funciones de categorías al scope global
    window.openCategoriaModal = openCategoriaModal;
    window.saveCategoria = saveCategoria;
    window.deleteCategoria = deleteCategoria;
    window.confirmDeleteCategoria = confirmDeleteCategoria;

    // Paginación
    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;

    onSnapshot(q, (snapshot) => {
      productos = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as Product[];
      filteredProducts = [...productos];
      currentPage = 1;
      renderTable();
      updateStats();
    });

    // Obtener badge de estado según activo y stock
    function getEstadoBadge(producto: Product): string {
      if (!producto.activo) {
        return '<span class="badge bg-secondary">Inactivo</span>';
      }
      if (producto.stock <= 0) {
        return '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Sin Stock</span>';
      }
      return '<span class="badge bg-success">Activo</span>';
    }

    // Renderizar tabla
    function renderTable(productList: Product[] = filteredProducts) {
      const tbody = document.getElementById(
        "productosTableBody",
      ) as HTMLTableSectionElement;
      if (!tbody) return;
      tbody.innerHTML = "";

      // Calcular paginación
      const totalPages = Math.ceil(productList.length / ITEMS_PER_PAGE);
      const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const paginatedProducts = productList.slice(startIndex, endIndex);

      paginatedProducts.forEach((producto) => {
        const tr = document.createElement("tr");
        const stockClass =
          producto.stock < 20
            ? "bg-danger"
            : producto.stock < 50
              ? "bg-warning"
              : "bg-success";

        tr.innerHTML = `
          <td class="px-4">
            <input type="checkbox" class="form-check-input product-checkbox" value="${producto.id}" />
          </td>
          <td class="px-4">
            <img src="${producto.image}" alt="${producto.alt}" class="product-img" width="60" height="60" style="width:60px;height:60px;max-width:60px;max-height:60px;object-fit:cover;" />
          </td>
          <td class="px-4">
            <div class="fw-semibold text-dark">${producto.name}</div>
            ${producto.destacado ? '<span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> Destacado</span>' : ""}
          </td>
          <td class="px-4">
            <span class="badge bg-primary">${producto.categoria}</span>
          </td>
          <td class="px-4">
            <span class="fw-bold text-success">${producto.price}</span>
          </td>
          <td class="px-4">
            <span class="badge ${stockClass} stock-badge">${producto.stock} uds</span>
          </td>
          <td class="px-4">
            ${getEstadoBadge(producto)}
          </td>
          <td class="px-4 text-end">
            <button class="btn btn-sm btn-action btn-outline-primary me-1" onclick="window.viewProducto('${producto.id}')" title="Ver">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-warning me-1" onclick="window.editProducto('${producto.id}')" title="Editar">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-action btn-outline-danger" onclick="window.deleteProducto('${producto.id}')" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update counts
      const showingCount = document.getElementById("showing-count");
      const totalCount = document.getElementById("total-count");
      if (showingCount)
        showingCount.textContent = paginatedProducts.length.toString();
      if (totalCount) totalCount.textContent = productList.length.toString();

      // Render pagination
      renderPagination(totalPages);
    }

    // Renderizar paginación
    function renderPagination(totalPages: number) {
      const container = document.getElementById("pagination-container");
      if (!container) return;

      container.innerHTML = "";

      if (totalPages <= 1) return;

      // Botón Anterior
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
      prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a>`;
      container.appendChild(prevLi);

      // Números de página
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${currentPage === i ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        container.appendChild(li);
      }

      // Botón Siguiente
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
      nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Siguiente</a>`;
      container.appendChild(nextLi);

      // Event listeners
      container.querySelectorAll(".page-link").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const page = parseInt((e.target as HTMLElement).dataset.page || "1");
          if (page >= 1 && page <= totalPages && page !== currentPage) {
            currentPage = page;
            renderTable();
          }
        });
      });
    }

    // Actualizar estadísticas
    function updateStats() {
      const totalProductos = document.getElementById("total-productos");
      const productosActivos = document.getElementById("productos-activos");
      const categoriasElement = document.getElementById("categorias");
      const productosSinStock = document.getElementById("productos-sin-stock");

      if (totalProductos)
        totalProductos.textContent = productos.length.toString();
      if (productosActivos)
        productosActivos.textContent = productos
          .filter((p) => p.activo)
          .length.toString();

      const uniqueCategories = new Set(productos.map((p) => p.categoria));
      if (categoriasElement) categoriasElement.textContent = uniqueCategories.size.toString();

      // Contar productos sin stock (stock = 0)
      if (productosSinStock) {
        const sinStock = productos.filter((p) => p.stock <= 0).length;
        productosSinStock.textContent = sinStock.toString();
      }
    }

    // Expose functions to window
    window.openCreateModal = function () {
      editingId = null;
      const label = document.getElementById("productoModalLabel");
      const form = document.getElementById("productoForm") as HTMLFormElement;
      const activo = document.getElementById("activo") as HTMLInputElement;

      if (label) label.textContent = "Nuevo Producto";
      if (form) form.reset();
      if (activo) activo.checked = true;
    };

    window.viewProducto = function (id: string) {
      const producto = productos.find((p) => p.id === id);
      if (producto) {
        const modalBody = document.getElementById("viewModalBody");
        if (modalBody) {
          modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <img src="${producto.image}" class="img-fluid rounded" alt="${producto.alt}">
                    </div>
                    <div class="col-md-6">
                        <h4>${producto.name}</h4>
                        <p class="text-muted">${producto.categoria}</p>
                        <p>${producto.description}</p>
                        <hr>
                        <p><strong>Precio:</strong> ${producto.price}</p>
                        <p><strong>Stock:</strong> ${producto.stock}</p>
                        <p><strong>Estado:</strong> ${producto.activo ? "Activo" : "Inactivo"}</p>
                    </div>
                </div>
            `;
          const modal = new bootstrap.Modal(
            document.getElementById("viewModal"),
          );
          modal.show();
        }
      }
    };

    window.editProducto = function (id: string) {
      const producto = productos.find((p) => p.id === id);
      if (producto) {
        editingId = id;
        document.getElementById("productoModalLabel")!.textContent =
          "Editar Producto";
        (document.getElementById("nombre") as HTMLInputElement).value =
          producto.name;
        (document.getElementById("categoria") as HTMLSelectElement).value =
          producto.categoria;
        (document.getElementById("descripcion") as HTMLTextAreaElement).value =
          producto.description;
        (document.getElementById("precio") as HTMLInputElement).value =
          producto.price.replace("$", "").replace(/\./g, "");
        (document.getElementById("stock") as HTMLInputElement).value =
          producto.stock.toString();
        (document.getElementById("imagen") as HTMLInputElement).value =
          producto.image;
        (document.getElementById("alt") as HTMLInputElement).value =
          producto.alt;
        (document.getElementById("activo") as HTMLInputElement).checked =
          producto.activo;
        (document.getElementById("destacado") as HTMLInputElement).checked =
          producto.destacado;

        const modal = new bootstrap.Modal(
          document.getElementById("productoModal"),
        );
        modal.show();
      }
    };

    window.deleteProducto = function (id: string) {
      const producto = productos.find((p) => p.id === id);
      if (producto) {
        deleteId = id;
        const deleteNameEl = document.getElementById("deleteProductName");
        if (deleteNameEl) deleteNameEl.textContent = producto.name;
        const modal = new bootstrap.Modal(
          document.getElementById("deleteModal"),
        );
        modal.show();
      }
    };

    window.confirmDelete = async function () {
      if (deleteId) {
        try {
          await deleteDoc(doc(db, "products", deleteId));
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("deleteModal"),
          );
          modal.hide();
          showToast("Producto eliminado exitosamente", "success");
        } catch (e) {
          console.error("Error deleting document: ", e);
          alert("Error al eliminar el producto");
        }
      }
    };

    // ============================================
    // FUNCIÓN: Guardar producto
    // Valida todos los campos antes de guardar en Firestore
    // ============================================
    window.saveProducto = async function () {
      // Obtener valores del formulario
      const nombre = (document.getElementById("nombre") as HTMLInputElement)
        .value;
      const categoria = (
        document.getElementById("categoria") as HTMLSelectElement
      ).value;
      const descripcion = (
        document.getElementById("descripcion") as HTMLTextAreaElement
      ).value;
      const precioRaw = (document.getElementById("precio") as HTMLInputElement)
        .value;
      const stockRaw = (document.getElementById("stock") as HTMLInputElement)
        .value;
      const imagen = (document.getElementById("imagen") as HTMLInputElement)
        .value;
      const alt = (document.getElementById("alt") as HTMLInputElement).value;
      const activo = (document.getElementById("activo") as HTMLInputElement)
        .checked;
      const destacado = (
        document.getElementById("destacado") as HTMLInputElement
      ).checked;

      // ============================================
      // VALIDACIÓN COMPLETA DEL PRODUCTO
      // Ejecutar todas las validaciones antes de guardar
      // ============================================
      const validationResult = validateProducto({
        nombre,
        categoria,
        descripcion,
        precioRaw,
        stockRaw,
        imagen,
        alt,
      });

      // Si hay errores de validación, mostrarlos y no continuar
      if (!validationResult.isValid) {
        showValidationErrors(validationResult.errors);
        console.warn(
          "[VALIDACIÓN] Errores encontrados:",
          validationResult.errors,
        );
        return;
      }

      // ============================================
      // SANITIZACIÓN DE DATOS
      // Limpiar y formatear los datos validados
      // ============================================
      const precioValidado = validatePrice(precioRaw);
      const stockValidado = validateStock(stockRaw);

      // Formatear precio con símbolo de moneda
      const precio = "$" + precioValidado.value.toLocaleString("es-CL");

      // Construir objeto de producto con datos sanitizados
      const productoData = {
        name: sanitizeText(nombre),
        categoria: categoria, // Ya validado contra whitelist
        description: sanitizeText(descripcion),
        price: precio,
        stock: stockValidado.value,
        image: imagen.trim(), // URL ya validada
        alt: sanitizeText(alt),
        activo: Boolean(activo),
        destacado: Boolean(destacado),
        updatedAt: new Date(),
        createdAt: null as Date | null,
      };

      // ============================================
      // GUARDAR EN FIRESTORE
      // Crear o actualizar según el contexto
      // ============================================
      try {
        if (editingId) {
          // Modo edición: actualizar documento existente
          // eslint-disable-next-line @typescript-eslint/no-unused-vars
          const { createdAt: _, ...updateData } = productoData;
          await updateDoc(doc(db, "products", editingId), updateData);
          showToast("Producto actualizado exitosamente", "success");
          console.log("[CRUD] Producto actualizado:", editingId);
        } else {
          // Modo creación: agregar nuevo documento
          productoData.createdAt = new Date();
          const docRef = await addDoc(productsCollection, productoData);
          showToast("Producto creado exitosamente", "success");
          console.log("[CRUD] Producto creado:", docRef.id);
        }

        // Cerrar modal después de guardar exitosamente
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("productoModal"),
        );
        modal?.hide();
      } catch (e) {
        console.error("[ERROR] Error al guardar producto:", e);
        alert("Error al guardar el producto. Por favor intente nuevamente.");
      }
    };

    // Filtros
    document.getElementById("searchInput")?.addEventListener("input", (e) => {
      const term = (e.target as HTMLInputElement).value.toLowerCase();
      filterProducts(
        term,
        (document.getElementById("categoryFilter") as HTMLSelectElement).value,
        (document.getElementById("statusFilter") as HTMLSelectElement).value,
      );
    });

    document
      .getElementById("categoryFilter")
      ?.addEventListener("change", (e) => {
        filterProducts(
          (
            document.getElementById("searchInput") as HTMLInputElement
          ).value.toLowerCase(),
          (e.target as HTMLSelectElement).value,
          (document.getElementById("statusFilter") as HTMLSelectElement).value,
        );
      });

    document.getElementById("statusFilter")?.addEventListener("change", (e) => {
      filterProducts(
        (
          document.getElementById("searchInput") as HTMLInputElement
        ).value.toLowerCase(),
        (document.getElementById("categoryFilter") as HTMLSelectElement).value,
        (e.target as HTMLSelectElement).value,
      );
    });

    function filterProducts(term: string, category: string, status: string) {
      filteredProducts = productos.filter((p) => {
        const matchesTerm =
          p.name.toLowerCase().includes(term) ||
          p.description.toLowerCase().includes(term);
        const matchesCategory = category === "" || p.categoria === category;
        const matchesStatus =
          status === "" ||
          (status === "activo" && p.activo) ||
          (status === "inactivo" && !p.activo);

        return matchesTerm && matchesCategory && matchesStatus;
      });
      currentPage = 1; // Reset a página 1 al filtrar
      renderTable(filteredProducts);
    }

    // Select all checkbox
    document.getElementById("selectAll")?.addEventListener("change", (e) => {
      const checkboxes = document.querySelectorAll(
        ".product-checkbox",
      ) as NodeListOf<HTMLInputElement>;
      checkboxes.forEach(
        (cb) => (cb.checked = (e.target as HTMLInputElement).checked),
      );
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</Layout>
