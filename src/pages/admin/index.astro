---
import Layout from "../../layouts/Layout.astro";
import "../../styles/global.css";
import AdminGuard from "../../components/admin/AdminGuard.astro";
import AdminHeader from "../../components/admin/AdminHeader.astro";
import AdminSidebar from "../../components/admin/AdminSidebar.astro";
---

<Layout title="GMExpress - Admin Dashboard">
  <AdminGuard />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />

  <div class="admin-dashboard min-vh-100">
    <!-- Sidebar -->
    <AdminSidebar activePath="/admin" />

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <AdminHeader title="Dashboard Principal" />

      <!-- Content Area -->
      <div class="p-4">
        <!-- Welcome Card -->
        <div class="card border-0 shadow-sm mb-4 welcome-card">
          <div class="card-body p-4">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h3 class="fw-bold text-white mb-2">
                  ¬°Bienvenido al Panel de Administraci√≥n! üëã
                </h3>
                <p class="text-white mb-0" style="opacity: 0.9;">
                  Aqu√≠ puedes gestionar todos los aspectos de GMExpress. Utiliza
                  el men√∫ lateral para navegar.
                </p>
              </div>
              <div class="col-md-4 text-end">
                <i
                  class="bi bi-graph-up-arrow text-white"
                  style="font-size: 4rem; opacity: 0.2;"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-box-seam text-primary fs-3"></i>
                  </div>
                  <span class="badge bg-success">+8%</span>
                </div>
                <h2 class="fw-bold mb-1" id="total-products-count">...</h2>
                <p class="text-muted mb-0 small">Total Productos</p>
                <a
                  href="/admin/productos"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-gear text-success fs-3"></i>
                  </div>
                  <span class="badge bg-primary">+12%</span>
                </div>
                <h2 class="fw-bold mb-1" id="total-services-count">...</h2>
                <p class="text-muted mb-0 small">Total Servicios</p>
                <a
                  href="/admin/servicios"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-people text-warning fs-3"></i>
                  </div>
                  <span class="badge bg-info" id="users-badge">...</span>
                </div>
                <h2 class="fw-bold mb-1" id="total-users-count">...</h2>
                <p class="text-muted mb-0 small">Usuarios Registrados</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-cart-check text-info fs-3"></i>
                  </div>
                  <span
                    class="badge bg-warning text-dark"
                    id="pedidos-pendientes-badge">...</span
                  >
                </div>
                <h2 class="fw-bold mb-1" id="total-pedidos-mes">...</h2>
                <p class="text-muted mb-0 small">Pedidos del Mes</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts and Activity Row -->
        <div class="row g-3 mb-4">
          <!-- Sales Chart -->
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-4"
                >
                  <h5 class="fw-bold mb-0">Ventas del Mes</h5>
                  <div class="btn-group btn-group-sm" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-secondary active">Semana</button
                    >
                    <button type="button" class="btn btn-outline-secondary"
                      >Mes</button
                    >
                    <button type="button" class="btn btn-outline-secondary"
                      >A√±o</button
                    >
                  </div>
                </div>
                <canvas id="salesChart" height="100"></canvas>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5 class="fw-bold mb-4">Actividad Reciente</h5>
                <div class="activity-list" id="activity-list">
                  <!-- Se carga din√°micamente -->
                  <div class="text-center py-4 text-muted">
                    <div
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                    >
                    </div>
                    <small>Cargando actividad...</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Products and Quick Actions -->
        <div class="row g-3">
          <!-- Top Products -->
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="fw-bold mb-4">Productos M√°s Vendidos</h5>
                <div class="table-responsive">
                  <table class="table table-sm table-borderless">
                    <tbody id="top-products-list">
                      <!-- Se carga din√°micamente -->
                      <tr>
                        <td colspan="2" class="text-center py-4 text-muted">
                          <div
                            class="spinner-border spinner-border-sm me-2"
                            role="status"
                          >
                          </div>
                          <small>Cargando productos...</small>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="fw-bold mb-4">Acciones R√°pidas</h5>
                <div class="row g-2">
                  <div class="col-6">
                    <a
                      href="/admin/productos"
                      class="btn btn-outline-primary w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-plus-circle fs-4 mb-2"></i>
                      <span class="small">Nuevo Producto</span>
                    </a>
                  </div>
                  <div class="col-6">
                    <a
                      href="/admin/servicios"
                      class="btn btn-outline-success w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-gear-fill fs-4 mb-2"></i>
                      <span class="small">Nuevo Servicio</span>
                    </a>
                  </div>
                  <div class="col-6">
                    <button
                      class="btn btn-outline-warning w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-file-earmark-bar-graph fs-4 mb-2"></i>
                      <span class="small">Ver Reportes</span>
                    </button>
                  </div>
                  <div class="col-6">
                    <button
                      class="btn btn-outline-info w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-gear fs-4 mb-2"></i>
                      <span class="small">Configuraci√≥n</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-dashboard {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .hover-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .active-link {
      background-color: #79c043 !important;
      color: white !important;
    }

    .active-link:hover {
      background-color: #6ab03a !important;
    }

    .welcome-card {
      background: linear-gradient(135deg, #1a2e3d 0%, #0a1929 100%);
    }

    .card-hover {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .card {
      transition: all 0.3s ease;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <script>
    import { db } from "../../firebase/client";
    import {
      collection,
      onSnapshot,
      query,
      orderBy,
      limit,
    } from "firebase/firestore";

    // ============================================
    // ESTAD√çSTICAS EN TIEMPO REAL
    // ============================================

    const productsCol = collection(db, "products");
    const servicesCol = collection(db, "services");
    const usersCol = collection(db, "users");
    const pedidosCol = collection(db, "pedidos");
    const notificationsCol = collection(db, "notifications");

    // Contador de productos
    onSnapshot(productsCol, (snap) => {
      const count = document.getElementById("total-products-count");
      if (count) count.textContent = snap.size.toString();
    });

    // Contador de servicios
    onSnapshot(servicesCol, (snap) => {
      const count = document.getElementById("total-services-count");
      if (count) count.textContent = snap.size.toString();
    });

    // Contador de usuarios
    onSnapshot(usersCol, (snap) => {
      const count = document.getElementById("total-users-count");
      const badge = document.getElementById("users-badge");
      if (count) count.textContent = snap.size.toString();
      if (badge) badge.textContent = `+${snap.size}`;
    });

    // Pedidos del mes
    onSnapshot(pedidosCol, (snap) => {
      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      // Filtrar pedidos del mes actual
      const pedidosDelMes = snap.docs.filter((doc) => {
        const data = doc.data();
        const fecha = data.createdAt?.toDate?.() || new Date(data.fecha);
        return fecha >= firstDayOfMonth;
      });

      // Contar pedidos pendientes (no Recibidos)
      const pendientes = snap.docs.filter(
        (doc) => doc.data().estado !== "Recibido",
      ).length;

      const countEl = document.getElementById("total-pedidos-mes");
      const badgeEl = document.getElementById("pedidos-pendientes-badge");

      if (countEl) countEl.textContent = pedidosDelMes.length.toString();
      if (badgeEl) {
        badgeEl.textContent = pendientes.toString();
        badgeEl.className =
          "badge text-dark " + (pendientes > 0 ? "bg-warning" : "bg-secondary");
      }
    });

    // ============================================
    // ACTIVIDAD RECIENTE (desde notificaciones)
    // ============================================

    const qNotifications = query(
      notificationsCol,
      orderBy("createdAt", "desc"),
      limit(5),
    );

    onSnapshot(
      qNotifications,
      (snap) => {
        const activityList = document.getElementById("activity-list");
        if (!activityList) return;

        if (snap.empty) {
          activityList.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            <small>No hay actividad reciente</small>
          </div>
        `;
          return;
        }

        activityList.innerHTML = snap.docs
          .map((doc, index) => {
            const data = doc.data();
            const isLast = index === snap.docs.length - 1;

            // Determinar icono y color seg√∫n tipo/t√≠tulo
            let iconClass = "bi-info-circle text-info";
            let bgClass = "bg-info";

            if (
              data.title?.includes("Pedido") ||
              data.title?.includes("pedido")
            ) {
              iconClass = "bi-cart-check text-success";
              bgClass = "bg-success";
            } else if (data.title?.includes("Solicitud")) {
              iconClass = "bi-envelope-paper text-warning";
              bgClass = "bg-warning";
            } else if (
              data.title?.includes("Usuario") ||
              data.title?.includes("usuario")
            ) {
              iconClass = "bi-person-plus text-primary";
              bgClass = "bg-primary";
            } else if (data.title?.includes("Producto")) {
              iconClass = "bi-box-seam text-primary";
              bgClass = "bg-primary";
            } else if (data.title?.includes("Error") || data.type === "error") {
              iconClass = "bi-exclamation-triangle text-danger";
              bgClass = "bg-danger";
            }

            return `
          <div class="activity-item ${!isLast ? "mb-3 pb-3 border-bottom" : ""}">
            <div class="d-flex align-items-start gap-3">
              <div class="rounded-circle ${bgClass} bg-opacity-10 p-2">
                <i class="bi ${iconClass}"></i>
              </div>
              <div class="flex-grow-1">
                <p class="mb-1 small fw-semibold">${data.title || "Actividad"}</p>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">
                  ${formatTimeAgo(data.createdAt?.toDate?.())}
                </p>
              </div>
            </div>
          </div>
        `;
          })
          .join("");
      },
      (error) => {
        console.error("Error cargando actividad:", error);
        const activityList = document.getElementById("activity-list");
        if (activityList) {
          activityList.innerHTML = `
          <div class="text-center py-4 text-danger">
            <small>Error al cargar actividad</small>
          </div>
        `;
        }
      },
    );

    // ============================================
    // PRODUCTOS M√ÅS VENDIDOS (calculados desde pedidos)
    // ============================================

    onSnapshot(
      pedidosCol,
      (snap) => {
        const topProductsList = document.getElementById("top-products-list");
        if (!topProductsList) return;

        // Contar ventas por producto
        interface ProductoEnPedido {
          nombre?: string;
          name?: string;
          cantidad?: number;
          quantity?: number;
        }
        const ventasPorProducto: Record<
          string,
          { nombre: string; cantidad: number }
        > = {};

        snap.docs.forEach((doc) => {
          const productos: ProductoEnPedido[] = doc.data().productos || [];
          productos.forEach((p) => {
            const nombre = p.nombre || p.name || "Producto";
            if (!ventasPorProducto[nombre]) {
              ventasPorProducto[nombre] = { nombre, cantidad: 0 };
            }
            ventasPorProducto[nombre].cantidad += p.cantidad || p.quantity || 1;
          });
        });

        // Ordenar y tomar top 4
        const topProducts = Object.values(ventasPorProducto)
          .sort((a, b) => b.cantidad - a.cantidad)
          .slice(0, 4);

        if (topProducts.length === 0) {
          topProductsList.innerHTML = `
          <tr>
            <td colspan="2" class="text-center py-4 text-muted">
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              <small>No hay ventas registradas</small>
            </td>
          </tr>
        `;
          return;
        }

        const colors = ["primary", "success", "warning", "info"];

        topProductsList.innerHTML = topProducts
          .map(
            (product, index) => `
        <tr>
          <td class="py-2">
            <div class="d-flex align-items-center gap-2">
              <div
                class="bg-${colors[index]} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                style="width: 32px; height: 32px;"
              >
                <span class="fw-bold text-${colors[index]} small">${index + 1}</span>
              </div>
              <span class="fw-semibold">${product.nombre}</span>
            </div>
          </td>
          <td class="py-2 text-end">
            <span class="badge bg-success">${product.cantidad} ventas</span>
          </td>
        </tr>
      `,
          )
          .join("");
      },
      (error) => {
        console.error("Error cargando productos:", error);
      },
    );

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    function formatTimeAgo(date: Date | undefined): string {
      if (!date) return "Reci√©n";
      const now = new Date();
      const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

      if (diff < 60) return "Hace un momento";
      if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
      if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
      if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} d√≠as`;

      return date.toLocaleDateString("es-CL");
    }

    // Mock chart data (kept for visual consistency)
    document.addEventListener("DOMContentLoaded", function () {
      const ctx = document.getElementById("salesChart") as HTMLCanvasElement;
      if (ctx) {
        const data = [12, 19, 15, 22, 18, 25, 20];
        const labels = ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"];
        const canvas = ctx.getContext("2d");
        if (canvas) {
          canvas.fillStyle = "#79c043";
          const barWidth = ctx.width / data.length;
          const maxValue = Math.max(...data);

          data.forEach((value, index) => {
            const barHeight = (value / maxValue) * (ctx.height - 40);
            const x = index * barWidth + 10;
            const y = ctx.height - barHeight - 20;
            canvas.fillRect(x, y, barWidth - 20, barHeight);
            canvas.fillStyle = "#666";
            canvas.font = "12px Arial";
            canvas.fillText(labels[index], x + 5, ctx.height - 5);
            canvas.fillStyle = "#79c043";
          });
        }
      }
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</Layout>
