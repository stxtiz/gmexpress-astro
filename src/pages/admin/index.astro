---
import Layout from "../../layouts/Layout.astro";
import "../../styles/global.css";
import AdminGuard from "../../components/admin/AdminGuard.astro";
import AdminHeader from "../../components/admin/AdminHeader.astro";
import AdminSidebar from "../../components/admin/AdminSidebar.astro";
---

<Layout title="GMExpress - Admin Dashboard">
  <AdminGuard />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
  />

  <div class="admin-dashboard min-vh-100">
    <!-- Sidebar -->
    <AdminSidebar activePath="/admin" />

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <AdminHeader title="Dashboard Principal" />

      <!-- Content Area -->
      <div class="p-4">
        <!-- Welcome Card -->
        <div class="card border-0 shadow-sm mb-4 welcome-card">
          <div class="card-body p-4">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h3 class="fw-bold text-white mb-2">
                  춰Bienvenido al Panel de Administraci칩n! 游녦
                </h3>
                <p class="text-white mb-0" style="opacity: 0.9;">
                  Aqu칤 puedes gestionar todos los aspectos de GMExpress. Utiliza
                  el men칰 lateral para navegar.
                </p>
              </div>
              <div class="col-md-4 text-end">
                <i
                  class="bi bi-graph-up-arrow text-white"
                  style="font-size: 4rem; opacity: 0.2;"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-box-seam text-primary fs-3"></i>
                  </div>
                </div>
                <h2 class="fw-bold mb-1" id="total-products-count">...</h2>
                <p class="text-muted mb-0 small">Total Productos</p>
                <a
                  href="/admin/productos"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-gear text-success fs-3"></i>
                  </div>
                </div>
                <h2 class="fw-bold mb-1" id="total-services-count">...</h2>
                <p class="text-muted mb-0 small">Total Servicios</p>
                <a
                  href="/admin/servicios"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-people text-warning fs-3"></i>
                  </div>
                </div>
                <h2 class="fw-bold mb-1" id="total-users-count">...</h2>
                <p class="text-muted mb-0 small">Usuarios Registrados</p>
                <a
                  href="/admin/usuarios"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 card-hover">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-cart-check text-info fs-3"></i>
                  </div>
                </div>
                <h2 class="fw-bold mb-1" id="total-pedidos-mes">...</h2>
                <p class="text-muted mb-0 small">Pedidos del Mes</p>
                <a
                  href="/admin/pedidos"
                  class="stretched-link text-decoration-none"></a>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts and Activity Row -->
        <div class="row g-3 mb-4">
          <!-- Sales Chart -->
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <!-- Header con t칤tulo y controles -->
                <div
                  class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"
                >
                  <h5 class="fw-bold mb-0">Ventas</h5>

                  <!-- Controles de tipo de gr치fico -->
                  <div
                    class="btn-group btn-group-sm me-2"
                    role="group"
                    id="chartTypeGroup"
                  >
                    <button
                      type="button"
                      class="btn btn-outline-secondary active"
                      data-chart-type="pie"
                      title="Gr치fico Pastel"
                    >
                      <i class="bi bi-pie-chart-fill"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      data-chart-type="bar"
                      title="Gr치fico Barras"
                    >
                      <i class="bi bi-bar-chart-fill"></i>
                    </button>
                  </div>

                  <!-- Filtros de tiempo -->
                  <div class="btn-group btn-group-sm" role="group" id="timeFilterGroup">
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      data-filter="day">Hoy</button
                    >
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      data-filter="week">Semana</button
                    >
                    <button
                      type="button"
                      class="btn btn-outline-secondary active"
                      data-filter="month">Mes</button
                    >
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      data-filter="year">A침o</button
                    >
                  </div>
                </div>

                <!-- Estado de carga -->
                <div id="chartLoading" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="text-muted mt-2 mb-0">Cargando datos...</p>
                </div>

                <!-- Estado de error -->
                <div id="chartError" class="text-center py-5 d-none">
                  <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                  <p class="text-danger mt-2 mb-0">Error al cargar datos</p>
                  <button
                    class="btn btn-sm btn-outline-primary mt-2"
                    id="retryChartBtn">Reintentar</button
                  >
                </div>

                <!-- Estado sin datos -->
                <div id="chartEmpty" class="text-center py-5 d-none">
                  <i class="bi bi-inbox text-muted fs-1"></i>
                  <p class="text-muted mt-2 mb-0">No hay ventas en este per칤odo</p>
                </div>

                <!-- Canvas del gr치fico -->
                <div id="chartContainer" class="d-none">
                  <canvas id="salesChart"></canvas>
                </div>

                <!-- Resumen de ganancias por estado -->
                <div id="salesSummary" class="mt-4 d-none">
                  <!-- Ganancias Reales y Estimadas -->
                  <div class="row g-2 mb-3 pb-3 border-bottom">
                    <!-- Ganancias Reales (Completados) -->
                    <div class="col-6">
                      <div class="text-center">
                        <small class="text-success text-uppercase fw-semibold" style="font-size: 0.65rem; letter-spacing: 1px;">
                          <i class="bi bi-check-circle-fill me-1"></i>Ganancias Reales
                        </small>
                        <h4 class="fw-bold text-success mb-0" id="gananciasReales">$0</h4>
                        <small class="text-muted" style="font-size: 0.7rem;"><span id="pedidosReales">0</span> completados</small>
                      </div>
                    </div>
                    <!-- Ganancia Estimada (Pendientes + En Proceso + Enviados) -->
                    <div class="col-6">
                      <div class="text-center">
                        <small class="text-primary text-uppercase fw-semibold" style="font-size: 0.65rem; letter-spacing: 1px;">
                          <i class="bi bi-graph-up-arrow me-1"></i>Ganancia Estimada
                        </small>
                        <h4 class="fw-bold text-primary mb-0" id="gananciaEstimada">$0</h4>
                        <small class="text-muted" style="font-size: 0.7rem;"><span id="pedidosEstimados">0</span> en curso</small>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Ganancias por Estado -->
                  <div class="row g-2">
                    <!-- Completados -->
                    <div class="col-6">
                      <div class="bg-success bg-opacity-10 rounded-3 p-2 text-center">
                        <div class="d-flex align-items-center justify-content-center gap-1 mb-1">
                          <i class="bi bi-check-circle-fill text-success" style="font-size: 0.8rem;"></i>
                          <small class="text-success fw-semibold" style="font-size: 0.7rem;">Completados</small>
                        </div>
                        <h5 class="fw-bold text-success mb-0" id="gananciaCompletado">$0</h5>
                        <small class="text-muted" style="font-size: 0.65rem;"><span id="cantCompletados">0</span> pedidos</small>
                      </div>
                    </div>
                    <!-- Pendientes -->
                    <div class="col-6">
                      <div class="bg-warning bg-opacity-10 rounded-3 p-2 text-center">
                        <div class="d-flex align-items-center justify-content-center gap-1 mb-1">
                          <i class="bi bi-clock-fill text-warning" style="font-size: 0.8rem;"></i>
                          <small class="text-warning fw-semibold" style="font-size: 0.7rem;">Pendientes</small>
                        </div>
                        <h5 class="fw-bold text-warning mb-0" id="gananciaPendiente">$0</h5>
                        <small class="text-muted" style="font-size: 0.65rem;"><span id="cantPendientes">0</span> pedidos</small>
                      </div>
                    </div>
                    <!-- En Proceso -->
                    <div class="col-6">
                      <div class="bg-info bg-opacity-10 rounded-3 p-2 text-center">
                        <div class="d-flex align-items-center justify-content-center gap-1 mb-1">
                          <i class="bi bi-arrow-repeat text-info" style="font-size: 0.8rem;"></i>
                          <small class="text-info fw-semibold" style="font-size: 0.7rem;">En Proceso</small>
                        </div>
                        <h5 class="fw-bold text-info mb-0" id="gananciaEnProceso">$0</h5>
                        <small class="text-muted" style="font-size: 0.65rem;"><span id="cantEnProceso">0</span> pedidos</small>
                      </div>
                    </div>
                    <!-- Enviados -->
                    <div class="col-6">
                      <div class="bg-secondary bg-opacity-10 rounded-3 p-2 text-center">
                        <div class="d-flex align-items-center justify-content-center gap-1 mb-1">
                          <i class="bi bi-truck text-secondary" style="font-size: 0.8rem;"></i>
                          <small class="text-secondary fw-semibold" style="font-size: 0.7rem;">Enviados</small>
                        </div>
                        <h5 class="fw-bold text-secondary mb-0" id="gananciaEnviado">$0</h5>
                        <small class="text-muted" style="font-size: 0.65rem;"><span id="cantEnviados">0</span> pedidos</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="fw-bold mb-3">Actividad Reciente</h5>
                <div class="activity-list" id="activity-list" style="max-height: 420px; overflow: hidden;">
                  <!-- Se carga din치micamente -->
                  <div class="text-center py-4 text-muted">
                    <div
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                    >
                    </div>
                    <small>Cargando actividad...</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Top Products and Quick Actions -->
        <div class="row g-3">
          <!-- Top Products -->
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="fw-bold mb-4">Productos M치s Vendidos</h5>
                <div class="table-responsive">
                  <table class="table table-sm table-borderless">
                    <tbody id="top-products-list">
                      <!-- Se carga din치micamente -->
                      <tr>
                        <td colspan="2" class="text-center py-4 text-muted">
                          <div
                            class="spinner-border spinner-border-sm me-2"
                            role="status"
                          >
                          </div>
                          <small>Cargando productos...</small>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="fw-bold mb-4">Acciones R치pidas</h5>
                <div class="row g-2">
                  <div class="col-6">
                    <a
                      href="/admin/productos"
                      class="btn btn-outline-primary w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-plus-circle fs-4 mb-2"></i>
                      <span class="small">Nuevo Producto</span>
                    </a>
                  </div>
                  <div class="col-6">
                    <a
                      href="/admin/servicios"
                      class="btn btn-outline-success w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-gear-fill fs-4 mb-2"></i>
                      <span class="small">Nuevo Servicio</span>
                    </a>
                  </div>
                  <div class="col-6">
                    <a
                      href="/admin/pedidos"
                      class="btn btn-outline-warning w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-file-earmark-bar-graph fs-4 mb-2"></i>
                      <span class="small">Ver Reportes</span>
                    </a>
                  </div>
                  <div class="col-6">
                    <a
                      href="/admin/usuarios"
                      class="btn btn-outline-info w-100 d-flex flex-column align-items-center py-3"
                    >
                      <i class="bi bi-person-plus fs-4 mb-2"></i>
                      <span class="small">Nuevo Usuario</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-dashboard {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .hover-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .active-link {
      background-color: #79c043 !important;
      color: white !important;
    }

    .active-link:hover {
      background-color: #6ab03a !important;
    }

    .welcome-card {
      background: linear-gradient(135deg, #1a2e3d 0%, #0a1929 100%);
    }

    .card-hover {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .card {
      transition: all 0.3s ease;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
    }

    /* Estilos para el gr치fico de ventas */
    #chartContainer {
      max-height: 280px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #chartContainer canvas {
      max-height: 280px !important;
      max-width: 100% !important;
    }

    #chartLoading,
    #chartError,
    #chartEmpty {
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Estilos para Actividad Reciente */
    .activity-item {
      transition: background-color 0.2s ease;
    }

    .activity-item:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
  </style>

  <script>
    import { db } from "../../firebase/client";
    import {
      collection,
      onSnapshot,
      query,
      orderBy,
      limit,
    } from "firebase/firestore";

    // ============================================
    // ESTAD칈STICAS EN TIEMPO REAL
    // ============================================

    const productsCol = collection(db, "products");
    const servicesCol = collection(db, "services");
    const usersCol = collection(db, "users");
    const pedidosCol = collection(db, "pedidos");
    const notificationsCol = collection(db, "notifications");

    // Contador de productos
    onSnapshot(productsCol, (snap) => {
      const count = document.getElementById("total-products-count");
      if (count) count.textContent = snap.size.toString();
    });

    // Contador de servicios
    onSnapshot(servicesCol, (snap) => {
      const count = document.getElementById("total-services-count");
      if (count) count.textContent = snap.size.toString();
    });

    // Contador de usuarios
    onSnapshot(usersCol, (snap) => {
      const count = document.getElementById("total-users-count");
      const badge = document.getElementById("users-badge");
      if (count) count.textContent = snap.size.toString();
      if (badge) badge.textContent = `+${snap.size}`;
    });

    // Pedidos del mes
    onSnapshot(pedidosCol, (snap) => {
      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      // Filtrar pedidos del mes actual
      const pedidosDelMes = snap.docs.filter((doc) => {
        const data = doc.data();
        const fecha = data.createdAt?.toDate?.() || new Date(data.fecha);
        return fecha >= firstDayOfMonth;
      });

      // Contar pedidos pendientes (no Recibidos)
      const pendientes = snap.docs.filter(
        (doc) => doc.data().estado !== "Recibido",
      ).length;

      const countEl = document.getElementById("total-pedidos-mes");
      const badgeEl = document.getElementById("pedidos-pendientes-badge");

      if (countEl) countEl.textContent = pedidosDelMes.length.toString();
      if (badgeEl) {
        badgeEl.textContent = pendientes.toString();
        badgeEl.className =
          "badge text-dark " + (pendientes > 0 ? "bg-warning" : "bg-secondary");
      }
    });

    // ============================================
    // ACTIVIDAD RECIENTE (desde notificaciones)
    // ============================================

    const qNotifications = query(
      notificationsCol,
      orderBy("createdAt", "desc"),
      limit(15),
    );

    onSnapshot(
      qNotifications,
      (snap) => {
        const activityList = document.getElementById("activity-list");
        if (!activityList) return;

        if (snap.empty) {
          activityList.innerHTML = `
          <div class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            <small>No hay actividad reciente</small>
          </div>
        `;
          return;
        }

        activityList.innerHTML = snap.docs
          .map((doc, index) => {
            const data = doc.data();
            const isLast = index === snap.docs.length - 1;

            // Determinar icono y color seg칰n tipo/t칤tulo
            let iconClass = "bi-info-circle text-info";
            let bgClass = "bg-info";

            if (
              data.title?.includes("Pedido") ||
              data.title?.includes("pedido")
            ) {
              iconClass = "bi-cart-check text-success";
              bgClass = "bg-success";
            } else if (data.title?.includes("Solicitud")) {
              iconClass = "bi-envelope-paper text-warning";
              bgClass = "bg-warning";
            } else if (
              data.title?.includes("Usuario") ||
              data.title?.includes("usuario")
            ) {
              iconClass = "bi-person-plus text-primary";
              bgClass = "bg-primary";
            } else if (data.title?.includes("Producto")) {
              iconClass = "bi-box-seam text-primary";
              bgClass = "bg-primary";
            } else if (data.title?.includes("Error") || data.type === "error") {
              iconClass = "bi-exclamation-triangle text-danger";
              bgClass = "bg-danger";
            }

            return `
          <div class="activity-item ${!isLast ? "mb-3 pb-3 border-bottom" : ""}">
            <div class="d-flex align-items-start gap-3">
              <div class="rounded-circle ${bgClass} bg-opacity-10 p-2">
                <i class="bi ${iconClass}"></i>
              </div>
              <div class="flex-grow-1">
                <p class="mb-1 small fw-semibold">${data.title || "Actividad"}</p>
                <p class="mb-0 text-muted" style="font-size: 0.75rem;">
                  ${formatTimeAgo(data.createdAt?.toDate?.())}
                </p>
              </div>
            </div>
          </div>
        `;
          })
          .join("");
      },
      (error) => {
        console.error("Error cargando actividad:", error);
        const activityList = document.getElementById("activity-list");
        if (activityList) {
          activityList.innerHTML = `
          <div class="text-center py-4 text-danger">
            <small>Error al cargar actividad</small>
          </div>
        `;
        }
      },
    );

    // ============================================
    // PRODUCTOS M츼S VENDIDOS (calculados desde pedidos)
    // ============================================

    onSnapshot(
      pedidosCol,
      (snap) => {
        const topProductsList = document.getElementById("top-products-list");
        if (!topProductsList) return;

        // Contar ventas por producto
        interface ProductoEnPedido {
          nombre?: string;
          name?: string;
          cantidad?: number;
          quantity?: number;
        }
        const ventasPorProducto: Record<
          string,
          { nombre: string; cantidad: number }
        > = {};

        snap.docs.forEach((doc) => {
          const productos: ProductoEnPedido[] = doc.data().productos || [];
          productos.forEach((p) => {
            const nombre = p.nombre || p.name || "Producto";
            if (!ventasPorProducto[nombre]) {
              ventasPorProducto[nombre] = { nombre, cantidad: 0 };
            }
            ventasPorProducto[nombre].cantidad += p.cantidad || p.quantity || 1;
          });
        });

        // Ordenar y tomar top 4
        const topProducts = Object.values(ventasPorProducto)
          .sort((a, b) => b.cantidad - a.cantidad)
          .slice(0, 4);

        if (topProducts.length === 0) {
          topProductsList.innerHTML = `
          <tr>
            <td colspan="2" class="text-center py-4 text-muted">
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              <small>No hay ventas registradas</small>
            </td>
          </tr>
        `;
          return;
        }

        const colors = ["primary", "success", "warning", "info"];

        topProductsList.innerHTML = topProducts
          .map(
            (product, index) => `
        <tr>
          <td class="py-2">
            <div class="d-flex align-items-center gap-2">
              <div
                class="bg-${colors[index]} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                style="width: 32px; height: 32px;"
              >
                <span class="fw-bold text-${colors[index]} small">${index + 1}</span>
              </div>
              <span class="fw-semibold">${product.nombre}</span>
            </div>
          </td>
          <td class="py-2 text-end">
            <span class="badge bg-success">${product.cantidad} ventas</span>
          </td>
        </tr>
      `,
          )
          .join("");
      },
      (error) => {
        console.error("Error cargando productos:", error);
      },
    );

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================

    function formatTimeAgo(date: Date | undefined): string {
      if (!date) return "Reci칠n";
      const now = new Date();
      const diff = Math.floor((now.getTime() - date.getTime()) / 1000);

      if (diff < 60) return "Hace un momento";
      if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
      if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
      if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} d칤as`;

      return date.toLocaleDateString("es-CL");
    }

    // ============================================
    // GR츼FICO DE VENTAS CON FILTROS DE TIEMPO
    // Usa Chart.js para mostrar gr치fico de pastel/barras
    // con datos reales filtrados por tiempo
    // ============================================

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let salesChart: any = null;
    let currentFilter = "month";
    let currentChartType = "pie";
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let salesUnsubscribe: any = null;

    // Obtener rango de fechas seg칰n filtro seleccionado
    function getDateRange(filter: string): { start: Date; end: Date } {
      const now = new Date();
      const end = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        23,
        59,
        59,
      );
      let start: Date;

      switch (filter) {
        case "day":
          start = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            0,
            0,
            0,
          );
          break;
        case "week":
          start = new Date(now);
          start.setDate(now.getDate() - now.getDay());
          start.setHours(0, 0, 0, 0);
          break;
        case "month":
          start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
          break;
        case "year":
          start = new Date(now.getFullYear(), 0, 1, 0, 0, 0);
          break;
        default:
          start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
      }
      return { start, end };
    }

    // Formatear moneda chilena
    function formatCurrency(value: number): string {
      return new Intl.NumberFormat("es-CL", {
        style: "currency",
        currency: "CLP",
        maximumFractionDigits: 0,
      }).format(value);
    }

    // Renderizar el gr치fico con Chart.js
    function renderSalesChart(data: Record<string, number>) {
      const ctx = document.getElementById("salesChart") as HTMLCanvasElement;
      if (!ctx) return;

      // Destruir gr치fico anterior si existe
      if (salesChart) {
        salesChart.destroy();
      }

      const labels = Object.keys(data);
      const values = Object.values(data);
      const colors = ["#ffc107", "#17a2b8", "#6c757d", "#28a745"];

      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const chartConfig: any = {
        type: currentChartType,
        data: {
          labels: labels,
          datasets: [
            {
              label: "Ventas por Estado ($)",
              data: values,
              backgroundColor: colors,
              borderColor: currentChartType === "bar" ? colors : "#fff",
              borderWidth: currentChartType === "bar" ? 0 : 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: currentChartType === "pie" ? "bottom" : "top",
            },
            tooltip: {
              callbacks: {
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                label: function (context: any) {
                  return `${context.label}: ${formatCurrency(context.raw)}`;
                },
              },
            },
          },
        },
      };

      // @ts-ignore - Chart.js cargado via CDN
      salesChart = new Chart(ctx, chartConfig);
    }

    // Cargar y mostrar datos de ventas
    function loadSalesData() {
      const loadingEl = document.getElementById("chartLoading");
      const errorEl = document.getElementById("chartError");
      const emptyEl = document.getElementById("chartEmpty");
      const containerEl = document.getElementById("chartContainer");
      const summaryEl = document.getElementById("salesSummary");

      // Mostrar loading
      loadingEl?.classList.remove("d-none");
      errorEl?.classList.add("d-none");
      emptyEl?.classList.add("d-none");
      containerEl?.classList.add("d-none");
      summaryEl?.classList.add("d-none");

      const { start, end } = getDateRange(currentFilter);

      // Cancelar listener anterior si existe
      if (salesUnsubscribe) {
        salesUnsubscribe();
      }

      // Escuchar cambios en pedidos
      salesUnsubscribe = onSnapshot(
        pedidosCol,
        (snap) => {
          try {
            // Filtrar pedidos por rango de fecha
            const pedidosFiltrados = snap.docs.filter((doc) => {
              const data = doc.data();
              const fecha =
                data.createdAt?.toDate?.() ||
                new Date(data.fecha || data.createdAt);
              return fecha >= start && fecha <= end;
            });

            // Agrupar ventas por estado
            const ventasPorEstado: Record<string, number> = {
              Pendiente: 0,
              "En Proceso": 0,
              Enviado: 0,
              Completado: 0,
            };

            let totalVentas = 0;
            pedidosFiltrados.forEach((doc) => {
              const data = doc.data();
              // Parsear el total correctamente
              // Si es n칰mero, usarlo directamente
              // Si es string con formato chileno ("$951.405"), quitar $ y puntos
              let total = 0;
              if (typeof data.total === "number") {
                total = data.total;
              } else if (typeof data.total === "string") {
                // Quitar $ y puntos (separadores de miles en formato chileno)
                const cleanTotal = data.total.replace(/[$\.]/g, "").replace(",", ".");
                total = parseFloat(cleanTotal) || 0;
              }
              
              // Mapear estado "Recibido" a "Completado" si existe
              let estado = data.estado || "Pendiente";
              if (estado === "Recibido") estado = "Completado";
              
              totalVentas += total;
              if (ventasPorEstado[estado] !== undefined) {
                ventasPorEstado[estado] += total;
              }
            });

            // Ocultar loading
            loadingEl?.classList.add("d-none");

            // Verificar si hay datos
            if (pedidosFiltrados.length === 0) {
              emptyEl?.classList.remove("d-none");
              return;
            }

            // Mostrar gr치fico y resumen
            containerEl?.classList.remove("d-none");
            summaryEl?.classList.remove("d-none");

            // ============================================
            // ACTUALIZAR RESUMEN DE GANANCIAS POR ESTADO
            // ============================================
            
            // Elementos del DOM - Ganancias principales
            const gananciasRealesEl = document.getElementById("gananciasReales");
            const pedidosRealesEl = document.getElementById("pedidosReales");
            const gananciaEstimadaEl = document.getElementById("gananciaEstimada");
            const pedidosEstimadosEl = document.getElementById("pedidosEstimados");
            
            // Elementos del DOM - Por estado
            const gananciaCompletadoEl = document.getElementById("gananciaCompletado");
            const cantCompletadosEl = document.getElementById("cantCompletados");
            const gananciaPendienteEl = document.getElementById("gananciaPendiente");
            const cantPendientesEl = document.getElementById("cantPendientes");
            const gananciaEnProcesoEl = document.getElementById("gananciaEnProceso");
            const cantEnProcesoEl = document.getElementById("cantEnProceso");
            const gananciaEnviadoEl = document.getElementById("gananciaEnviado");
            const cantEnviadosEl = document.getElementById("cantEnviados");
            
            // Contar pedidos por estado
            let pedidosCompletados = 0;
            let pedidosPendientes = 0;
            let pedidosEnProceso = 0;
            let pedidosEnviados = 0;
            
            pedidosFiltrados.forEach((doc) => {
              const data = doc.data();
              let estado = data.estado || "Pendiente";
              if (estado === "Recibido") estado = "Completado";
              
              switch (estado) {
                case "Completado":
                  pedidosCompletados++;
                  break;
                case "Pendiente":
                  pedidosPendientes++;
                  break;
                case "En Proceso":
                  pedidosEnProceso++;
                  break;
                case "Enviado":
                case "En Tr치nsito":
                  pedidosEnviados++;
                  break;
              }
            });
            
            // Calcular ganancias reales (completados) y estimadas (resto)
            const gananciasReales = ventasPorEstado["Completado"] || 0;
            const gananciaEstimada = 
              (ventasPorEstado["Pendiente"] || 0) + 
              (ventasPorEstado["En Proceso"] || 0) + 
              (ventasPorEstado["Enviado"] || 0);
            const pedidosEnCurso = pedidosPendientes + pedidosEnProceso + pedidosEnviados;
            
            // Actualizar elementos principales
            if (gananciasRealesEl) gananciasRealesEl.textContent = formatCurrency(gananciasReales);
            if (pedidosRealesEl) pedidosRealesEl.textContent = pedidosCompletados.toString();
            if (gananciaEstimadaEl) gananciaEstimadaEl.textContent = formatCurrency(gananciaEstimada);
            if (pedidosEstimadosEl) pedidosEstimadosEl.textContent = pedidosEnCurso.toString();
            
            // Ganancias por estado individual
            if (gananciaCompletadoEl) gananciaCompletadoEl.textContent = formatCurrency(ventasPorEstado["Completado"] || 0);
            if (cantCompletadosEl) cantCompletadosEl.textContent = pedidosCompletados.toString();
            
            if (gananciaPendienteEl) gananciaPendienteEl.textContent = formatCurrency(ventasPorEstado["Pendiente"] || 0);
            if (cantPendientesEl) cantPendientesEl.textContent = pedidosPendientes.toString();
            
            if (gananciaEnProcesoEl) gananciaEnProcesoEl.textContent = formatCurrency(ventasPorEstado["En Proceso"] || 0);
            if (cantEnProcesoEl) cantEnProcesoEl.textContent = pedidosEnProceso.toString();
            
            if (gananciaEnviadoEl) gananciaEnviadoEl.textContent = formatCurrency(ventasPorEstado["Enviado"] || 0);
            if (cantEnviadosEl) cantEnviadosEl.textContent = pedidosEnviados.toString();

            // Renderizar gr치fico
            renderSalesChart(ventasPorEstado);
          } catch (error) {
            console.error("Error procesando datos de ventas:", error);
            loadingEl?.classList.add("d-none");
            errorEl?.classList.remove("d-none");
          }
        },
        (error) => {
          console.error("Error cargando ventas:", error);
          loadingEl?.classList.add("d-none");
          errorEl?.classList.remove("d-none");
        },
      );
    }

    // Inicializar gr치fico y event listeners
    document.addEventListener("DOMContentLoaded", () => {
      // Filtros de tiempo
      document.querySelectorAll("#timeFilterGroup button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          document
            .querySelectorAll("#timeFilterGroup button")
            .forEach((b) => b.classList.remove("active"));
          target.classList.add("active");
          currentFilter = target.dataset.filter || "month";
          loadSalesData();
        });
      });

      // Tipo de gr치fico
      document.querySelectorAll("#chartTypeGroup button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const target = e.currentTarget as HTMLButtonElement;
          document
            .querySelectorAll("#chartTypeGroup button")
            .forEach((b) => b.classList.remove("active"));
          target.classList.add("active");
          currentChartType = target.dataset.chartType || "pie";
          loadSalesData();
        });
      });

      // Bot칩n reintentar
      document.getElementById("retryChartBtn")?.addEventListener("click", () => {
        loadSalesData();
      });

      // Cargar datos iniciales
      loadSalesData();
    });
  </script>

  <!-- Chart.js CDN -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
  ></script>

  <!-- Bootstrap JS Bundle -->
  <script
    is:inline
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
</Layout>
