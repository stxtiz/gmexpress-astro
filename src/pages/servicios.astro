---
import Layout from "../layouts/Layout.astro";
import ProductHeader from "../components/productos/ProductHeader.astro";
import ProductFooter from "../components/productos/ProductFooter.astro";
import ServiceGrid from "../components/servicios/ServiceGrid.astro";
import "../styles/global.css";
---

<Layout title="GMExpress - Nuestros Servicios">
  <div class="servicios-page">
    <ProductHeader searchPlaceholder="Buscar servicios..." />

    <main class="container mx-auto px-4 py-8 md:py-12">
      <!-- Título y Descripción -->
      <div class="mb-8 text-center">
        <p
          class="text-4xl md:text-5xl font-black tracking-tighter text-text-light dark:text-white"
        >
          Descubre Nuestras Soluciones Gastronómicas
        </p>
        <p
          class="mt-2 text-text-light/80 dark:text-text-dark/80 max-w-3xl mx-auto"
        >
          Ofrecemos una variedad de servicios de alimentación diseñados para
          satisfacer las necesidades de su empresa, garantizando calidad y
          frescura en cada plato.
        </p>
      </div>

      <!-- Grid de Servicios -->
      <ServiceGrid />

      <!-- Paginación -->
      <div class="flex items-center justify-center p-4 mt-16">
        <nav class="flex items-center gap-2">
          <a
            class="flex size-10 items-center justify-center text-text-light/50 dark:text-text-dark/50 rounded-lg hover:bg-card-light dark:hover:bg-card-dark transition-colors"
            href="#"
          >
            <span class="material-symbols-outlined text-lg">chevron_left</span>
          </a>
          <a
            class="text-sm font-bold leading-normal flex size-10 items-center justify-center text-white rounded-lg bg-primary"
            href="#">1</a
          >
          <a
            class="text-sm font-medium leading-normal flex size-10 items-center justify-center text-text-light dark:text-text-dark rounded-lg hover:bg-card-light dark:hover:bg-card-dark transition-colors"
            href="#">2</a
          >
          <a
            class="text-sm font-medium leading-normal flex size-10 items-center justify-center text-text-light dark:text-text-dark rounded-lg hover:bg-card-light dark:hover:bg-card-dark transition-colors"
            href="#">3</a
          >
          <span
            class="text-sm font-normal leading-normal flex size-10 items-center justify-center text-text-light/50 dark:text-text-dark/50 rounded-lg"
            >...</span
          >
          <a
            class="flex size-10 items-center justify-center text-text-light/50 dark:text-text-dark/50 rounded-lg hover:bg-card-light dark:hover:bg-card-dark transition-colors"
            href="#"
          >
            <span class="material-symbols-outlined text-lg">chevron_right</span>
          </a>
        </nav>
      </div>
    </main>

    <!-- Carrito lateral compartido -->
    <div
      id="cart-panel"
      class="fixed inset-y-0 right-0 z-50 w-full max-w-md translate-x-full bg-background-light dark:bg-background-dark shadow-2xl border-l border-border-light dark:border-border-dark transition-transform duration-300 flex flex-col"
    >
      <div
        class="flex items-center justify-between px-4 py-3 border-b border-border-light dark:border-border-dark"
      >
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-primary"
            >shopping_cart</span
          >
          <h2 class="text-lg font-bold text-text-light dark:text-text-dark">
            Carrito
          </h2>
        </div>
        <button
          id="cart-close"
          class="flex h-8 w-8 items-center justify-center rounded-full hover:bg-card-light dark:hover:bg-card-dark"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div
        id="cart-items"
        class="flex-1 overflow-y-auto px-4 py-3 space-y-3 text-sm"
      >
        <!-- Items del carrito -->
      </div>

      <div
        class="border-t border-border-light dark:border-border-dark px-4 py-4 space-y-2"
      >
        <div class="flex items-center justify-between text-xs">
          <span class="text-text-light/60 dark:text-text-dark/60">Subtotal</span
          >
          <span
            id="cart-subtotal"
            class="font-medium text-text-light/80 dark:text-text-dark/80"
            >$0</span
          >
        </div>
        <div class="flex items-center justify-between text-xs">
          <span class="text-text-light/60 dark:text-text-dark/60"
            >IVA (19%)</span
          >
          <span
            id="cart-iva"
            class="font-medium text-text-light/80 dark:text-text-dark/80"
            >$0</span
          >
        </div>
        <div
          class="flex items-center justify-between text-sm pt-2 border-t border-border-light/50 dark:border-border-dark/50"
        >
          <span class="text-text-light dark:text-text-dark font-semibold"
            >Total</span
          >
          <span id="cart-total" class="font-bold text-primary text-lg">$0</span>
        </div>
        <button
          class="mt-2 flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-secondary text-white text-sm font-bold tracking-wide hover:bg-secondary/90 transition-colors"
        >
          Ir al pago
        </button>
      </div>
    </div>

    <!-- Modal de Detalle del Servicio -->
    <div
      id="service-detail-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
    >
      <div
        class="relative w-full max-w-2xl mx-4 bg-background-light dark:bg-background-dark rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <button
          id="close-service-modal"
          class="absolute top-4 right-4 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-card-light dark:bg-card-dark hover:bg-primary/10 transition-colors"
        >
          <span
            class="material-symbols-outlined text-text-light dark:text-text-dark"
            >close</span
          >
        </button>

        <div id="service-modal-content">
          <!-- Contenido inyectado dinámicamente -->
        </div>
      </div>
    </div>

    <script>
      const cartPanel = document.getElementById("cart-panel");
      const cartClose = document.getElementById("cart-close");
      const cartItems = document.getElementById("cart-items");
      const cartSubtotal = document.getElementById("cart-subtotal");
      const cartIva = document.getElementById("cart-iva");
      const cartTotal = document.getElementById("cart-total");

      // Cargar carrito desde localStorage
      const mockCart = JSON.parse(localStorage.getItem("gmexpress-cart") || "[]");

      const formatPrice = (value) => value.trim();

      const saveCart = () => {
        localStorage.setItem("gmexpress-cart", JSON.stringify(mockCart));
      };

      const openCart = () => {
        cartPanel?.classList.add("translate-x-0");
        cartPanel?.classList.remove("translate-x-full");
      };

      const closeCart = () => {
        cartPanel?.classList.add("translate-x-full");
        cartPanel?.classList.remove("translate-x-0");
      };

      // Función para mostrar detalle del servicio
      function showServiceDetail(
        name,
        price,
        priceLabel,
        image,
        alt,
        description,
        hasPrice,
      ) {
        const modal = document.getElementById("service-detail-modal");
        const modalContent = document.getElementById("service-modal-content");

        if (!modal || !modalContent) return;

        const priceDisplay =
          hasPrice && price
            ? `<p class="text-4xl font-bold text-primary mb-2">${price}${priceLabel ? ` <span class="text-xl text-text-light/60 dark:text-text-dark/60">${priceLabel}</span>` : ""}</p>`
            : "";

        const actionButton = hasPrice
          ? `<button
              onclick="addServiceToCartFromModal('${name.replace(/'/g, "\\'")}', '${price}')"
              class="w-full flex items-center justify-center gap-2 rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-colors"
            >
              <span class="material-symbols-outlined">shopping_cart</span>
              <span>Agregar al Carrito</span>
            </button>`
          : `<a
              href="/solicitud-cotizacion?servicio=${encodeURIComponent(name)}"
              class="w-full flex items-center justify-center gap-2 rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-colors"
            >
              <span class="material-symbols-outlined">request_quote</span>
              <span>Solicitar Cotización</span>
            </a>`;

        modalContent.innerHTML = `
          <div class="relative">
            <img
              src="${image}"
              alt="${alt}"
              class="w-full h-64 md:h-96 object-cover rounded-t-2xl"
            />
          </div>
          <div class="p-6 md:p-8">
            <h2 class="text-3xl font-bold text-text-light dark:text-text-dark mb-4">
              ${name}
            </h2>
            ${priceDisplay}
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-text-light dark:text-text-dark mb-2">
                Descripción
              </h3>
              <p class="text-text-light/80 dark:text-text-dark/80 leading-relaxed">
                ${description}
              </p>
            </div>
            ${actionButton}
          </div>
        `;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // Función para cerrar modal de servicio
      function closeServiceModal() {
        const modal = document.getElementById("service-detail-modal");
        modal?.classList.add("hidden");
        modal?.classList.remove("flex");
      }

      // Agregar servicio al carrito desde el modal
      window.addServiceToCartFromModal = function (name, price) {
        const existingIndex = mockCart.findIndex(
          (item) => item.name === name && item.type === "servicio",
        );

        if (existingIndex >= 0) {
          mockCart[existingIndex].quantity += 1;
        } else {
          mockCart.push({
            name,
            price,
            quantity: 1,
            type: "servicio",
          });
        }

        saveCart();
        updateCartDisplay();
        closeServiceModal();
        openCart();
      };

      // Eventos para cerrar modal
      document
        .getElementById("close-service-modal")
        ?.addEventListener("click", closeServiceModal);
      document
        .getElementById("service-detail-modal")
        ?.addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            closeServiceModal();
          }
        });

      const updateCartDisplay = () => {
        if (!cartItems || !cartTotal || !cartSubtotal || !cartIva) return;

        cartItems.innerHTML = "";

        if (mockCart.length === 0) {
          cartItems.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-center">
              <span class="material-symbols-outlined text-6xl text-text-light/30 dark:text-text-dark/30">shopping_cart</span>
              <p class="mt-3 text-sm text-text-light/60 dark:text-text-dark/60">Tu carrito está vacío</p>
            </div>
          `;
          cartSubtotal.textContent = "$0";
          cartIva.textContent = "$0";
          cartTotal.textContent = "$0";
          return;
        }

        mockCart.forEach((item, index) => {
          const itemEl = document.createElement("div");
          itemEl.className =
            "flex items-start justify-between gap-2 rounded-lg bg-card-light dark:bg-card-dark px-3 py-2";
          itemEl.innerHTML = `
            <div class="flex-1">
              <p class="font-medium text-text-light dark:text-text-dark">${item.name}</p>
              <p class="text-xs text-text-light/70 dark:text-text-dark/70">Cantidad: ${item.quantity}</p>
              ${item.type ? `<p class="text-xs text-primary mt-0.5">${item.type}</p>` : ""}
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-bold text-primary">${formatPrice(item.price)}</span>
              <button 
                data-remove-item="${index}"
                class="text-text-light/50 dark:text-text-dark/50 hover:text-red-500 transition-colors"
              >
                <span class="material-symbols-outlined text-sm">close</span>
              </button>
            </div>
          `;
          cartItems.appendChild(itemEl);
        });

        const subtotal = mockCart.reduce((sum, item) => {
          const priceNum = parseFloat(item.price.replace(/[^0-9]/g, ""));
          return sum + priceNum * item.quantity;
        }, 0);

        const iva = subtotal * 0.19;
        const total = subtotal + iva;

        cartSubtotal.textContent = `$${subtotal.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        cartIva.textContent = `$${iva.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        cartTotal.textContent = `$${total.toLocaleString("es-CL", { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
      };

      cartClose?.addEventListener("click", closeCart);

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        // Abrir carrito
        if (target.closest("[data-cart-toggle]")) {
          openCart();
          return;
        }

        // Remover item
        const removeBtn = target.closest("[data-remove-item]");
        if (removeBtn) {
          const index = parseInt(
            removeBtn.getAttribute("data-remove-item") || "0",
          );
          mockCart.splice(index, 1);
          saveCart();
          updateCartDisplay();
          return;
        }

        // Ver detalle del servicio (botón "Ver Detalles")
        if (target.closest("[data-view-detail]")) {
          const card = target.closest("[data-service]");
          if (!card) return;

          const nameEl = card.querySelector("[data-service-name]");
          const priceEl = card.querySelector("[data-service-price]");
          const priceLabelEl = card.querySelector("[data-price-label]");
          const imgEl = card.querySelector("img");
          const descEl = card.querySelector("p.text-sm");

          const name = nameEl?.textContent ?? "Servicio";
          const price = priceEl?.textContent ?? "";
          const priceLabel = priceLabelEl?.textContent ?? "";
          const image = imgEl?.src ?? "";
          const alt = imgEl?.alt ?? "";
          const description = descEl?.textContent ?? "";

          // Detectar si tiene precio
          const hasPrice = priceEl !== null && price !== "";

          showServiceDetail(
            name,
            price,
            priceLabel,
            image,
            alt,
            description,
            hasPrice,
          );
          return;
        }

        // Agregar servicio al carrito
        if (
          target.closest("[data-add-to-cart]") &&
          target.closest("[data-service]")
        ) {
          const card = target.closest("[data-service]");
          const nameEl = card.querySelector("[data-service-name]");
          const priceEl = card.querySelector("[data-service-price]");

          const name = nameEl?.textContent ?? "Servicio";
          const price = priceEl?.textContent ?? "$0";

          const existingIndex = mockCart.findIndex(
            (item) => item.name === name && item.type === "servicio",
          );

          if (existingIndex >= 0) {
            mockCart[existingIndex].quantity += 1;
          } else {
            mockCart.push({
              name,
              price,
              quantity: 1,
              type: "servicio",
            });
          }

          saveCart();
          updateCartDisplay();
          openCart();
        }
      });

      // Inicializar carrito
      updateCartDisplay();
    </script>

    <ProductFooter />
  </div>
</Layout>

<style>
  :global(.servicios-page) {
    --primary-color: #8bc34a;
    --secondary-color: #0a2342;
    --background-light: #ffffff;
    --background-dark: #0a2342;
    --text-light: #0a2342;
    --text-dark: #ffffff;
    --card-light: #f7fafc;
    --card-dark: #123456;
    --border-light: #e2e8f0;
    --border-dark: #2a4a6d;
  }
</style>
