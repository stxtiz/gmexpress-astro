---
import Layout from "../layouts/Layout.astro";

import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<Layout title="GMEXPRESS - Registro de Usuario">
  <main class="flex-1 pt-[68px]">
    <!-- Hero Section -->
    <section
      class="w-full py-12 md:py-16 bg-gradient-to-br from-primary/10 to-secondary/10"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-10">
        <div class="flex flex-col gap-4 text-center">
          <h1
            class="text-4xl md:text-5xl font-bold tracking-tight text-secondary dark:text-text-dark"
          >
            Únete a GMEXPRESS
          </h1>
          <p
            class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto"
          >
            Crea tu cuenta y comienza a disfrutar de nuestros productos y
            servicios de calidad
          </p>
        </div>
      </div>
    </section>

    <!-- Registration Form Section -->
    <section class="w-full py-10 md:py-16">
      <div class="max-w-2xl mx-auto px-4 sm:px-10">
        <div
          class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 p-8 md:p-10"
        >
          <form class="flex flex-col gap-6">
            <!-- Información Personal -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Información Personal
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Nombre -->
                <div class="flex flex-col gap-2">
                  <label
                    for="firstName"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Nombre <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="firstName"
                    name="firstName"
                    required
                    placeholder="Juan"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>

                <!-- Apellido Paterno -->
                <div class="flex flex-col gap-2">
                  <label
                    for="lastNamePaterno"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Apellido Paterno <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="lastNamePaterno"
                    name="lastNamePaterno"
                    required
                    placeholder="Pérez"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>

                <!-- Apellido Materno -->
                <div class="flex flex-col gap-2">
                  <label
                    for="lastNameMaterno"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Apellido Materno <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="lastNameMaterno"
                    name="lastNameMaterno"
                    required
                    placeholder="González"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>
              </div>

              <!-- RUT -->
              <div class="flex flex-col gap-2">
                <label
                  for="rut"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  RUT <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="rut"
                  name="rut"
                  required
                  maxlength="12"
                  placeholder="12.345.678-9"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Email -->
              <div class="flex flex-col gap-2">
                <label
                  for="email"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Correo Electrónico <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder="correo@ejemplo.com"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Teléfono -->
              <div class="flex flex-col gap-2">
                <label
                  for="phone"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Teléfono <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  placeholder="+56 9 1234 5678"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Dirección -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Dirección de Despacho
              </h2>

              <!-- Dirección -->
              <div class="flex flex-col gap-2">
                <label
                  for="address"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Calle y Número <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="address"
                  name="address"
                  required
                  placeholder="Av. Libertador Bernardo O'Higgins 1234"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Comuna -->
                <div class="flex flex-col gap-2">
                  <label
                    for="comuna"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Comuna <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="comuna"
                    name="comuna"
                    required
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none cursor-pointer"
                  >
                    <option value="">Selecciona una comuna</option>
                    <!-- Options populated by JS -->
                  </select>
                </div>

                <!-- Región -->
                <div class="flex flex-col gap-2">
                  <label
                    for="region"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Región <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="region"
                    name="region"
                    required
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none cursor-pointer"
                  >
                    <option value="">Selecciona una región</option>
                    <!-- Options populated by JS -->
                  </select>
                </div>
              </div>

              <!-- Departamento/Oficina (Opcional) -->
              <div class="flex flex-col gap-2">
                <label
                  for="apartment"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Departamento/Oficina (Opcional)
                </label>
                <input
                  type="text"
                  id="apartment"
                  name="apartment"
                  placeholder="Depto. 402"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Seguridad -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Seguridad
              </h2>

              <!-- Contraseña -->
              <div class="flex flex-col gap-2">
                <label
                  for="password"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Contraseña <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  placeholder="Mínimo 8 caracteres"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  La contraseña debe tener al menos 8 caracteres, incluir
                  mayúsculas, minúsculas y números
                </p>
              </div>

              <!-- Confirmar Contraseña -->
              <div class="flex flex-col gap-2">
                <label
                  for="confirmPassword"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Confirmar Contraseña <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  required
                  placeholder="Repite tu contraseña"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="flex items-start gap-3 pt-4">
              <input
                type="checkbox"
                id="terms"
                name="terms"
                required
                class="mt-1 h-5 w-5 rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary focus:ring-2 cursor-pointer"
              />
              <label
                for="terms"
                class="text-sm text-slate-600 dark:text-slate-400 cursor-pointer"
              >
                Acepto los <a
                  href="#"
                  class="text-primary hover:underline font-medium"
                  >Términos y Condiciones</a
                > y la
                <a href="#" class="text-primary hover:underline font-medium"
                  >Política de Privacidad</a
                > de GMEXPRESS
              </label>
            </div>

            <!-- Botones -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
              <button
                type="submit"
                class="flex-1 flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-all hover:shadow-lg"
              >
                <span class="material-symbols-outlined mr-2">person_add</span>
                <span class="truncate">Crear Cuenta</span>
              </button>
              <a
                href="/"
                class="flex-1 flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 border-2 border-slate-300 dark:border-slate-700 text-secondary dark:text-text-dark text-base font-bold tracking-wide hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
              >
                <span class="truncate">Cancelar</span>
              </a>
            </div>

            <!-- Login Link -->
            <div
              class="text-center pt-4 border-t border-slate-200 dark:border-slate-800"
            >
              <p class="text-sm text-slate-600 dark:text-slate-400">
                ¿Ya tienes una cuenta?
                <a
                  href="/"
                  class="text-primary hover:underline font-medium ml-1"
                >
                  Inicia sesión aquí
                </a>
              </p>
            </div>
          </form>
        </div>

        <!-- Features -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-10">
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >verified_user</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Seguro y Confiable
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Tus datos están protegidos con encriptación de nivel bancario
              </p>
            </div>
          </div>
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >local_shipping</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Despacho Express
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Recibe tus pedidos en tiempo récord en tu dirección
              </p>
            </div>
          </div>
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >loyalty</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Beneficios Exclusivos
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Ofertas especiales y descuentos para clientes registrados
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  import { auth, db } from "../firebase/client";
  import { createUserWithEmailAndPassword, updateProfile } from "firebase/auth";
  import { doc, setDoc } from "firebase/firestore";

  const form = document.querySelector("form");
  const password = document.getElementById("password");
  const confirmPassword = document.getElementById("confirmPassword");
  const regionSelect = document.getElementById("region");
  const comunaSelect = document.getElementById("comuna");
  const rutInput = document.getElementById("rut");
  const phoneInput = document.getElementById("phone");

  // Data provided by user
  const chileData = {
    "regiones": [
        {
            "region": "Arica y Parinacota",
            "comunas": ["Arica", "Camarones", "Putre", "General Lagos"]
        },
        {
            "region": "Tarapacá",
            "comunas": ["Iquique", "Alto Hospicio", "Pozo Almonte", "Camiña", "Colchane", "Huara", "Pica"]
        },
        {
            "region": "Antofagasta",
            "comunas": ["Antofagasta", "Mejillones", "Sierra Gorda", "Taltal", "Calama", "Ollagüe", "San Pedro de Atacama", "Tocopilla", "María Elena"]
        },
        {
            "region": "Atacama",
            "comunas": ["Copiapó", "Caldera", "Tierra Amarilla", "Chañaral", "Diego de Almagro", "Vallenar", "Alto del Carmen", "Freirina", "Huasco"]
        },
        {
            "region": "Coquimbo",
            "comunas": ["La Serena", "Coquimbo", "Andacollo", "La Higuera", "Paiguano", "Vicuña", "Illapel", "Canela", "Los Vilos", "Salamanca", "Ovalle", "Combarbalá", "Monte Patria", "Punitaqui", "Río Hurtado"]
        },
        {
            "region": "Valparaíso",
            "comunas": ["Valparaíso", "Casablanca", "Concón", "Juan Fernández", "Puchuncaví", "Quintero", "Viña del Mar", "Isla de Pascua", "Los Andes", "Calle Larga", "Rinconada", "San Esteban", "La Ligua", "Cabildo", "Papudo", "Petorca", "Zapallar", "Quillota", "Calera", "Hijuelas", "La Cruz", "Nogales", "San Antonio", "Algarrobo", "Cartagena", "El Quisco", "El Tabo", "Santo Domingo", "San Felipe", "Catemu", "Llaillay", "Panquehue", "Putaendo", "Santa María", "Quilpué", "Limache", "Olmué", "Villa Alemana"]
        },
        {
            "region": "Región del Libertador Gral. Bernardo O’Higgins",
            "comunas": ["Rancagua", "Codegua", "Coinco", "Coltauco", "Doñihue", "Graneros", "Las Cabras", "Machalí", "Malloa", "Mostazal", "Olivar", "Peumo", "Pichidegua", "Quinta de Tilcoco", "Rengo", "Requínoa", "San Vicente", "Pichilemu", "La Estrella", "Litueche", "Marchihue", "Navidad", "Paredones", "San Fernando", "Chépica", "Chimbarongo", "Lolol", "Nancagua", "Palmilla", "Peralillo", "Placilla", "Pumanque", "Santa Cruz"]
        },
        {
            "region": "Región del Maule",
            "comunas": ["Talca", "Constitución", "Curepto", "Empedrado", "Maule", "Pelarco", "Pencahue", "Río Claro", "San Clemente", "San Rafael", "Cauquenes", "Chanco", "Pelluhue", "Curicó", "Hualañé", "Licantén", "Molina", "Rauco", "Romeral", "Sagrada Familia", "Teno", "Vichuquén", "Linares", "Colbún", "Longaví", "Parral", "Retiro", "San Javier", "Villa Alegre", "Yerbas Buenas"]
        },
        {
            "region": "Región de Ñuble",
            "comunas": ["Cobquecura", "Coelemu", "Ninhue", "Portezuelo", "Quirihue", "Ránquil", "Treguaco", "Bulnes", "Chillán Viejo", "Chillán", "El Carmen", "Pemuco", "Pinto", "Quillón", "San Ignacio", "Yungay", "Coihueco", "Ñiquén", "San Carlos", "San Fabián", "San Nicolás"]
        },
        {
            "region": "Región del Biobío",
            "comunas": ["Concepción", "Coronel", "Chiguayante", "Florida", "Hualqui", "Lota", "Penco", "San Pedro de la Paz", "Santa Juana", "Talcahuano", "Tomé", "Hualpén", "Lebu", "Arauco", "Cañete", "Contulmo", "Curanilahue", "Los Álamos", "Tirúa", "Los Ángeles", "Antuco", "Cabrero", "Laja", "Mulchén", "Nacimiento", "Negrete", "Quilaco", "Quilleco", "San Rosendo", "Santa Bárbara", "Tucapel", "Yumbel", "Alto Biobío"]
        },
        {
            "region": "Región de la Araucanía",
            "comunas": ["Temuco", "Carahue", "Cunco", "Curarrehue", "Freire", "Galvarino", "Gorbea", "Lautaro", "Loncoche", "Melipeuco", "Nueva Imperial", "Padre las Casas", "Perquenco", "Pitrufquén", "Pucón", "Saavedra", "Teodoro Schmidt", "Toltén", "Vilcún", "Villarrica", "Cholchol", "Angol", "Collipulli", "Curacautín", "Ercilla", "Lonquimay", "Los Sauces", "Lumaco", "Purén", "Renaico", "Traiguén", "Victoria"]
        },
        {
            "region": "Región de Los Ríos",
            "comunas": ["Valdivia", "Corral", "Lanco", "Los Lagos", "Máfil", "Mariquina", "Paillaco", "Panguipulli", "La Unión", "Futrono", "Lago Ranco", "Río Bueno"]
        },
        {
            "region": "Región de Los Lagos",
            "comunas": ["Puerto Montt", "Calbuco", "Cochamó", "Fresia", "Frutillar", "Los Muermos", "Llanquihue", "Maullín", "Puerto Varas", "Castro", "Ancud", "Chonchi", "Curaco de Vélez", "Dalcahue", "Puqueldón", "Queilén", "Quellón", "Quemchi", "Quinchao", "Osorno", "Puerto Octay", "Purranque", "Puyehue", "Río Negro", "San Juan de la Costa", "San Pablo", "Chaitén", "Futaleufú", "Hualaihué", "Palena"]
        },
        {
            "region": "Región Aisén del Gral. Carlos Ibáñez del Campo",
            "comunas": ["Coihaique", "Lago Verde", "Aisén", "Cisnes", "Guaitecas", "Cochrane", "O’Higgins", "Tortel", "Chile Chico", "Río Ibáñez"]
        },
        {
            "region": "Región de Magallanes y de la Antártica Chilena",
            "comunas": ["Punta Arenas", "Laguna Blanca", "Río Verde", "San Gregorio", "Cabo de Hornos (Ex Navarino)", "Antártica", "Porvenir", "Primavera", "Timaukel", "Natales", "Torres del Paine"]
        },
        {
            "region": "Región Metropolitana de Santiago",
            "comunas": ["Cerrillos", "Cerro Navia", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja", "La Pintana", "La Reina", "Las Condes", "Lo Barnechea", "Lo Espejo", "Lo Prado", "Macul", "Maipú", "Ñuñoa", "Pedro Aguirre Cerda", "Peñalolén", "Providencia", "Pudahuel", "Quilicura", "Quinta Normal", "Recoleta", "Renca", "Santiago", "San Joaquín", "San Miguel", "San Ramón", "Vitacura", "Puente Alto", "Pirque", "San José de Maipo", "Colina", "Lampa", "Tiltil", "San Bernardo", "Buin", "Calera de Tango", "Paine", "Melipilla", "Alhué", "Curacaví", "María Pinto", "San Pedro", "Talagante", "El Monte", "Isla de Maipo", "Padre Hurtado", "Peñaflor"]
         }
    ]
  };

  const regionesData = chileData.regiones;

  function populateRegiones() {
    regionSelect.innerHTML = '<option value="">Selecciona una región</option>';
    regionesData.forEach((region) => {
      const option = document.createElement("option");
      option.value = region.region;
      option.textContent = region.region;
      regionSelect.appendChild(option);
    });
  }

  // Initialize immediately
  populateRegiones();


  regionSelect.addEventListener("change", (e) => {
    const selectedRegionName = e.target.value;
    comunaSelect.innerHTML = '<option value="">Selecciona una comuna</option>';
    
    const region = regionesData.find(r => r.region === selectedRegionName);
    if (region) {
      region.comunas.forEach(comuna => {
        const option = document.createElement("option");
        option.value = comuna;
        option.textContent = comuna;
        comunaSelect.appendChild(option);
      });
    }
  });

  // RUT Validation
  function validateRUT(rut) {
    if (!/^[0-9]+[-|‐]{1}[0-9kK]{1}$/.test(rut)) return false;
    const tmp = rut.split('-');
    let digito = tmp[1];
    const rutBody = tmp[0];
    if (digito == 'K') digito = 'k';
    
    return (rutBody == 0) ? false : checkDigito(rutBody) == digito;
  }

  function checkDigito(T) {
    let M = 0, S = 1;
    for (; T; T = Math.floor(T / 10))
      S = (S + T % 10 * (9 - M++ % 6)) % 11;
    return S ? S - 1 : 'k';
  }

  // Format RUT on input
  rutInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\./g, '').replace(/-/g, '');
    if (value.match(/^(\d{2})(\d{3}){2}(\w{1})$/)) {
      value = value.replace(/^(\d{2})(\d{3})(\d{3})(\w{1})$/, '$1.$2.$3-$4');
    } else if (value.match(/^(\d)(\d{3}){2}(\w{0,1})$/)) {
      value = value.replace(/^(\d)(\d{3})(\d{3})(\w{0,1})$/, '$1.$2.$3-$4');
    } else if (value.match(/^(\d)(\d{3})(\d{0,2})$/)) {
      value = value.replace(/^(\d)(\d{3})(\d{0,2})$/, '$1.$2.$3');
    } else if (value.match(/^(\d)(\d{0,2})$/)) {
      value = value.replace(/^(\d)(\d{0,2})$/, '$1.$2');
    }
    e.target.value = value;
  });

  // Phone Validation
  function validatePhone(phone) {
    // Acepta +56912345678 o 912345678
    const phoneRegex = /^(\+?56)?(\s?)(0?9)(\s?)[98765432]\d{7}$/;
    return phoneRegex.test(phone);
  }

  // Form Submit
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validations
    if (password.value !== confirmPassword.value) {
      alert("Las contraseñas no coinciden.");
      return;
    }

    // Clean RUT for validation (remove dots)
    const cleanRut = rutInput.value.replace(/\./g, '');
    if (!validateRUT(cleanRut)) {
      alert("RUT inválido. Por favor verifique.");
      return;
    }

    if (!validatePhone(phoneInput.value)) {
      alert("Teléfono inválido. Use formato chileno (ej: +56912345678).");
      return;
    }

    try {
      // Create User in Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(
        auth, 
        document.getElementById("email").value, 
        password.value
      );
      const user = userCredential.user;

      // Update Profile
      await updateProfile(user, {
        displayName: `${document.getElementById("firstName").value} ${document.getElementById("lastNamePaterno").value}`
      });

      // Save additional data to Firestore
      await setDoc(doc(db, "users", user.uid), {
        firstName: document.getElementById("firstName").value,
        lastNamePaterno: document.getElementById("lastNamePaterno").value,
        lastNameMaterno: document.getElementById("lastNameMaterno").value,
        rut: rutInput.value,
        email: document.getElementById("email").value,
        phone: phoneInput.value,
        address: document.getElementById("address").value,
        region: regionSelect.value,
        comuna: comunaSelect.value,
        apartment: document.getElementById("apartment").value,
        createdAt: new Date(),
        role: "user" // Default role
      });

      alert("¡Registro exitoso! Bienvenido a GMEXPRESS.");
      window.location.href = "/";

    } catch (error) {
      console.error("Error registering:", error);
      let msg = "Error al registrar usuario.";
      if (error.code === 'auth/email-already-in-use') msg = "El correo ya está registrado.";
      if (error.code === 'auth/weak-password') msg = "La contraseña es muy débil.";
      alert(msg);
    }
  });


</script>
