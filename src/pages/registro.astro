---
import Layout from "../layouts/Layout.astro";

import Footer from "../components/Footer.astro";
import "../styles/global.css";
---

<Layout title="GMEXPRESS - Registro de Usuario">
  <main class="flex-1 pt-[68px]">
    <!-- Hero Section -->
    <section
      class="w-full py-12 md:py-16 bg-gradient-to-br from-primary/10 to-secondary/10"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-10">
        <div class="flex flex-col gap-4 text-center">
          <h1
            class="text-4xl md:text-5xl font-bold tracking-tight text-secondary dark:text-text-dark"
          >
            Únete a GMEXPRESS
          </h1>
          <p
            class="text-lg text-slate-600 dark:text-slate-400 max-w-2xl mx-auto"
          >
            Crea tu cuenta y comienza a disfrutar de nuestros productos y
            servicios de calidad
          </p>
        </div>
      </div>
    </section>

    <!-- Registration Form Section -->
    <section class="w-full py-10 md:py-16">
      <div class="max-w-2xl mx-auto px-4 sm:px-10">
        <div
          class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-800 p-8 md:p-10"
        >
          <form class="flex flex-col gap-6">
            <!-- Información Personal -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Información Personal
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Nombre -->
                <div class="flex flex-col gap-2">
                  <label
                    for="firstName"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Nombre <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="firstName"
                    name="firstName"
                    placeholder="Juan"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>

                <!-- Apellido Paterno -->
                <div class="flex flex-col gap-2">
                  <label
                    for="lastNamePaterno"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Apellido Paterno <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="lastNamePaterno"
                    name="lastNamePaterno"
                    placeholder="Pérez"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>

                <!-- Apellido Materno -->
                <div class="flex flex-col gap-2">
                  <label
                    for="lastNameMaterno"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Apellido Materno <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="lastNameMaterno"
                    name="lastNameMaterno"
                    placeholder="González"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  />
                </div>
              </div>

              <!-- RUT -->
              <div class="flex flex-col gap-2">
                <label
                  for="rut"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  RUT <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="rut"
                  name="rut"
                  maxlength="12"
                  placeholder="12.345.678-9"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Email -->
              <div class="flex flex-col gap-2">
                <label
                  for="email"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Correo Electrónico <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="correo@ejemplo.com"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <!-- Teléfono -->
              <div class="flex flex-col gap-2">
                <label
                  for="phone"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Teléfono <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  placeholder="+56 9 1234 5678"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Dirección -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Dirección de Despacho
              </h2>

              <!-- Dirección -->
              <div class="flex flex-col gap-2">
                <label
                  for="address"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Calle y Número <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="address"
                  name="address"
                  placeholder="Av. Libertador Bernardo O'Higgins 1234"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Comuna -->
                <div class="flex flex-col gap-2">
                  <label
                    for="comuna"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Comuna <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="comuna"
                    name="comuna"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none cursor-pointer"
                  >
                    <option value="">Selecciona una comuna</option>
                    <!-- Options populated by JS -->
                  </select>
                </div>

                <!-- Región -->
                <div class="flex flex-col gap-2">
                  <label
                    for="region"
                    class="text-sm font-medium text-secondary dark:text-text-dark"
                  >
                    Región <span class="text-red-500">*</span>
                  </label>
                  <select
                    id="region"
                    name="region"
                    class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all appearance-none cursor-pointer"
                  >
                    <option value="">Selecciona una región</option>
                    <!-- Options populated by JS -->
                  </select>
                </div>
              </div>

              <!-- Departamento/Oficina (Opcional) -->
              <div class="flex flex-col gap-2">
                <label
                  for="apartment"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Departamento/Oficina (Opcional)
                </label>
                <input
                  type="text"
                  id="apartment"
                  name="apartment"
                  placeholder="Depto. 402"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Seguridad -->
            <div class="flex flex-col gap-4">
              <h2 class="text-2xl font-bold text-secondary dark:text-text-dark">
                Seguridad
              </h2>

              <!-- Contraseña -->
              <div class="flex flex-col gap-2">
                <label
                  for="password"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Contraseña <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Mínimo 8 caracteres"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
                <p class="text-xs text-slate-500 dark:text-slate-400">
                  La contraseña debe tener al menos 8 caracteres, incluir
                  mayúsculas, minúsculas, números y un carácter especial
                  (!@#$%^&*)
                </p>
              </div>

              <!-- Confirmar Contraseña -->
              <div class="flex flex-col gap-2">
                <label
                  for="confirmPassword"
                  class="text-sm font-medium text-secondary dark:text-text-dark"
                >
                  Confirmar Contraseña <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  placeholder="Repite tu contraseña"
                  class="h-12 px-4 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-secondary dark:text-text-dark placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                />
              </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="flex items-start gap-3 pt-4">
              <input
                type="checkbox"
                id="terms"
                name="terms"
                class="mt-1 h-5 w-5 rounded border-slate-300 dark:border-slate-700 text-primary focus:ring-primary focus:ring-2 cursor-pointer"
              />
              <label
                for="terms"
                class="text-sm text-slate-600 dark:text-slate-400 cursor-pointer"
              >
                Acepto los <a
                  href="#"
                  class="text-primary hover:underline font-medium"
                  >Términos y Condiciones</a
                > y la
                <a href="#" class="text-primary hover:underline font-medium"
                  >Política de Privacidad</a
                > de GMEXPRESS
              </label>
            </div>

            <!-- Botones -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
              <button
                type="submit"
                class="flex-1 flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 bg-primary text-white text-base font-bold tracking-wide hover:bg-primary/90 transition-all hover:shadow-lg"
              >
                <span class="material-symbols-outlined mr-2">person_add</span>
                <span class="truncate">Crear Cuenta</span>
              </button>
              <a
                href="/"
                class="flex-1 flex cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-6 border-2 border-slate-300 dark:border-slate-700 text-secondary dark:text-text-dark text-base font-bold tracking-wide hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
              >
                <span class="truncate">Cancelar</span>
              </a>
            </div>

            <!-- Login Link -->
            <div
              class="text-center pt-4 border-t border-slate-200 dark:border-slate-800"
            >
              <p class="text-sm text-slate-600 dark:text-slate-400">
                ¿Ya tienes una cuenta?
                <a
                  href="/"
                  class="text-primary hover:underline font-medium ml-1"
                >
                  Inicia sesión aquí
                </a>
              </p>
            </div>
          </form>
        </div>

        <!-- Features -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-10">
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >verified_user</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Seguro y Confiable
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Tus datos están protegidos con encriptación de nivel bancario
              </p>
            </div>
          </div>
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >local_shipping</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Despacho Express
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Recibe tus pedidos en tiempo récord en tu dirección
              </p>
            </div>
          </div>
          <div
            class="flex items-start gap-3 p-4 bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800"
          >
            <span class="material-symbols-outlined text-primary text-3xl"
              >loyalty</span
            >
            <div>
              <h3 class="font-bold text-secondary dark:text-text-dark">
                Beneficios Exclusivos
              </h3>
              <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                Ofertas especiales y descuentos para clientes registrados
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* ============================================
     ESTILOS PARA VALIDACIONES Y TOASTS
     ============================================ */

  /* Animación de entrada desde la derecha */
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Animación de salida hacia la derecha */
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  /* Animación de shake para errores */
  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70%,
    90% {
      transform: translateX(-5px);
    }
    20%,
    40%,
    60%,
    80% {
      transform: translateX(5px);
    }
  }

  /* Estilos para campos con error */
  :global(.field-error) {
    border-color: #dc2626 !important;
    animation: shake 0.5s ease-in-out;
  }

  :global(.field-error:focus) {
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.25) !important;
    ring-color: #dc2626 !important;
  }

  /* Toast container */
  :global(#toast-container) {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  :global(.toast) {
    min-width: 320px;
    max-width: 420px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
  }

  :global(.toast-success) {
    border-left: 4px solid #22c55e;
  }

  :global(.toast-danger) {
    border-left: 4px solid #ef4444;
  }

  :global(.toast-warning) {
    border-left: 4px solid #f59e0b;
  }

  :global(.toast-info) {
    border-left: 4px solid #3b82f6;
  }

  /* Modal de validación */
  :global(.validation-modal-overlay) {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease-out;
  }

  :global(.validation-modal) {
    background: white;
    border-radius: 16px;
    max-width: 420px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: slideUp 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Animación de spinner para botón de carga */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  :global(.animate-spin) {
    animation: spin 1s linear infinite;
  }
</style>

<script>
  import { auth, db } from "../firebase/client";
  import { createUserWithEmailAndPassword, updateProfile } from "firebase/auth";
  import {
    doc,
    setDoc,
    collection,
    query,
    where,
    getDocs,
  } from "firebase/firestore";

  const form = document.querySelector("form") as HTMLFormElement | null;
  const password = document.getElementById(
    "password",
  ) as HTMLInputElement | null;
  const confirmPassword = document.getElementById(
    "confirmPassword",
  ) as HTMLInputElement | null;
  const regionSelect = document.getElementById(
    "region",
  ) as HTMLSelectElement | null;
  const comunaSelect = document.getElementById(
    "comuna",
  ) as HTMLSelectElement | null;
  const rutInput = document.getElementById("rut") as HTMLInputElement | null;
  const phoneInput = document.getElementById(
    "phone",
  ) as HTMLInputElement | null;

  // ============================================
  // FUNCIÓN: Verificar si RUT ya existe en la base de datos
  // ============================================
  async function checkRutExists(rut: string): Promise<boolean> {
    try {
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("rut", "==", rut));
      const querySnapshot = await getDocs(q);
      return !querySnapshot.empty;
    } catch (error) {
      console.error("Error verificando RUT:", error);
      return false; // En caso de error, permitir continuar
    }
  }

  // ============================================
  // FUNCIÓN: Mostrar toast de éxito/info/warning/danger
  // ============================================
  function showToast(
    message: string,
    type: "success" | "info" | "warning" | "danger" = "info",
  ): void {
    const config = {
      success: {
        icon: `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        title: "Éxito",
        bgColor: "bg-green-50",
        textColor: "text-green-800",
        borderClass: "toast-success",
      },
      info: {
        icon: `<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        title: "Información",
        bgColor: "bg-blue-50",
        textColor: "text-blue-800",
        borderClass: "toast-info",
      },
      warning: {
        icon: `<svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
        title: "Advertencia",
        bgColor: "bg-amber-50",
        textColor: "text-amber-800",
        borderClass: "toast-warning",
      },
      danger: {
        icon: `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        title: "Error",
        bgColor: "bg-red-50",
        textColor: "text-red-800",
        borderClass: "toast-danger",
      },
    };

    const { icon, title, bgColor, textColor, borderClass } = config[type];

    // Crear contenedor de toasts si no existe
    let toastContainer = document.getElementById("toast-container");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.id = "toast-container";
      document.body.appendChild(toastContainer);
    }

    // Crear el toast
    const toastId = `toast-${Date.now()}`;
    const toastEl = document.createElement("div");
    toastEl.id = toastId;
    toastEl.className = `toast ${borderClass}`;
    toastEl.style.animation = "slideInRight 0.3s ease-out";
    toastEl.innerHTML = `
      <div class="p-4 ${bgColor}">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">${icon}</div>
          <div class="flex-1">
            <p class="font-semibold ${textColor}">${title}</p>
            <p class="text-sm text-gray-600 mt-1">${message}</p>
          </div>
          <button onclick="this.closest('.toast').remove()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
      </div>
    `;

    toastContainer.appendChild(toastEl);

    // Auto-remover después de 5 segundos
    setTimeout(() => {
      toastEl.style.animation = "slideOutRight 0.3s ease-in";
      setTimeout(() => toastEl.remove(), 300);
    }, 5000);
  }

  // ============================================
  // FUNCIÓN: Mostrar errores de validación en modal
  // ============================================
  function showValidationErrors(errors: string[]): void {
    // Remover modal existente si hay
    const existingModal = document.getElementById("validation-modal-overlay");
    if (existingModal) existingModal.remove();

    const overlay = document.createElement("div");
    overlay.id = "validation-modal-overlay";
    overlay.className = "validation-modal-overlay";
    overlay.innerHTML = `
      <div class="validation-modal">
        <div class="bg-red-50 px-6 py-4 border-b border-red-100">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-red-800">Error de Validación</h3>
          </div>
        </div>
        <div class="px-6 py-4 max-h-60 overflow-y-auto">
          <p class="text-gray-600 text-sm mb-3">Por favor corrige los siguientes errores:</p>
          <ul class="space-y-2">
            ${errors
              .map(
                (error) => `
              <li class="flex items-start gap-2 p-2 bg-red-50 rounded-lg">
                <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <span class="text-sm text-gray-700">${error}</span>
              </li>
            `,
              )
              .join("")}
          </ul>
        </div>
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
          <button id="close-validation-modal" class="w-full py-2.5 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">
            Entendido
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // Event listeners para cerrar
    document
      .getElementById("close-validation-modal")
      ?.addEventListener("click", () => overlay.remove());
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.remove();
    });

    // Cerrar con Escape
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        overlay.remove();
        document.removeEventListener("keydown", handleEscape);
      }
    };
    document.addEventListener("keydown", handleEscape);
  }

  // ============================================
  // FUNCIÓN: Limpiar errores de campos
  // ============================================
  function clearFieldErrors(): void {
    document.querySelectorAll(".field-error").forEach((el) => {
      el.classList.remove("field-error");
    });
  }

  // Data provided by user
  const chileData = {
    regiones: [
      {
        region: "Arica y Parinacota",
        comunas: ["Arica", "Camarones", "Putre", "General Lagos"],
      },
      {
        region: "Tarapacá",
        comunas: [
          "Iquique",
          "Alto Hospicio",
          "Pozo Almonte",
          "Camiña",
          "Colchane",
          "Huara",
          "Pica",
        ],
      },
      {
        region: "Antofagasta",
        comunas: [
          "Antofagasta",
          "Mejillones",
          "Sierra Gorda",
          "Taltal",
          "Calama",
          "Ollagüe",
          "San Pedro de Atacama",
          "Tocopilla",
          "María Elena",
        ],
      },
      {
        region: "Atacama",
        comunas: [
          "Copiapó",
          "Caldera",
          "Tierra Amarilla",
          "Chañaral",
          "Diego de Almagro",
          "Vallenar",
          "Alto del Carmen",
          "Freirina",
          "Huasco",
        ],
      },
      {
        region: "Coquimbo",
        comunas: [
          "La Serena",
          "Coquimbo",
          "Andacollo",
          "La Higuera",
          "Paiguano",
          "Vicuña",
          "Illapel",
          "Canela",
          "Los Vilos",
          "Salamanca",
          "Ovalle",
          "Combarbalá",
          "Monte Patria",
          "Punitaqui",
          "Río Hurtado",
        ],
      },
      {
        region: "Valparaíso",
        comunas: [
          "Valparaíso",
          "Casablanca",
          "Concón",
          "Juan Fernández",
          "Puchuncaví",
          "Quintero",
          "Viña del Mar",
          "Isla de Pascua",
          "Los Andes",
          "Calle Larga",
          "Rinconada",
          "San Esteban",
          "La Ligua",
          "Cabildo",
          "Papudo",
          "Petorca",
          "Zapallar",
          "Quillota",
          "Calera",
          "Hijuelas",
          "La Cruz",
          "Nogales",
          "San Antonio",
          "Algarrobo",
          "Cartagena",
          "El Quisco",
          "El Tabo",
          "Santo Domingo",
          "San Felipe",
          "Catemu",
          "Llaillay",
          "Panquehue",
          "Putaendo",
          "Santa María",
          "Quilpué",
          "Limache",
          "Olmué",
          "Villa Alemana",
        ],
      },
      {
        region: "Región del Libertador Gral. Bernardo O’Higgins",
        comunas: [
          "Rancagua",
          "Codegua",
          "Coinco",
          "Coltauco",
          "Doñihue",
          "Graneros",
          "Las Cabras",
          "Machalí",
          "Malloa",
          "Mostazal",
          "Olivar",
          "Peumo",
          "Pichidegua",
          "Quinta de Tilcoco",
          "Rengo",
          "Requínoa",
          "San Vicente",
          "Pichilemu",
          "La Estrella",
          "Litueche",
          "Marchihue",
          "Navidad",
          "Paredones",
          "San Fernando",
          "Chépica",
          "Chimbarongo",
          "Lolol",
          "Nancagua",
          "Palmilla",
          "Peralillo",
          "Placilla",
          "Pumanque",
          "Santa Cruz",
        ],
      },
      {
        region: "Región del Maule",
        comunas: [
          "Talca",
          "Constitución",
          "Curepto",
          "Empedrado",
          "Maule",
          "Pelarco",
          "Pencahue",
          "Río Claro",
          "San Clemente",
          "San Rafael",
          "Cauquenes",
          "Chanco",
          "Pelluhue",
          "Curicó",
          "Hualañé",
          "Licantén",
          "Molina",
          "Rauco",
          "Romeral",
          "Sagrada Familia",
          "Teno",
          "Vichuquén",
          "Linares",
          "Colbún",
          "Longaví",
          "Parral",
          "Retiro",
          "San Javier",
          "Villa Alegre",
          "Yerbas Buenas",
        ],
      },
      {
        region: "Región de Ñuble",
        comunas: [
          "Cobquecura",
          "Coelemu",
          "Ninhue",
          "Portezuelo",
          "Quirihue",
          "Ránquil",
          "Treguaco",
          "Bulnes",
          "Chillán Viejo",
          "Chillán",
          "El Carmen",
          "Pemuco",
          "Pinto",
          "Quillón",
          "San Ignacio",
          "Yungay",
          "Coihueco",
          "Ñiquén",
          "San Carlos",
          "San Fabián",
          "San Nicolás",
        ],
      },
      {
        region: "Región del Biobío",
        comunas: [
          "Concepción",
          "Coronel",
          "Chiguayante",
          "Florida",
          "Hualqui",
          "Lota",
          "Penco",
          "San Pedro de la Paz",
          "Santa Juana",
          "Talcahuano",
          "Tomé",
          "Hualpén",
          "Lebu",
          "Arauco",
          "Cañete",
          "Contulmo",
          "Curanilahue",
          "Los Álamos",
          "Tirúa",
          "Los Ángeles",
          "Antuco",
          "Cabrero",
          "Laja",
          "Mulchén",
          "Nacimiento",
          "Negrete",
          "Quilaco",
          "Quilleco",
          "San Rosendo",
          "Santa Bárbara",
          "Tucapel",
          "Yumbel",
          "Alto Biobío",
        ],
      },
      {
        region: "Región de la Araucanía",
        comunas: [
          "Temuco",
          "Carahue",
          "Cunco",
          "Curarrehue",
          "Freire",
          "Galvarino",
          "Gorbea",
          "Lautaro",
          "Loncoche",
          "Melipeuco",
          "Nueva Imperial",
          "Padre las Casas",
          "Perquenco",
          "Pitrufquén",
          "Pucón",
          "Saavedra",
          "Teodoro Schmidt",
          "Toltén",
          "Vilcún",
          "Villarrica",
          "Cholchol",
          "Angol",
          "Collipulli",
          "Curacautín",
          "Ercilla",
          "Lonquimay",
          "Los Sauces",
          "Lumaco",
          "Purén",
          "Renaico",
          "Traiguén",
          "Victoria",
        ],
      },
      {
        region: "Región de Los Ríos",
        comunas: [
          "Valdivia",
          "Corral",
          "Lanco",
          "Los Lagos",
          "Máfil",
          "Mariquina",
          "Paillaco",
          "Panguipulli",
          "La Unión",
          "Futrono",
          "Lago Ranco",
          "Río Bueno",
        ],
      },
      {
        region: "Región de Los Lagos",
        comunas: [
          "Puerto Montt",
          "Calbuco",
          "Cochamó",
          "Fresia",
          "Frutillar",
          "Los Muermos",
          "Llanquihue",
          "Maullín",
          "Puerto Varas",
          "Castro",
          "Ancud",
          "Chonchi",
          "Curaco de Vélez",
          "Dalcahue",
          "Puqueldón",
          "Queilén",
          "Quellón",
          "Quemchi",
          "Quinchao",
          "Osorno",
          "Puerto Octay",
          "Purranque",
          "Puyehue",
          "Río Negro",
          "San Juan de la Costa",
          "San Pablo",
          "Chaitén",
          "Futaleufú",
          "Hualaihué",
          "Palena",
        ],
      },
      {
        region: "Región Aisén del Gral. Carlos Ibáñez del Campo",
        comunas: [
          "Coihaique",
          "Lago Verde",
          "Aisén",
          "Cisnes",
          "Guaitecas",
          "Cochrane",
          "O’Higgins",
          "Tortel",
          "Chile Chico",
          "Río Ibáñez",
        ],
      },
      {
        region: "Región de Magallanes y de la Antártica Chilena",
        comunas: [
          "Punta Arenas",
          "Laguna Blanca",
          "Río Verde",
          "San Gregorio",
          "Cabo de Hornos (Ex Navarino)",
          "Antártica",
          "Porvenir",
          "Primavera",
          "Timaukel",
          "Natales",
          "Torres del Paine",
        ],
      },
      {
        region: "Región Metropolitana de Santiago",
        comunas: [
          "Cerrillos",
          "Cerro Navia",
          "Conchalí",
          "El Bosque",
          "Estación Central",
          "Huechuraba",
          "Independencia",
          "La Cisterna",
          "La Florida",
          "La Granja",
          "La Pintana",
          "La Reina",
          "Las Condes",
          "Lo Barnechea",
          "Lo Espejo",
          "Lo Prado",
          "Macul",
          "Maipú",
          "Ñuñoa",
          "Pedro Aguirre Cerda",
          "Peñalolén",
          "Providencia",
          "Pudahuel",
          "Quilicura",
          "Quinta Normal",
          "Recoleta",
          "Renca",
          "Santiago",
          "San Joaquín",
          "San Miguel",
          "San Ramón",
          "Vitacura",
          "Puente Alto",
          "Pirque",
          "San José de Maipo",
          "Colina",
          "Lampa",
          "Tiltil",
          "San Bernardo",
          "Buin",
          "Calera de Tango",
          "Paine",
          "Melipilla",
          "Alhué",
          "Curacaví",
          "María Pinto",
          "San Pedro",
          "Talagante",
          "El Monte",
          "Isla de Maipo",
          "Padre Hurtado",
          "Peñaflor",
        ],
      },
    ],
  };

  const regionesData = chileData.regiones;

  function populateRegiones(): void {
    if (!regionSelect) return;
    regionSelect.innerHTML = '<option value="">Selecciona una región</option>';
    regionesData.forEach((region) => {
      const option = document.createElement("option");
      option.value = region.region;
      option.textContent = region.region;
      regionSelect.appendChild(option);
    });
  }

  // Initialize immediately
  populateRegiones();

  regionSelect?.addEventListener("change", (e) => {
    const target = e.target as HTMLSelectElement;
    const selectedRegionName = target.value;
    if (!comunaSelect) return;
    comunaSelect.innerHTML = '<option value="">Selecciona una comuna</option>';

    const region = regionesData.find((r) => r.region === selectedRegionName);
    if (region) {
      region.comunas.forEach((comuna) => {
        const option = document.createElement("option");
        option.value = comuna;
        option.textContent = comuna;
        comunaSelect.appendChild(option);
      });
    }
  });

  // RUT Validation
  function validateRUT(rut: string): boolean {
    if (!/^[0-9]+[-|‐]{1}[0-9kK]{1}$/.test(rut)) return false;
    const tmp = rut.split("-");
    let digito: string = tmp[1];
    const rutBody = tmp[0];
    if (digito == "K") digito = "k";

    return rutBody == "0" ? false : checkDigito(parseInt(rutBody)) == digito;
  }

  function checkDigito(T: number): string | number {
    let M = 0,
      S = 1;
    for (; T; T = Math.floor(T / 10)) S = (S + (T % 10) * (9 - (M++ % 6))) % 11;
    return S ? S - 1 : "k";
  }

  // Format RUT on input
  rutInput?.addEventListener("input", function (e: Event) {
    const target = e.target as HTMLInputElement;
    let value = target.value.replace(/\./g, "").replace(/-/g, "");
    if (value.match(/^(\d{2})(\d{3}){2}(\w{1})$/)) {
      value = value.replace(/^(\d{2})(\d{3})(\d{3})(\w{1})$/, "$1.$2.$3-$4");
    } else if (value.match(/^(\d)(\d{3}){2}(\w{0,1})$/)) {
      value = value.replace(/^(\d)(\d{3})(\d{3})(\w{0,1})$/, "$1.$2.$3-$4");
    } else if (value.match(/^(\d)(\d{3})(\d{0,2})$/)) {
      value = value.replace(/^(\d)(\d{3})(\d{0,2})$/, "$1.$2.$3");
    } else if (value.match(/^(\d)(\d{0,2})$/)) {
      value = value.replace(/^(\d)(\d{0,2})$/, "$1.$2");
    }
    target.value = value;
  });

  // Phone Validation
  function validatePhone(phone: string): boolean {
    // Acepta +56912345678 o 912345678
    const phoneRegex = /^(\+?56)?(\s?)(0?9)(\s?)[98765432]\d{7}$/;
    return phoneRegex.test(phone);
  }

  // Password Validation
  // Requisitos: 8+ caracteres, 1 mayúscula, 1 minúscula, 1 número, 1 carácter especial
  function validatePassword(
    pwd: string,
    confirmPwd: string,
  ): { isValid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!pwd) {
      return { isValid: false, errors: ["Contraseña es requerida"] };
    }

    if (pwd.length < 8) {
      errors.push("La contraseña debe tener al menos 8 caracteres");
    }

    if (!/[A-Z]/.test(pwd)) {
      errors.push("La contraseña debe contener al menos una letra mayúscula");
    }

    if (!/[a-z]/.test(pwd)) {
      errors.push("La contraseña debe contener al menos una letra minúscula");
    }

    if (!/[0-9]/.test(pwd)) {
      errors.push("La contraseña debe contener al menos un número");
    }

    if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?`~]/.test(pwd)) {
      errors.push(
        "La contraseña debe contener al menos un carácter especial (!@#$%^&*()_+-=[]{}|;':,.<>?`~)",
      );
    }

    if (pwd !== confirmPwd) {
      errors.push("Las contraseñas no coinciden");
    }

    return {
      isValid: errors.length === 0,
      errors,
    };
  }

  // ============================================
  // FUNCIÓN: Sanitizar texto para prevenir XSS
  // Reutiliza lógica de validación del panel admin
  // ============================================
  function sanitizeText(input: string): string {
    if (!input) return "";
    return input
      .replace(/<[^>]*>/g, "")           // Elimina tags HTML
      .replace(/&/g, "&amp;")            // Escapa &
      .replace(/</g, "&lt;")             // Escapa <
      .replace(/>/g, "&gt;")             // Escapa >
      .replace(/"/g, "&quot;")           // Escapa "
      .replace(/'/g, "&#x27;")           // Escapa '
      .replace(/[\x00-\x1F\x7F]/g, "")   // Elimina caracteres de control
      .trim();
  }

  // ============================================
  // PATRONES DE DETECCIÓN XSS
  // Detecta inyección de scripts y HTML peligroso
  // ============================================
  const XSS_PATTERNS = {
    SCRIPT_INJECTION: /<script[\s\S]*?>[\s\S]*?<\/script>|javascript:|on\w+\s*=/gi,
    HTML_INJECTION: /<[^>]*(iframe|object|embed|form|input|button|meta|link|style)[^>]*>/gi,
    EVENT_HANDLERS: /\bon\w+\s*=\s*["']?[^"']*["']?/gi
  };

  // ============================================
  // FUNCIÓN: Detectar contenido XSS en texto
  // @param input - Texto a verificar
  // @returns true si se detecta contenido malicioso
  // ============================================
  function containsXSS(input: string): boolean {
    if (!input) return false;
    const lowerInput = input.toLowerCase();
    return XSS_PATTERNS.SCRIPT_INJECTION.test(lowerInput) || 
           XSS_PATTERNS.HTML_INJECTION.test(lowerInput) ||
           XSS_PATTERNS.EVENT_HANDLERS.test(lowerInput) ||
           lowerInput.includes('<script') ||
           lowerInput.includes('javascript:') ||
           lowerInput.includes('onerror=') ||
           lowerInput.includes('onclick=') ||
           lowerInput.includes('onload=');
  }

  // ============================================
  // FUNCIÓN: Validar campo de texto contra XSS
  // @param value - Valor del campo
  // @param fieldName - Nombre del campo para mensaje de error
  // @returns Objeto con resultado de validación
  // ============================================
  function validateTextFieldXSS(
    value: string, 
    fieldName: string
  ): { isValid: boolean; error?: string } {
    if (containsXSS(value)) {
      return { 
        isValid: false, 
        error: `Error de Seguridad: Se han detectado caracteres no permitidos en el campo "${fieldName}". Por favor usa solo texto normal.`
      };
    }
    return { isValid: true };
  }

  // Form Submit
  const submitBtn = form?.querySelector("button[type='submit']") as HTMLButtonElement | null;
  const originalBtnContent = submitBtn?.innerHTML;
  
  form?.addEventListener("submit", async (e: Event) => {
    e.preventDefault();
    clearFieldErrors();

    // ============================================
    // FUNCIÓN HELPER: Mostrar/ocultar estado de carga
    // ============================================
    const setLoadingState = (loading: boolean) => {
      if (!submitBtn) return;
      if (loading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Creando cuenta...</span>
        `;
      } else {
        submitBtn.disabled = false;
        if (originalBtnContent) submitBtn.innerHTML = originalBtnContent;
      }
    };

    // Null checks for required elements
    if (
      !password ||
      !confirmPassword ||
      !rutInput ||
      !phoneInput ||
      !regionSelect ||
      !comunaSelect
    ) {
      showToast(
        "Error: No se pudieron encontrar todos los campos del formulario.",
        "danger",
      );
      return;
    }

    // Get form values with proper typing
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const firstNameInput = document.getElementById(
      "firstName",
    ) as HTMLInputElement;
    const lastNamePaternoInput = document.getElementById(
      "lastNamePaterno",
    ) as HTMLInputElement;
    const lastNameMaternoInput = document.getElementById(
      "lastNameMaterno",
    ) as HTMLInputElement;
    const addressInput = document.getElementById("address") as HTMLInputElement;
    const apartmentInput = document.getElementById(
      "apartment",
    ) as HTMLInputElement;

    // Collect all validation errors
    const allErrors: string[] = [];

    // Required fields validation
    const requiredFields = [
      { element: firstNameInput, name: "Nombre" },
      { element: lastNamePaternoInput, name: "Apellido Paterno" },
      { element: lastNameMaternoInput, name: "Apellido Materno" },
      { element: rutInput, name: "RUT" },
      { element: emailInput, name: "Correo Electrónico" },
      { element: phoneInput, name: "Teléfono" },
      { element: addressInput, name: "Calle y Número" },
      { element: regionSelect, name: "Región" },
      { element: comunaSelect, name: "Comuna" },
      { element: password, name: "Contraseña" },
      { element: confirmPassword, name: "Confirmar Contraseña" },
    ];

    requiredFields.forEach((field) => {
      if (!field.element?.value?.trim()) {
        allErrors.push(`El campo "${field.name}" es obligatorio.`);
      }
    });

    // Validate terms checkbox
    const termsCheckbox = document.getElementById("terms") as HTMLInputElement;
    if (!termsCheckbox?.checked) {
      allErrors.push(
        "Debes aceptar los Términos y Condiciones para registrarte.",
      );
    }

    // If there are empty required fields, show errors and stop
    if (allErrors.length > 0) {
      showValidationErrors(allErrors);
      return;
    }

    // Password Validation
    const passwordValidation = validatePassword(
      password.value,
      confirmPassword.value,
    );
    if (!passwordValidation.isValid) {
      allErrors.push(...passwordValidation.errors);
    }

    // Clean RUT for validation (remove dots)
    const cleanRut = rutInput.value.replace(/\./g, "");
    if (!validateRUT(cleanRut)) {
      allErrors.push(
        "RUT inválido. Por favor verifique el formato (ej: 12.345.678-9).",
      );
    }

    if (!validatePhone(phoneInput.value)) {
      allErrors.push(
        "Teléfono inválido. Use formato chileno (ej: +56912345678).",
      );
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailInput.value)) {
      allErrors.push("Correo electrónico inválido. Verifique el formato.");
    }

    // If there are validation errors, show them all at once
    if (allErrors.length > 0) {
      showValidationErrors(allErrors);
      return;
    }

    // ============================================
    // VALIDACIÓN XSS - ANTES DE CUALQUIER OPERACIÓN FIREBASE
    // Esto previene crear usuarios "zombies" en Auth
    // ============================================
    const textFieldsToValidate = [
      { value: firstNameInput.value, name: "Nombre" },
      { value: lastNamePaternoInput.value, name: "Apellido Paterno" },
      { value: lastNameMaternoInput.value, name: "Apellido Materno" },
      { value: addressInput.value, name: "Dirección" },
      { value: apartmentInput.value, name: "Departamento/Oficina" },
    ];

    const xssErrors: string[] = [];
    for (const field of textFieldsToValidate) {
      if (field.value) {
        const xssValidation = validateTextFieldXSS(field.value, field.name);
        if (!xssValidation.isValid && xssValidation.error) {
          xssErrors.push(xssValidation.error);
        }
      }
    }

    // Si hay errores de XSS, detener ANTES de crear usuario en Auth
    if (xssErrors.length > 0) {
      showValidationErrors([
        "Error en Formulario de Registro: Se han detectado caracteres no permitidos.",
        ...xssErrors
      ]);
      return;
    }

    // ============================================
    // VERIFICAR RUT DUPLICADO EN BASE DE DATOS
    // Activar estado de carga para operaciones asíncronas
    // ============================================
    setLoadingState(true);
    
    try {
      const rutExists = await checkRutExists(rutInput.value);
      if (rutExists) {
        setLoadingState(false);
        showValidationErrors([
          "El RUT ingresado ya está registrado en el sistema. Si ya tienes una cuenta, inicia sesión.",
        ]);
        return;
      }
    } catch (error) {
      console.error("Error verificando RUT:", error);
      setLoadingState(false);
      showToast(
        "Error al verificar disponibilidad del RUT. Intente nuevamente.",
        "danger",
      );
      return;
    }

    // ============================================
    // CREAR USUARIO EN FIREBASE
    // Orden: Auth -> Profile -> Firestore
    // IMPORTANTE: Si CUALQUIER paso falla después de crear Auth,
    // se ejecuta rollback para eliminar el usuario zombie
    // ============================================
    let createdUser: import("firebase/auth").User | null = null;
    
    try {
      // Paso 1: Crear usuario en Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        emailInput.value,
        password.value,
      );
      createdUser = userCredential.user;

      // Paso 2: Actualizar perfil (displayName)
      await updateProfile(createdUser, {
        displayName: `${sanitizeText(firstNameInput.value)} ${sanitizeText(lastNamePaternoInput.value)}`,
      });

      // Paso 3: Guardar datos sanitizados en Firestore
      await setDoc(doc(db, "users", createdUser.uid), {
        firstName: sanitizeText(firstNameInput.value),
        lastNamePaterno: sanitizeText(lastNamePaternoInput.value),
        lastNameMaterno: sanitizeText(lastNameMaternoInput.value),
        rut: rutInput.value,
        email: emailInput.value,
        phone: phoneInput.value,
        address: sanitizeText(addressInput.value),
        region: regionSelect.value,
        comuna: comunaSelect.value,
        apartment: sanitizeText(apartmentInput.value),
        createdAt: new Date(),
        role: "user",
      });

      // ¡Éxito! Todos los pasos completados
      showToast(
        "¡Registro exitoso! Bienvenido a GMEXPRESS. Redirigiendo...",
        "success",
      );
      setTimeout(() => {
        window.location.href = "/";
      }, 2000);
    } catch (error) {
      console.error("Error en registro:", error);
      
      // ============================================
      // ROLLBACK: Si el usuario fue creado en Auth pero algo falló después,
      // eliminarlo para no dejar usuarios zombies
      // ============================================
      if (createdUser) {
        console.log("Ejecutando rollback: eliminando usuario de Auth...");
        try {
          await createdUser.delete();
          console.log("Rollback exitoso: usuario eliminado de Auth");
        } catch (deleteError) {
          console.error("Error en rollback (no se pudo eliminar usuario de Auth):", deleteError);
          // Si el rollback falla, registrar para limpieza manual
        }
      }
      
      // Mostrar mensaje de error apropiado
      const err = error as Error & { code?: string };
      let msg = "Error al registrar usuario. Por favor intente nuevamente.";
      
      if (err.code === "auth/email-already-in-use") {
        msg = "Error en Registro: El correo electrónico ya está registrado.";
      } else if (err.code === "auth/weak-password") {
        msg = "Error en Registro: La contraseña es muy débil.";
      } else if (err.code === "auth/invalid-email") {
        msg = "Error en Registro: El formato del correo electrónico no es válido.";
      } else if (err.message && !err.code) {
        // Error de Firestore u otro error personalizado
        msg = `Error en Registro: ${err.message}`;
      }
      
      setLoadingState(false);
      showToast(msg, "danger");
    }
  });
</script>
